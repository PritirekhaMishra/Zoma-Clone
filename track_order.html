<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZomaClone | Track Order</title>

<style>
    body{margin:0;font-family:Poppins,sans-serif;background:#fafafa}
    .container{max-width:900px;margin:20px auto;padding:20px}
    .heading{text-align:center;font-size:26px;font-weight:700;color:#e23744;margin-bottom:20px}

    .order-card{
        background:#fff;
        border-radius:12px;
        padding:16px;
        margin-bottom:16px;
        box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }

    .status{
        padding:6px 12px;
        border-radius:6px;
        font-size:13px;
        color:#fff;
        font-weight:600;
    }

    .pending{background:#f59e0b}
    .preparing{background:#3b82f6}
    .out_for_delivery{background:#9333ea}
    .delivered{background:#16a34a}
    .cancelled{background:#ef4444}

    .refresh-btn{
        width:100%;
        background:#1674ff;
        padding:10px;
        border:none;
        border-radius:8px;
        color:#fff;
        font-size:15px;
        cursor:pointer;
        margin-top:10px;
    }

    .empty{text-align:center;padding:20px;color:#666}
</style>
</head>

<body>

<div class="container">
    <div class="heading">Your Orders</div>
    <div id="ordersBox"></div>
    <button class="refresh-btn" onclick="loadOrders()">Refresh</button>
</div>

<script>
const API = "http://127.0.0.1:5000";

// Get phone from URL
function getPhone() {
    const params = new URLSearchParams(window.location.search);
    return params.get("phone");
}

function formatOrderTime(utcString) {
    if (!utcString) return "N/A";

    // Force UTC → Local (IST automatically)
    const date = new Date(utcString + " UTC");

    return date.toLocaleString("en-IN", {
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
    });
}


// Load all orders
async function loadOrders() {
    const phone = getPhone();

    if (!phone) {
        document.getElementById("ordersBox").innerHTML =
            `<div class="empty">Phone number missing.<br>Try: track_order.html?phone=9876543210</div>`;
        return;
    }

    try {
        const res = await fetch(`${API}/api/orders/user/${phone}`);
        const data = await res.json();

        if (!data.success || !data.orders || !data.orders.length) {
            document.getElementById("ordersBox").innerHTML =
                `<div class="empty">No orders found.</div>`;
            return;
        }

        let html = "";

        data.orders.forEach(o => {

            const items = Array.isArray(o.items)
                ? o.items.map(i => `${i.name} × ${i.qty}`).join(", ")
                : "Items unavailable";

            const statusClass = o.status
                ? o.status.replaceAll(" ", "_").toLowerCase()
                : "pending";

            html += `
                <div class="order-card">
                    <h3>${o.restaurant_name} 
                        <span style="font-size:13px;color:#888">#${o.id}</span>
                    </h3>

                    <p><b>Total:</b> ₹${o.total}</p>
                    <p><b>Items:</b> ${items}</p>

                    <p><b>Status:</b> 
                        <span class="status ${statusClass}">${o.status}</span>
                    </p>

                    <p><b>Payment:</b> ${o.payment_method}</p>
                    <p><b>Ordered At:</b> ${formatOrderTime(o.created_at)}</p>

                </div>
            `;
        });

        document.getElementById("ordersBox").innerHTML = html;

    } catch (err) {
        console.error(err);
        document.getElementById("ordersBox").innerHTML =
            `<div class="empty">Error loading orders.</div>`;
    }
}

loadOrders();
</script>

</body>
</html>
