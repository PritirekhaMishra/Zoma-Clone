<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZomaClone | Vendor Panel</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
    }

    body {
      background: #f5f5f5;
      display: flex;
      color: #222;
    }

    /* ============= SIDEBAR ============= */
    .sidebar {
      width: 260px;
      background: #d42a2a;
      color: #fff;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      padding: 20px 15px;
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .sidebar-header h2 {
      font-weight: 600;
    }

    .sidebar-header small {
      font-size: 12px;
      opacity: 0.9;
    }

    .menu-item {
      padding: 12px 15px;
      margin-bottom: 5px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: 0.25s;
    }

    .menu-item:hover,
    .menu-item.active {
      background: rgba(255, 255, 255, 0.15);
    }

    .menu-item span.icon {
      font-size: 16px;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 12px;
      opacity: 0.8;
      text-align: center;
    }

    /* ============= MAIN AREA ============= */
    .main {
      margin-left: 260px;
      padding: 20px;
      width: calc(100% - 260px);
      min-height: 100vh;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .top-bar h1 {
      font-size: 22px;
      font-weight: 600;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #fee2e2;
      color: #991b1b;
    }

    .sections {
      margin-top: 10px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 18px 18px 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
      margin-bottom: 20px;
    }

    h2.section-title {
      font-size: 18px;
      margin-bottom: 12px;
      font-weight: 600;
      color: #1f2933;
    }

    .grid {
      display: grid;
      grid-gap: 16px;
    }

    .grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .stat-card {
      background: #fff7f7;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid #fee2e2;
    }

    .stat-label {
      font-size: 12px;
      color: #7b8794;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      margin-top: 4px;
    }

    .stat-sub {
      font-size: 11px;
      color: #9b1c1c;
    }

    label {
      font-size: 13px;
      display: block;
      margin-top: 10px;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid #d0d7e2;
      margin-top: 5px;
      font-size: 13px;
      outline: none;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: #d42a2a;
      box-shadow: 0 0 0 1px rgba(212, 42, 42, 0.08);
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    button {
      border: none;
      padding: 9px 14px;
      border-radius: 999px;
      background: #d42a2a;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s;
    }

    button:hover {
      background: #b91c1c;
    }

    button.secondary {
      background: #f3f4f6;
      color: #1f2933;
    }

    button.secondary:hover {
      background: #e5e7eb;
    }

    .tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f3f4f6;
      margin-right: 6px;
    }

    .tag.status {
      background: #fee2e2;
      color: #991b1b;
    }

    .banner-img {
      margin-top: 8px;
      border-radius: 10px;
      width: 260px;
      max-width: 100%;
      border: 1px solid #e5e7eb;
    }

    .restaurant-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
    }

    .restaurant-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .restaurant-title {
      font-weight: 600;
      font-size: 15px;
    }

    .small-text {
      font-size: 12px;
      color: #6b7280;
    }

    .order-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      background: #fff;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .order-items {
      font-size: 12px;
      margin: 6px 0;
    }

    .order-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f3f4f6;
      margin-right: 4px;
      margin-top: 2px;
      display: inline-block;
    }

    /* OFFERS UI */
    .offers-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr)) auto;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .offers-row input {
      margin-top: 0;
    }

    .offers-row button.remove-offer {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      margin-top: 0;
    }

    .offers-help {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        width: 220px;
      }
      .main {
        margin-left: 220px;
        width: calc(100% - 220px);
      }
    }

    @media (max-width: 700px) {
      .sidebar {
        display: none;
      }
      .main {
        margin-left: 0;
        width: 100%;
      }
    }
  </style>
</head>

<body onload="initVendorPage()">

  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>ZomaClone</h2>
      <small>Vendor Control Panel</small>
    </div>

    <div class="menu-item active" onclick="openSection('dashboard-section', this)">
      <span class="icon">üìä</span> Dashboard
    </div>
    <div class="menu-item" onclick="openSection('profile-section', this)">
      <span class="icon">üë§</span> Profile & UPI
    </div>
    <div class="menu-item" onclick="openSection('restaurants-section', this)">
      <span class="icon">üçΩÔ∏è</span> Restaurants
    </div>
    <div class="menu-item" onclick="openSection('menu-section', this)">
      <span class="icon">üìã</span> Menu
    </div>
    <div class="menu-item" onclick="openSection('qr-section', this)">
      <span class="icon">üì±</span> QR Orders
    </div>
    <div class="menu-item" onclick="openSection('delivery-section', this)">
      <span class="icon">üöö</span> Delivery Orders
    </div>

    <div class="sidebar-footer">
      Logged in as <br />
      <span id="sidebar-vendor-name">Vendor</span>
    </div>
  </aside>

  <!-- ================= MAIN ================= -->
  <main class="main">
    <div class="top-bar">
      <h1>Vendor Dashboard</h1>
      <span class="badge">Red Theme ¬∑ Live Backend</span>
    </div>

    <div class="sections">

      <!-- ===== DASHBOARD / ANALYTICS ===== -->
      <section id="dashboard-section" class="section active">
        <div class="card">
          <h2 class="section-title">Overview</h2>
          <div class="grid grid-4">
            <div class="stat-card">
              <div class="stat-label">Total Orders</div>
              <div class="stat-value" id="stat-total-orders">0</div>
              <div class="stat-sub">QR + Delivery</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Pending Orders</div>
              <div class="stat-value" id="stat-pending-orders">0</div>
              <div class="stat-sub">Need your attention</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Earnings (‚Çπ)</div>
              <div class="stat-value" id="stat-total-earnings">0</div>
              <div class="stat-sub">Since beginning</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Today‚Äôs Earnings (‚Çπ)</div>
              <div class="stat-value" id="stat-today-earnings">0</div>
              <div class="stat-sub">Based on order timestamps</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== PROFILE / UPI ===== -->
      <section id="profile-section" class="section">
        <div class="card">
          <h2 class="section-title">Profile</h2>
          <p><strong>Restaurant Name:</strong> <span id="v_restaurant_name"></span></p>
          <p><strong>Owner:</strong> <span id="v_owner_name"></span></p>
          <p><strong>Email:</strong> <span id="v_email"></span></p>
          <p><strong>Phone:</strong> <span id="v_phone"></span></p>
          <p><strong>Address:</strong> <span id="v_address"></span></p>

          <label for="upiInput">UPI ID</label>
          <input id="upiInput" type="text" placeholder="example@upi" />
          <button onclick="saveUPI()">üíæ Save UPI</button>
        </div>
      </section>

      <!-- ===== RESTAURANTS ===== -->
      <section id="restaurants-section" class="section">
        <div class="card">
          <h2 class="section-title">Your Restaurants</h2>
          <div id="rest-list"></div>
        </div>

        <div class="card">
          <h2 class="section-title" id="rest-form-title">Add Restaurant</h2>

          <input type="hidden" id="edit_restaurant_id" />

          <label>Name</label>
          <input id="r_name" placeholder="Restaurant Name" />

          <label>Address</label>
          <input id="r_address" placeholder="Restaurant Address" />

          <label>Description</label>
          <textarea id="r_desc" placeholder="Short description"></textarea>

          <label>Delivery Charge (‚Çπ)</label>
          <input id="r_delivery" type="number" min="0" placeholder="e.g. 30" />

          <label>Packing Charge (‚Çπ)</label>
          <input id="r_packing" type="number" min="0" placeholder="e.g. 10" />

          <label style="margin-top:14px;">Automatic Offers (order total)</label>
          <div id="offers-wrapper"></div>
          <button type="button" class="secondary" onclick="addOfferRow()">‚ûï Add Offer</button>
          <div class="offers-help">
            Each offer = ‚ÄúMin amount‚Äù + ‚Äú% Off‚Äù.
            Example: Min 199 & 20% off. You can add unlimited slabs.
          </div>

          <label style="margin-top:16px;">Banner Image</label>
          <input type="file" id="r_banner" accept="image/*" />

          <button onclick="saveRestaurant()">‚úÖ Save Restaurant</button>
          <button class="secondary" onclick="resetRestaurantForm()">Reset</button>
        </div>
      </section>

      <!-- ===== MENU ===== -->
      <section id="menu-section" class="section">
        <div class="card">
          <h2 class="section-title">Menu Management</h2>

          <label>Select Restaurant</label>
          <select id="menu_restaurant_select" onchange="loadMenuItemsForSelected()">
            <option value="">-- Select --</option>
          </select>
        </div>

        <div class="card">
          <h2 class="section-title">Menu Items</h2>
          <div id="menu-items-list"></div>
        </div>

        <div class="card">
          <h2 class="section-title">Add New Item</h2>

          <label>Name</label>
          <input id="mi_name" placeholder="Dish name" />

          <label>Description</label>
          <textarea id="mi_desc" placeholder="Short description"></textarea>

          <label>Price (‚Çπ)</label>
          <input id="mi_price" type="number" min="1" />

          <label>Category</label>
          <input id="mi_category" placeholder="Indian, Chinese, Snacks..." />

          <label>Food Type</label>
          <select id="mi_food_type">
            <option value="">Not set</option>
            <option value="Veg">Veg</option>
            <option value="Non-Veg">Non-Veg</option>
          </select>

          <label>Image (optional)</label>
          <input id="mi_image_file" type="file" accept="image/*" />
          <div class="offers-help">Or paste an existing image URL below:</div>
          <input id="mi_image_url" placeholder="/uploads/..." />

          <button onclick="addMenuItem()">‚ûï Add Item</button>
        </div>
      </section>

      <!-- ===== QR ORDERS ===== -->
      <section id="qr-section" class="section">
        <div class="card">
          <h2 class="section-title">QR Orders</h2>
          <div id="qr-orders-list"></div>
        </div>
      </section>

      <!-- ===== DELIVERY ORDERS ===== -->
      <section id="delivery-section" class="section">
        <div class="card">
          <h2 class="section-title">Delivery Orders</h2>
          <div id="delivery-orders-list"></div>
        </div>
      </section>

    </div>
  </main>

  <script>
    const API = "http://127.0.0.1:5000";

    let VENDOR_ID = null;
    let RESTAURANTS = [];
    let QR_ORDERS = [];
    let DELIVERY_ORDERS = [];

    /* ============ NAVIGATION ============ */
    function openSection(id, el) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      const sec = document.getElementById(id);
      if (sec) sec.classList.add("active");

      document.querySelectorAll(".sidebar .menu-item").forEach(m => m.classList.remove("active"));
      if (el) el.classList.add("active");
    }

    /* ============ INIT ============ */
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function initVendorPage() {
      VENDOR_ID = getQueryParam("vendor_id");

      if (!VENDOR_ID) {
        alert("Missing vendor_id in URL.");
        return;
      }

      // Ensure offers section has at least one row
      resetRestaurantForm();

      await Promise.all([
        loadVendor(),
        loadRestaurants(),
        loadQROrders(),
        loadDeliveryOrders(),
      ]);

      computeAnalytics();
    }

    /* ============ FILE ‚Üí BASE64 helper ============ */
    function fileToBase64WithoutPrefix(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result || "";
          const base64 = String(result).replace(/^data:.*;base64,/, "");
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /* ============ VENDOR PROFILE ============ */
    async function loadVendor() {
      try {
        const res = await fetch(`${API}/api/vendors/${VENDOR_ID}`);
        const data = await res.json();
        if (!data.success) {
          console.log("Vendor fetch failed", data);
          return;
        }
        const v = data.vendor;
        document.getElementById("v_restaurant_name").innerText = v.restaurant_name || "";
        document.getElementById("v_owner_name").innerText = v.owner_name || "";
        document.getElementById("v_email").innerText = v.email || "";
        document.getElementById("v_phone").innerText = v.phone || "";
        document.getElementById("v_address").innerText = v.address || "";
        document.getElementById("upiInput").value = v.upi_id || "";
        document.getElementById("sidebar-vendor-name").innerText = v.owner_name || "Vendor";
      } catch (err) {
        console.error("loadVendor error", err);
      }
    }

    async function saveUPI() {
      const upi_id = document.getElementById("upiInput").value.trim();
      try {
        const res = await fetch(`${API}/api/vendors/${VENDOR_ID}/upi`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ upi_id }),
        });
        const data = await res.json();
        if (data.success) {
          alert("UPI updated successfully");
        } else {
          alert(data.message || "Failed to update UPI");
        }
      } catch (err) {
        console.error("saveUPI error", err);
        alert("Error updating UPI");
      }
    }

    /* ============ OFFERS UI HELPERS ============ */

    function addOfferRow(prefill) {
      const container = document.getElementById("offers-wrapper");
      const row = document.createElement("div");
      row.className = "offers-row";

      row.innerHTML = `
        <input type="number" min="0" placeholder="Min amount e.g. 199" class="offer-min" />
        <input type="number" min="0" max="100" placeholder="% Off e.g. 20" class="offer-percent" />
        <button type="button" class="secondary remove-offer" onclick="removeOfferRow(this)">‚úï</button>
      `;

      container.appendChild(row);

      if (prefill) {
        const minInput = row.querySelector(".offer-min");
        const percentInput = row.querySelector(".offer-percent");
        minInput.value = prefill.min_amount || prefill.min || "";
        percentInput.value = prefill.percent || prefill.off || "";
      }
    }

    function removeOfferRow(btn) {
      const row = btn.closest(".offers-row");
      if (!row) return;
      const container = document.getElementById("offers-wrapper");
      container.removeChild(row);

      // Always keep at least one row
      if (container.querySelectorAll(".offers-row").length === 0) {
        addOfferRow();
      }
    }

    function collectOffersFromForm() {
      const rows = document.querySelectorAll("#offers-wrapper .offers-row");
      const offers = [];
      rows.forEach(row => {
        const minVal = parseInt(row.querySelector(".offer-min").value || "0");
        const pctVal = parseInt(row.querySelector(".offer-percent").value || "0");
        if (minVal > 0 && pctVal > 0) {
          offers.push({ min_amount: minVal, percent: pctVal });
        }
      });
      return offers;
    }

    function setOffersForm(offers) {
      const container = document.getElementById("offers-wrapper");
      container.innerHTML = "";
      if (!offers || offers.length === 0) {
        addOfferRow();
        return;
      }
      offers.forEach(o => addOfferRow(o));
    }

    /* ============ RESTAURANTS ============ */
    async function loadRestaurants() {
      try {
        const res = await fetch(`${API}/api/vendor/restaurants/${VENDOR_ID}`);
        RESTAURANTS = await res.json();

        const listEl = document.getElementById("rest-list");
        listEl.innerHTML = "";
        if (!Array.isArray(RESTAURANTS) || RESTAURANTS.length === 0) {
          listEl.innerHTML = "<p class='small-text'>No restaurants created yet.</p>";
        } else {
          RESTAURANTS.forEach(r => {
            const div = document.createElement("div");
            div.className = "restaurant-card";
            const offersText = (r.offers && r.offers.length)
              ? r.offers.map(o => `‚Çπ${o.min_amount}+ ‚Üí ${o.percent}% off`).join(" ¬∑ ")
              : "No automatic offers";
            div.innerHTML = `
              <div class="restaurant-header">
                <div>
                  <div class="restaurant-title">${r.name}</div>
                  <div class="small-text">${r.address}</div>
                  <div class="small-text">${r.description || ""}</div>
                  <div class="small-text">
                    Delivery: ‚Çπ${r.delivery_charge || 0} ¬∑ Packing: ‚Çπ${r.packing_charge || 0}
                  </div>
                  <div class="small-text">${offersText}</div>
                </div>
                <div>
                  <button class="secondary" onclick="editRestaurant(${r.id})">Edit</button>
                </div>
              </div>
              ${r.banner_image ? `<img src="${r.banner_image}" class="banner-img" alt="Banner" />` : ""}
            `;
            listEl.appendChild(div);
          });
        }

        // Also populate dropdown for menu section
        const sel = document.getElementById("menu_restaurant_select");
        sel.innerHTML = `<option value="">-- Select --</option>`;
        RESTAURANTS.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = r.name;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error("loadRestaurants error", err);
      }
    }

    function resetRestaurantForm() {
      document.getElementById("edit_restaurant_id").value = "";
      document.getElementById("r_name").value = "";
      document.getElementById("r_address").value = "";
      document.getElementById("r_desc").value = "";
      document.getElementById("r_delivery").value = "";
      document.getElementById("r_packing").value = "";
      document.getElementById("r_banner").value = "";
      document.getElementById("rest-form-title").innerText = "Add Restaurant";
      setOffersForm([]);
    }

    function editRestaurant(id) {
      const r = RESTAURANTS.find(x => x.id === id);
      if (!r) return;
      document.getElementById("edit_restaurant_id").value = r.id;
      document.getElementById("r_name").value = r.name || "";
      document.getElementById("r_address").value = r.address || "";
      document.getElementById("r_desc").value = r.description || "";
      document.getElementById("r_delivery").value = r.delivery_charge || 0;
      document.getElementById("r_packing").value = r.packing_charge || 0;
      setOffersForm(r.offers || []);
      document.getElementById("rest-form-title").innerText = "Edit Restaurant";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function saveRestaurant() {
      const restId = document.getElementById("edit_restaurant_id").value || null;
      const name = document.getElementById("r_name").value.trim();
      const address = document.getElementById("r_address").value.trim();
      const description = document.getElementById("r_desc").value.trim();
      const file = document.getElementById("r_banner").files[0];

      if (!name || !address) {
        alert("Name and address are required");
        return;
      }

      let banner_base64 = null;
      if (file) {
        banner_base64 = await fileToBase64WithoutPrefix(file);
      }

      const delivery_charge = parseInt(document.getElementById("r_delivery").value || "0");
      const packing_charge = parseInt(document.getElementById("r_packing").value || "0");
      const offers = collectOffersFromForm();

      const payload = {
        vendor_id: VENDOR_ID,
        name,
        address,
        description,
        is_nightlife: false,
        delivery_charge,
        packing_charge,
        offers
      };
      if (restId) payload.restaurant_id = restId;
      if (banner_base64) payload.banner_image = banner_base64;

      try {
        const res = await fetch(`${API}/api/vendor/restaurants`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.success) {
          alert(restId ? "Restaurant updated" : "Restaurant created");
          resetRestaurantForm();
          loadRestaurants();
        } else {
          alert(data.message || "Error saving restaurant");
        }
      } catch (err) {
        console.error("saveRestaurant error", err);
        alert("Error saving restaurant");
      }
    }

    /* ============ MENU ============ */
    async function loadMenuItemsForSelected() {
      const sel = document.getElementById("menu_restaurant_select");
      const restId = sel.value;
      const listEl = document.getElementById("menu-items-list");
      listEl.innerHTML = "";

      if (!restId) {
        listEl.innerHTML = "<p class='small-text'>Select a restaurant to view menu.</p>";
        return;
      }

      try {
        const res = await fetch(`${API}/api/vendor/restaurants/${restId}/menu`);
        const items = await res.json();

        if (!Array.isArray(items) || items.length === 0) {
          listEl.innerHTML = "<p class='small-text'>No items yet.</p>";
          return;
        }

        items.forEach(i => {
          const div = document.createElement("div");
          div.className = "order-card";
          div.innerHTML = `
            <div class="order-header">
              <div>
                <strong>${i.name}</strong>
                <div class="small-text">${i.category || ""} ¬∑ ${i.food_type || ""}</div>
              </div>
              <div>‚Çπ${i.price}</div>
            </div>
            <div class="small-text">${i.description || ""}</div>
            <div class="small-text">
              ${i.available ? "<span class='tag status'>Available</span>" : "<span class='tag'>Not Available</span>"}
              ${i.image_url ? `<span class="tag">Image set</span>` : ""}
              ${i.offer_percent && i.offer_percent > 0 ? `<span class="tag">${i.offer_percent}% off</span>` : ""}
            </div>
            <div class="order-actions">
              <button class="secondary" onclick="toggleItemAvailability(${i.id}, ${i.available ? "false" : "true"})">
                ${i.available ? "Mark Unavailable" : "Mark Available"}
              </button>
              <button class="secondary" onclick="editMenuItem(${i.id})">Edit</button>
              <button onclick="deleteMenuItem(${i.id})">Delete</button>
            </div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        console.error("loadMenuItemsForSelected error", err);
      }
    }

    async function addMenuItem() {
      const restId = document.getElementById("menu_restaurant_select").value;
      if (!restId) {
        alert("Select a restaurant first");
        return;
      }

      const name = document.getElementById("mi_name").value.trim();
      const description = document.getElementById("mi_desc").value.trim();
      const price = document.getElementById("mi_price").value;
      const category = document.getElementById("mi_category").value.trim();
      const food_type = document.getElementById("mi_food_type").value;
      const image_url_text = document.getElementById("mi_image_url").value.trim();
      const image_file = document.getElementById("mi_image_file").files[0];

      if (!name || !price) {
        alert("Name and price are required");
        return;
      }

      let final_image_url = image_url_text || "";
      if (image_file) {
        const b64 = await fileToBase64WithoutPrefix(image_file);
        final_image_url = `data:image/jpeg;base64,${b64}`;
      }

      try {
        const res = await fetch(`${API}/api/vendor/restaurants/${restId}/menu-item`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            description,
            price: parseInt(price),
            category,
            food_type,
            available: true,
            image_url: final_image_url,
          }),
        });
        const data = await res.json();
        if (data.success) {
          alert("Item added");
          document.getElementById("mi_name").value = "";
          document.getElementById("mi_desc").value = "";
          document.getElementById("mi_price").value = "";
          document.getElementById("mi_category").value = "";
          document.getElementById("mi_food_type").value = "";
          document.getElementById("mi_image_url").value = "";
          document.getElementById("mi_image_file").value = "";
          loadMenuItemsForSelected();
        } else {
          alert(data.message || "Failed to add item");
        }
      } catch (err) {
        console.error("addMenuItem error", err);
        alert("Error adding item");
      }
    }

    async function toggleItemAvailability(itemId, newVal) {
      try {
        const res = await fetch(`${API}/api/vendor/menu-item/${itemId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ available: newVal }),
        });
        const data = await res.json();
        if (data.success) {
          loadMenuItemsForSelected();
        } else {
          alert(data.message || "Failed to update item");
        }
      } catch (err) {
        console.error("toggleItemAvailability error", err);
      }
    }

    async function editMenuItem(itemId) {
      const newName = prompt("New name (leave empty to keep same):");
      const newPrice = prompt("New price (leave empty to keep same):");
      const newImg = prompt("New image URL (leave empty to keep same):");
      const newOffer = prompt("Offer % (0 for no offer, leave empty to keep same):");

      const payload = {};
      if (newName && newName.trim()) payload.name = newName.trim();
      if (newPrice && !isNaN(parseInt(newPrice))) payload.price = parseInt(newPrice);
      if (newImg && newImg.trim()) payload.image_url = newImg.trim();
      if (newOffer !== null && newOffer !== "") {
        const pct = parseInt(newOffer);
        if (!isNaN(pct)) payload.offer_percent = pct;
      }

      if (Object.keys(payload).length === 0) return;

      try {
        const res = await fetch(`${API}/api/vendor/menu-item/${itemId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (data.success) {
          alert("Item updated");
          loadMenuItemsForSelected();
        } else {
          alert(data.message || "Failed to update item");
        }
      } catch (err) {
        console.error("editMenuItem error", err);
      }
    }

    async function deleteMenuItem(itemId) {
      if (!confirm("Delete this item?")) return;
      try {
        const res = await fetch(`${API}/api/vendor/menu-item/${itemId}`, {
          method: "DELETE",
        });
        const data = await res.json();
        if (data.success) {
          alert("Item deleted");
          loadMenuItemsForSelected();
        } else {
          alert(data.message || "Failed to delete");
        }
      } catch (err) {
        console.error("deleteMenuItem error", err);
      }
    }

    /* ============ QR ORDERS ============ */
    async function loadQROrders() {
      try {
        const res = await fetch(`${API}/api/vendor/orders/qr/${VENDOR_ID}`);
        QR_ORDERS = await res.json();
        const listEl = document.getElementById("qr-orders-list");
        listEl.innerHTML = "";
        if (!Array.isArray(QR_ORDERS) || QR_ORDERS.length === 0) {
          listEl.innerHTML = "<p class='small-text'>No QR orders yet.</p>";
          return;
        }

        QR_ORDERS.forEach(o => {
          const div = document.createElement("div");
          div.className = "order-card";
          const itemsHtml = Array.isArray(o.items)
            ? o.items.map(i => `<span class="pill">${i.name} √ó ${i.qty}</span>`).join(" ")
            : "";
          div.innerHTML = `
            <div class="order-header">
              <div>#${o.id} ¬∑ Table ${o.table_label || "-"}</div>
              <div>‚Çπ${o.total}</div>
            </div>
            <div class="small-text">
              Status: <span class="tag status">${o.status}</span>
              ¬∑ Payment: <span class="tag">${o.payment_status}</span>
            </div>
            <div class="order-items">${itemsHtml}</div>
            <div class="order-actions">
              <button class="secondary" onclick="updateQRStatus(${o.id}, 'ACCEPTED')">Accept</button>
              <button class="secondary" onclick="updateQRStatus(${o.id}, 'PREPARING')">Preparing</button>
              <button class="secondary" onclick="updateQRStatus(${o.id}, 'READY')">Ready</button>
              <button onclick="updateQRStatus(${o.id}, 'SERVED')">Served</button>
              <button onclick="updateQRStatus(${o.id}, 'CANCELLED')">Cancel</button>
            </div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        console.error("loadQROrders error", err);
      }
    }

    async function updateQRStatus(orderId, status) {
      try {
        const res = await fetch(`${API}/api/vendor/orders/qr/${orderId}/status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status }),
        });
        const data = await res.json();
        if (data.success) {
          loadQROrders();
          computeAnalytics();
        } else {
          alert(data.message || "Failed to update");
        }
      } catch (err) {
        console.error("updateQRStatus error", err);
      }
    }

    /* ============ DELIVERY ORDERS ============ */
    async function loadDeliveryOrders() {
      try {
        const res = await fetch(`${API}/api/vendor/delivery-orders/${VENDOR_ID}`);
        DELIVERY_ORDERS = await res.json();
        const listEl = document.getElementById("delivery-orders-list");
        listEl.innerHTML = "";
        if (!Array.isArray(DELIVERY_ORDERS) || DELIVERY_ORDERS.length === 0) {
          listEl.innerHTML = "<p class='small-text'>No delivery orders yet.</p>";
          return;
        }

        DELIVERY_ORDERS.forEach(o => {
          const div = document.createElement("div");
          div.className = "order-card";
          div.innerHTML = `
            <div class="order-header">
              <div>#${o.id} ¬∑ ${o.user_name || "Customer"} (${o.user_phone || "-"})</div>
              <div>‚Çπ${o.total}</div>
            </div>
            <div class="small-text">
              Status: <span class="tag status">${o.status}</span>
              ¬∑ Payment: <span class="tag">${o.payment_status}</span>
            </div>
            <div class="order-items">
              <div class="small-text">
                ${o.address ? (o.address.line1 || "") : ""}
                ${o.address ? (o.address.city ? " ¬∑ " + o.address.city : "") : ""}
              </div>
            </div>
            <div class="order-actions">
              <button class="secondary" onclick="updateDeliveryStatus(${o.id}, 'PREPARING')">Preparing</button>
              <button class="secondary" onclick="updateDeliveryStatus(${o.id}, 'OUT_FOR_DELIVERY')">Out for Delivery</button>
              <button onclick="updateDeliveryStatus(${o.id}, 'DELIVERED')">Delivered</button>
              <button onclick="updateDeliveryStatus(${o.id}, 'CANCELLED')">Cancel</button>
            </div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        console.error("loadDeliveryOrders error", err);
      }
    }

    async function updateDeliveryStatus(orderId, status) {
      try {
        const res = await fetch(`${API}/api/vendor/delivery-orders/${orderId}/status`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status }),
        });
        const data = await res.json();
        if (data.success) {
          loadDeliveryOrders();
          computeAnalytics();
        } else {
          alert(data.message || "Failed to update");
        }
      } catch (err) {
        console.error("updateDeliveryStatus error", err);
      }
    }

    /* ============ ANALYTICS ============ */
    function computeAnalytics() {
      const all = [...QR_ORDERS, ...DELIVERY_ORDERS];

      const totalOrders = all.length;
      let pending = 0;
      let totalEarnings = 0;
      let todayEarnings = 0;

      const todayStr = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

      all.forEach(o => {
        const st = (o.status || "").toUpperCase();
        if (["PENDING", "ACCEPTED", "PREPARING", "READY", "OUT_FOR_DELIVERY"].includes(st)) {
          pending++;
        }
        const total = Number(o.total || 0);
        if (["DELIVERED", "SERVED"].includes(st)) {
          totalEarnings += total;
          if (o.created_at) {
            const d = o.created_at.slice(0, 10);
            if (d === todayStr) {
              todayEarnings += total;
            }
          }
        }
      });

      document.getElementById("stat-total-orders").innerText = totalOrders;
      document.getElementById("stat-pending-orders").innerText = pending;
      document.getElementById("stat-total-earnings").innerText = totalEarnings;
      document.getElementById("stat-today-earnings").innerText = todayEarnings;
    }
  </script>

</body>
</html>
