<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Club Details ‚Äî ZomaClone</title>
  <link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    :root{
      --accent:#ec4899;
      --accent-soft:#f9a8d4;

      --bg-dark:#020617;
      --bg-card-dark:#0b1120;
      --bg-soft-dark:#020617;
      --border-dark:#1e293b;
      --text-main-dark:#f9fafb;
      --text-muted-dark:#9ca3af;

      --bg-light:#f4f4fb;
      --bg-card-light:#ffffff;
      --bg-soft-light:#f3f4ff;
      --border-light:#e5e7eb;
      --text-main-light:#111827;
      --text-muted-light:#6b7280;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{
      background:var(--bg-dark);
      color:var(--text-main-dark);
      transition:background .25s,color .25s;
    }
    body.light{
      background:var(--bg-light);
      color:var(--text-main-light);
    }

    /* HEADER */
    .header{
      width:100%;
      padding:14px 24px;
      background:var(--bg-card-dark);
      border-bottom:1px solid var(--border-dark);
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter:blur(10px);
    }
    body.light .header{
      background:var(--bg-card-light);
      border-color:var(--border-light);
    }
    .header-left{
      display:flex;align-items:center;gap:10px;
    }
    .brand-logo{
      width:34px;height:34px;border-radius:12px;
      background:linear-gradient(135deg,#ff1769,#ff884b);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:700;font-size:18px;
    }
    .brand-text{line-height:1.1;}
    .brand-text span:first-child{font-size:12px;opacity:.8;}
    .brand-text span:last-child{font-size:16px;font-weight:600;}

    .header-actions{display:flex;gap:8px;align-items:center;}
    .header-btn{
      padding:6px 12px;border-radius:999px;
      border:1px solid var(--border-dark);
      background:transparent;
      color:inherit;font-size:12px;
      cursor:pointer;
    }
    .header-btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;font-weight:600;
    }
    body.light .header-btn{border-color:var(--border-light);}    
    .theme-btn{
      padding:6px 12px;border-radius:999px;
      border:1px solid var(--border-dark);
      background:var(--bg-soft-dark);
      color:inherit;font-size:12px;cursor:pointer;
    }
    body.light .theme-btn{
      background:var(--bg-soft-light);
      border-color:var(--border-light);
    }

    /* BANNER */
    .banner{
      width:100%;
      height:260px;
      background-size:cover;
      background-position:center;
      position:relative;
      border-bottom:1px solid var(--border-dark);
    }
    body.light .banner{border-color:var(--border-light);}    
    .banner::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(to top,rgba(0,0,0,0.85),transparent);
    }

    .content{
      max-width:1100px;
      margin:auto;
      padding:20px 20px 36px;
    }

    /* Layout: Menu + Cart */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(320px,0.9fr);
      gap:18px;
      margin-top:20px;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
    }

    /* Club Info */
    .club-title{font-size:26px;margin-top:10px;font-weight:600;}
    .club-meta{font-size:13px;margin-top:4px;color:var(--text-muted-dark);}    
    body.light .club-meta{color:var(--text-muted-light);}    
    .club-desc{margin-top:10px;font-size:14px;line-height:22px;}
    #ratingSummary{margin-top:8px;font-size:14px;color:#facc15;}

    /* Card */
    .card{
      background:var(--bg-card-dark);
      border-radius:14px;
      border:1px solid var(--border-dark);
      padding:14px;
    }
    body.light .card{
      background:var(--bg-card-light);
      border-color:var(--border-light);
    }

    /* Menu + Filters */
    .menu-header{
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;
    }
    .menu-title{font-size:18px;font-weight:600;}
    .menu-sub{font-size:12px;color:var(--text-muted-dark);}    
    body.light .menu-sub{color:var(--text-muted-light);}    

    .category-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .chip{
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--border-dark);
      font-size:11px;cursor:pointer;
      background:var(--bg-soft-dark);
      color:inherit;
    }
    .chip.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    body.light .chip{
      background:var(--bg-soft-light);
      border-color:var(--border-light);
    }

    .menu-list{
      margin-top:10px;
      display:flex;flex-direction:column;gap:10px;
      max-height:430px;overflow-y:auto;
    }
    .menu-item{
      display:flex;gap:10px;
      padding:10px;border-radius:12px;
      background:var(--bg-soft-dark);
      border:1px solid #0f172a;
    }
    body.light .menu-item{
      background:var(--bg-soft-light);
      border-color:var(--border-light);
    }
    .menu-img{
      width:72px;height:72px;border-radius:10px;
      object-fit:cover;background:#020617;
    }
    .menu-info{flex:1;}
    .menu-name{font-size:14px;font-weight:600;}
    .menu-desc{font-size:12px;margin-top:3px;color:var(--text-muted-dark);}    
    body.light .menu-desc{color:var(--text-muted-light);}    
    .menu-meta-line{font-size:11px;margin-top:3px;color:var(--text-muted-dark);}    
    body.light .menu-meta-line{color:var(--text-muted-light);}    
    .menu-price{font-size:13px;font-weight:600;color:#f97316;margin-top:4px;}

    .menu-actions{display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between;}
    .qty-box{display:flex;align-items:center;gap:4px;}
    .qty-btn{
      width:24px;height:24px;border-radius:999px;
      border:none;background:#1e293b;color:white;
      cursor:pointer;font-size:16px;line-height:20px;
    }
    .qty-value{min-width:20px;text-align:center;font-size:13px;}

    /* Cart */
    .cart-title{font-size:18px;font-weight:600;margin-bottom:4px;}
    .cart-empty{font-size:13px;margin-top:6px;color:var(--text-muted-dark);}    
    body.light .cart-empty{color:var(--text-muted-light);}    
    .cart-items{
      margin-top:8px;max-height:260px;overflow-y:auto;
      display:flex;flex-direction:column;gap:6px;
    }
    .cart-item{
      display:flex;justify-content:space-between;align-items:flex-start;gap:6px;
      padding:6px;border-radius:10px;
      background:var(--bg-soft-dark);
    }
    body.light .cart-item{background:var(--bg-soft-light);}    
    .cart-item-name{font-size:13px;font-weight:500;}
    .cart-item-meta{font-size:11px;color:var(--text-muted-dark);}    
    body.light .cart-item-meta{color:var(--text-muted-light);}    
    .cart-item-right{text-align:right;font-size:12px;}
    .cart-item-qty{font-size:11px;}

    .cart-line{display:flex;justify-content:space-between;font-size:13px;margin-top:4px;}
    .cart-total{font-size:15px;font-weight:600;margin-top:8px;}

    .coupon-row{margin-top:8px;display:flex;gap:6px;}
    .coupon-input{
      flex:1;padding:7px 10px;border-radius:8px;
      border:1px solid var(--border-dark);
      background:var(--bg-soft-dark);
      color:inherit;font-size:13px;
    }
    body.light .coupon-input{
      background:var(--bg-soft-light);
      border-color:var(--border-light);
    }
    .coupon-btn{
      padding:7px 10px;border-radius:8px;border:none;
      background:#22c55e;color:white;font-size:13px;cursor:pointer;
    }
    .coupon-msg{font-size:11px;margin-top:4px;color:#a5b4fc;}

    .addr-box{margin-top:8px;}
    .addr-box textarea{
      width:100%;min-height:60px;border-radius:8px;
      border:1px solid var(--border-dark);
      background:var(--bg-soft-dark);
      color:inherit;font-size:13px;padding:8px;
    }
    body.light .addr-box textarea{
      background:var(--bg-soft-light);
      border-color:var(--border-light);
    }

    .checkout-btn{
      width:100%;margin-top:10px;padding:9px 12px;border-radius:8px;border:none;
      font-size:14px;font-weight:600;cursor:pointer;
    }
    .cod-btn{background:#f97316;color:white;}
    .online-btn{background:#22c55e;color:white;}
    .checkout-btn:disabled{opacity:.6;cursor:not-allowed;}

    /* Rating section */
    .rating-box{margin-top:20px;}
    .rating-head{font-size:18px;margin-bottom:8px;font-weight:600;}
    .star-input{display:flex;gap:6px;font-size:24px;cursor:pointer;color:#475569;}
    .star-input .filled{color:#facc15;}
    .rating-list{margin-top:10px;font-size:13px;color:var(--text-muted-dark);}    
    body.light .rating-list{color:var(--text-muted-light);}    

    /* Toast */
    #toast{
      position:fixed;bottom:25px;right:25px;
      background:#111827;color:white;padding:10px 16px;
      border-radius:999px;font-size:13px;
      opacity:0;transform:translateY(10px);
      transition:.35s;z-index:999;
    }

    /* Auth Modal */
    .auth-overlay{
      position:fixed;inset:0;background:rgba(15,23,42,0.78);
      display:flex;align-items:center;justify-content:center;
      z-index:1000;opacity:0;pointer-events:none;transition:.25s;
    }
    .auth-overlay.show{opacity:1;pointer-events:auto;}
    .auth-box{
      width:100%;max-width:380px;
      background:var(--bg-card-dark);
      border-radius:16px;
      border:1px solid var(--border-dark);
      padding:18px;
    }
    body.light .auth-box{
      background:var(--bg-card-light);
      border-color:var(--border-light);
    }
    .auth-title{font-size:18px;font-weight:600;margin-bottom:6px;}
    .auth-tabs{display:flex;gap:8px;margin-top:8px;margin-bottom:10px;}
    .auth-tab{
      flex:1;padding:6px 10px;border-radius:999px;
      border:1px solid var(--border-dark);
      background:transparent;color:inherit;font-size:13px;
      cursor:pointer;text-align:center;
    }
    .auth-tab.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    body.light .auth-tab{border-color:var(--border-light);}    
    .auth-field{margin-top:8px;}
    .auth-field label{font-size:12px;color:var(--text-muted-dark);display:block;margin-bottom:3px;}
    body.light .auth-field label{color:var(--text-muted-light);}    
    .auth-input{
      width:100%;padding:8px 10px;border-radius:8px;
      border:1px solid var(--border-dark);
      background:var(--bg-soft-dark);
      color:inherit;font-size:13px;
    }
    body.light .auth-input{
      background:var(--bg-soft-light);
      border-color:var(--border-light);
    }
    .auth-actions{margin-top:10px;display:flex;gap:8px;}
    .auth-btn{
      flex:1;padding:8px 10px;border-radius:8px;border:none;
      cursor:pointer;font-size:13px;
    }
    .auth-btn.primary{background:#22c55e;color:white;}
    .auth-btn.secondary{background:#111827;color:#e5e7eb;}
    body.light .auth-btn.secondary{background:#e5e7eb;color:#111827;}    
    .auth-small{font-size:11px;color:var(--text-muted-dark);margin-top:6px;}
    body.light .auth-small{color:var(--text-muted-light);}    
  </style>
</head>
<body>

<div id="toast"></div>

<!-- AUTH MODAL -->
<div id="authModal" class="auth-overlay">
  <div class="auth-box">
    <div class="auth-title">Welcome to ZomaClone</div>
    <div style="font-size:12px;color:var(--text-muted-dark);">Login or sign up to place your order.</div>

    <div class="auth-tabs">
      <button id="tabLogin" class="auth-tab active" type="button">Login</button>
      <button id="tabSignup" class="auth-tab" type="button">Sign up</button>
    </div>

    <!-- LOGIN FORM -->
    <div id="loginForm">
      <div class="auth-field">
        <label>Email or Phone</label>
        <input id="loginIdentifier" class="auth-input" placeholder="you@example.com or 9876543210">
      </div>
      <div class="auth-actions">
        <button id="btnLoginSendOtp" class="auth-btn secondary" type="button">Send OTP</button>
        <button id="btnLoginClose" class="auth-btn" type="button">Cancel</button>
      </div>

      <div class="auth-field" style="margin-top:10px;">
        <label>OTP</label>
        <input id="loginOtp" class="auth-input" placeholder="4-digit OTP">
      </div>
      <div class="auth-actions">
        <button id="btnLoginVerify" class="auth-btn primary" type="button">Verify & Continue</button>
      </div>
    </div>

    <!-- SIGNUP FORM -->
    <div id="signupForm" style="display:none;">
      <div class="auth-field">
        <label>Full Name</label>
        <input id="signupName" class="auth-input" placeholder="Your name">
      </div>
      <div class="auth-field">
        <label>Email</label>
        <input id="signupEmail" class="auth-input" placeholder="you@example.com">
      </div>
      <div class="auth-field">
        <label>Phone</label>
        <input id="signupPhone" class="auth-input" placeholder="10-digit mobile">
      </div>

      <div class="auth-actions">
        <button id="btnSignupSendOtp" class="auth-btn secondary" type="button">Send OTP</button>
        <button id="btnSignupClose" class="auth-btn" type="button">Cancel</button>
      </div>

      <div class="auth-field" style="margin-top:10px;">
        <label>OTP</label>
        <input id="signupOtp" class="auth-input" placeholder="4-digit OTP">
      </div>
      <div class="auth-actions">
        <button id="btnSignupVerify" class="auth-btn primary" type="button">Verify & Create</button>
      </div>
    </div>

    <div class="auth-small">OTP uses role=<b>user</b> from your main backend.</div>
  </div>
</div>

<div class="header">
  <div class="header-left">
    <div class="brand-logo">Z</div>
    <div class="brand-text">
      <span>Nightlife</span><br>
      <span>Club Order</span>
    </div>
  </div>
  <div class="header-actions">
    <button id="btnShowOrders" class="header-btn">My Orders</button>
    <button id="themeToggle" class="theme-btn" type="button">‚òÄ Day</button>
    <button id="btnOpenAuth" class="header-btn primary">Login / Signup</button>
  </div>
</div>

<div id="banner" class="banner"></div>

<div class="content">

  <!-- Club info -->
  <h1 id="clubName" class="club-title"></h1>
  <p id="clubLocation" class="club-meta"></p>
  <p id="clubMusic" class="club-meta"></p>
  <p id="clubDesc" class="club-desc"></p>

  <div id="ratingSummary"></div>

  <!-- Layout: Menu + Cart -->
  <div class="layout">
    <!-- LEFT: MENU -->
    <div>
      <div class="card">
        <div class="menu-header">
          <div>
            <div class="menu-title">Menu</div>
            <div class="menu-sub">Tap + to add to cart</div>
          </div>
        </div>

        <div id="categoryChips" class="category-chips"></div>
        <div id="menuList" class="menu-list"></div>
      </div>

      <!-- Rating (hidden until delivered order exists) -->
      <div id="ratingCard" class="card rating-box" style="display:none;">
        <div class="rating-head">Rate this club</div>
        <div class="menu-sub" id="ratingHint" style="margin-bottom:6px;"></div>
        <div class="star-input" id="ratingStars"></div>
        <input type="text" id="reviewerName" placeholder="Your name"
          style="width:100%;margin-top:10px;padding:9px;border-radius:8px;border:1px solid var(--border-dark);background:var(--bg-soft-dark);color:inherit;font-size:13px;">
        <textarea id="reviewComment" placeholder="Write a review..."
          style="width:100%;margin-top:10px;padding:9px;border-radius:8px;border:1px solid var(--border-dark);background:var(--bg-soft-dark);color:inherit;font-size:13px;"></textarea>
        <button class="checkout-btn online-btn" type="button" onclick="submitRating()">Submit Rating</button>

        <div id="ratingList" class="rating-list"></div>
      </div>
    </div>

    <!-- RIGHT: CART -->
    <div>
      <div class="card">
        <div class="cart-title">Your Cart</div>
        <div id="cartItems" class="cart-items"></div>
        <div id="cartEmpty" class="cart-empty">No items yet. Add something from the menu.</div>

        <div class="cart-line">
          <span>Items subtotal</span>
          <span>‚Çπ<span id="cartSubtotal">0</span></span>
        </div>
        <div class="cart-line">
          <span>Platform fee</span>
          <span>‚Çπ<span id="cartPlatform">0</span></span>
        </div>
        <div class="cart-line">
          <span>Delivery charges</span>
          <span>‚Çπ<span id="cartDelivery">0</span></span>
        </div>
        <div class="cart-line">
          <span>Packing charges</span>
          <span>‚Çπ<span id="cartPacking">0</span></span>
        </div>
        <div class="cart-line">
          <span>Tax &amp; charges</span>
          <span>‚Çπ<span id="cartTax">0</span></span>
        </div>
        <div class="cart-line">
          <span>Discount</span>
          <span>- ‚Çπ<span id="cartDiscount">0</span></span>
        </div>

        <div class="cart-total">
          <span>Total to pay</span>
          <span style="float:right;">‚Çπ<span id="cartTotal">0</span></span>
        </div>

        <!-- Coupon (dropdown) -->
        <div class="coupon-row">
          <select id="couponSelect" class="coupon-input">
            <option value="">Loading coupons...</option>
          </select>
          <button id="btnApplyCoupon" class="coupon-btn" type="button">Apply</button>
        </div>
        <div id="couponMsg" class="coupon-msg"></div>

        <!-- Address -->
        <div class="addr-box">
          <label style="font-size:12px;color:var(--text-muted-dark);">Delivery address</label>
          <textarea id="deliveryAddress" placeholder="Flat / Street / Area, City"></textarea>
        </div>

        <!-- Checkout -->
        <button id="btnCod" class="checkout-btn cod-btn" type="button">Place Order (Cash on Delivery)</button>
        <button id="btnOnline" class="checkout-btn online-btn" type="button">Pay Online (Razorpay)</button>

        <div id="orderInfo" style="margin-top:6px;font-size:12px;color:#a5b4fc;"></div>
      </div>

      <!-- Simple user order list -->
      <div id="userOrdersBox" class="card" style="display:none;">
        <div style="font-size:14px;font-weight:600;margin-bottom:6px;">My Recent Orders</div>
        <div id="userOrders"></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ========= BASE URLS ========= */
const MAIN_API_URL  = "http://127.0.0.1:5000";  // main backend
const NIGHT_API_URL = "http://127.0.0.1:5001";  // nightlife_backend.py

const params  = new URLSearchParams(window.location.search);
const club_id = parseInt(params.get("club_id"));

function toast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.style.opacity=1;
  t.style.transform="translateY(0)";
  setTimeout(()=>{t.style.opacity=0;t.style.transform="translateY(10px)";},2200);
}

/* ============ THEME ============ */
const themeToggle = document.getElementById("themeToggle");
function applyThemeFromStorage(){
  const saved = localStorage.getItem("zoma_nightlife_detail_theme") || "dark";
  if(saved === "light"){
    document.body.classList.add("light");
    themeToggle.textContent = "üåô Night";
  }else{
    document.body.classList.remove("light");
    themeToggle.textContent = "‚òÄ Day";
  }
}
themeToggle.addEventListener("click", ()=>{
  const isLight = document.body.classList.toggle("light");
  localStorage.setItem("zoma_nightlife_detail_theme", isLight ? "light" : "dark");
  themeToggle.textContent = isLight ? "üåô Night" : "‚òÄ Day";
});
applyThemeFromStorage();

/* ============ STATE ============ */
let CURRENT_USER = null;
let MENU_ITEMS   = [];
let CART         = {};
let CURRENT_CATEGORY = "All";
let APPLIED_COUPON  = null;
let DISCOUNT_AMOUNT = 0;
let AVAILABLE_COUPONS = [];
let CAN_RATE = false;
let CURRENT_VENDOR_ID = null;   // from club
let CLUB_NAME = "";

/* ======== FEES (match vendor_order_online values) ======== */
/* These are now mutable and will be updated from the club/vendor data returned by the backend */
let PLATFORM_FEE_FIXED = 10;   // ‚Çπ10 default
let DELIVERY_FEE_FIXED = 25;   // ‚Çπ25 default
let PACKING_FEE_FIXED  = 5;    // ‚Çπ5 default
let TAX_PERCENT        = 5.0;  // default percent

/* ============ AUTH MODAL ============ */
const authModal = document.getElementById("authModal");
const tabLogin = document.getElementById("tabLogin");
const tabSignup = document.getElementById("tabSignup");
const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");

function openAuthModal(){authModal.classList.add("show");}
function closeAuthModal(){authModal.classList.remove("show");}

tabLogin.addEventListener("click", ()=>{
  tabLogin.classList.add("active");
  tabSignup.classList.remove("active");
  loginForm.style.display="block";
  signupForm.style.display="none";
});
tabSignup.addEventListener("click", ()=>{
  tabSignup.classList.add("active");
  tabLogin.classList.remove("active");
  loginForm.style.display="none";
  signupForm.style.display="block";
});

document.getElementById("btnOpenAuth").addEventListener("click", openAuthModal);
document.getElementById("btnLoginClose").addEventListener("click", closeAuthModal);
document.getElementById("btnSignupClose").addEventListener("click", closeAuthModal);

/* ---- LOGIN (OTP) ---- */
document.getElementById("btnLoginSendOtp").addEventListener("click", async ()=>{
  const identifier = document.getElementById("loginIdentifier").value.trim();
  if(!identifier){ toast("Enter email or phone"); return; }

  const body = {role:"user", purpose:"login"};
  if(identifier.includes("@")) body.email = identifier;
  else body.phone = identifier;

  try{
    const res = await fetch(`${MAIN_API_URL}/api/otp/send`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const data = await res.json();
    if(data.success) toast("OTP sent");
    else toast(data.message || "Failed to send OTP");
  }catch(e){
    console.error(e);
    toast("Error sending OTP");
  }
});

document.getElementById("btnLoginVerify").addEventListener("click", async ()=>{
  const identifier = document.getElementById("loginIdentifier").value.trim();
  const otp = document.getElementById("loginOtp").value.trim();
  if(!identifier || !otp){ toast("Enter identifier & OTP"); return; }

  const body = {role:"user", purpose:"login", code:otp};
  if(identifier.includes("@")) body.email = identifier;
  else body.phone = identifier;

  try{
    const verifyRes = await fetch(`${MAIN_API_URL}/api/otp/verify`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const vr = await verifyRes.json();
    if(!vr.success){ toast(vr.message || "OTP verify failed"); return; }

    const loginRes = await fetch(`${MAIN_API_URL}/api/users/login`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({identifier})
    });
    const lr = await loginRes.json();
    if(!lr.success){ toast(lr.message || "User not found. Please sign up."); return; }

    CURRENT_USER = lr.user;
    toast("Logged in as " + CURRENT_USER.name);
    closeAuthModal();
    loadUserOrders();
  }catch(e){
    console.error(e);
    toast("Error verifying OTP");
  }
});

/* ---- SIGNUP (OTP) ---- */
document.getElementById("btnSignupSendOtp").addEventListener("click", async ()=>{
  const email = document.getElementById("signupEmail").value.trim();
  const phone = document.getElementById("signupPhone").value.trim();
  if(!email && !phone){ toast("Enter email or phone"); return; }

  const body = {role:"user", purpose:"signup"};
  if(email) body.email = email;
  if(phone) body.phone = phone;

  try{
    const res = await fetch(`${MAIN_API_URL}/api/otp/send`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const data = await res.json();
    if(data.success) toast("OTP sent");
    else toast(data.message || "Failed to send OTP");
  }catch(e){
    console.error(e);
    toast("Error sending OTP");
  }
});

document.getElementById("btnSignupVerify").addEventListener("click", async ()=>{
  const name = document.getElementById("signupName").value.trim();
  const email = document.getElementById("signupEmail").value.trim();
  const phone = document.getElementById("signupPhone").value.trim();
  const otp = document.getElementById("signupOtp").value.trim();

  if(!name || (!email && !phone) || !otp){
    toast("Fill name, contact & OTP");
    return;
  }

  const body = {role:"user", purpose:"signup", code:otp};
  if(email) body.email = email;
  if(phone) body.phone = phone;

  try{
    const verifyRes = await fetch(`${MAIN_API_URL}/api/otp/verify`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const vr = await verifyRes.json();
    if(!vr.success){ toast(vr.message || "OTP verify failed"); return; }

    const regRes = await fetch(`${MAIN_API_URL}/api/users/register`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,email,phone})
    });
    const rr = await regRes.json();
    if(!rr.success){ toast(rr.message || "Signup failed"); return; }

    CURRENT_USER = rr.user;
    toast("Account created. Hi " + CURRENT_USER.name + "!");
    closeAuthModal();
    loadUserOrders();
  }catch(e){
    console.error(e);
    toast("Error during signup");
  }
});

document.getElementById("btnShowOrders").addEventListener("click", ()=>{
  if(!CURRENT_USER){
    toast("Login to see your orders");
    openAuthModal();
  }else{
    loadUserOrders();
  }
});

/* ======= AUTOFILL ADDRESS FROM LAST ORDER ======= */
const addrBox = document.getElementById("deliveryAddress");
const savedAddr = localStorage.getItem("zoma_nightlife_last_address");
if(savedAddr){
  addrBox.value = savedAddr;
}

/* ============ CLUB DETAILS ============ */
function fullImageUrl(path){
  if(!path || String(path).trim()==="") return "Images/club.webp";
  path = String(path);
  if(path.startsWith("http")) return path;
  if(path.startsWith("/")) return NIGHT_API_URL + path;
  return NIGHT_API_URL + "/" + path;
}

async function loadClub(){
  if(!club_id || Number.isNaN(club_id)){
    toast("Club id missing in URL");
    return;
  }
  try{
    const res = await fetch(`${NIGHT_API_URL}/nightlife/club/${club_id}`);
    const data = await res.json();
    if(!data.success){
      toast(data.message || "Club not found");
      return;
    }

    const c = data.club;
    CLUB_NAME = c.club_name;
    CURRENT_VENDOR_ID = c.vendor_id;

    // If backend returns vendor/admin fee settings, use them. Names may vary ‚Äî adapt to your backend.
    // Common keys: platform_fee, delivery_fee, packing_fee, tax_percent
    PLATFORM_FEE_FIXED = Number(c.platform_fee ?? c.platform_fee_fixed ?? PLATFORM_FEE_FIXED);
    DELIVERY_FEE_FIXED = Number(c.delivery_fee ?? c.delivery_fee_fixed ?? DELIVERY_FEE_FIXED);
    PACKING_FEE_FIXED  = Number(c.packing_fee ?? c.packing_fee_fixed ?? PACKING_FEE_FIXED);
    TAX_PERCENT        = Number(c.tax_percent ?? c.tax_percentage ?? TAX_PERCENT);

    document.getElementById("banner").style.backgroundImage =
      `url('${fullImageUrl(c.image || c.main_image)}')`;
    document.getElementById("clubName").innerText = c.club_name;
    document.getElementById("clubLocation").innerText = c.location ? "üìç " + c.location : "";
    document.getElementById("clubMusic").innerText = c.music ? ("üéµ Music: " + c.music) : "";
    document.getElementById("clubDesc").innerText = c.description || "";

    document.getElementById("ratingSummary").innerHTML =
      `‚≠ê ${(c.rating_avg || 0).toFixed(1)} (${c.rating_count || 0} reviews)`;

    loadRatings();
    await loadMenu();
    await loadCoupons();

    // recalc totals now that fees may be updated
    calculateTotals();
  }catch(err){
    console.error(err);
    toast("Failed to load club");
  }
}

/* ---------- RATINGS ---------- */
function loadRatings(){
  fetch(`${NIGHT_API_URL}/rating/club/${club_id}`)
    .then(res=>res.json())
    .then(r=>{
      document.getElementById("ratingSummary").innerHTML =
        `‚≠ê ${Number(r.avg || 0).toFixed(1)} (${r.count || 0} reviews)`;

      const box=document.getElementById("ratingList");
      box.innerHTML="";
      (r.items || []).forEach(x=>{
        box.innerHTML+=`
          <div style="margin-top:10px;padding:8px;background:#0b1120;border-radius:8px;">
            <b>${x.name}</b> ‚Äî ‚≠ê ${x.stars}<br>
            <span style="color:#cbd5e1;font-size:13px;">${x.comment}</span>
          </div>
        `;
      });
    });
}

let selectedStars=0;
function renderStars(){
  const box=document.getElementById("ratingStars");
  box.innerHTML="";
  for(let i=1;i<=5;i++){
    box.innerHTML+=`<span onclick="selectStar(${i})" class="${i<=selectedStars?'filled':''}">‚òÖ</span>`;
  }
}
renderStars();

function selectStar(n){
  selectedStars=n;
  renderStars();
}

function submitRating(){
  if(!CAN_RATE){
    toast("You can rate after your order is delivered.");
    return;
  }
  const name=document.getElementById("reviewerName").value;
  const comment=document.getElementById("reviewComment").value;
  if(selectedStars===0){toast("Select stars");return;}

  fetch(`${NIGHT_API_URL}/rating/add`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({club_id,stars:selectedStars,name,comment})
  })
  .then(res=>res.json())
  .then((data)=>{
    if(!data.success){
      toast(data.message || "Failed to add rating");
      return;
    }
    toast("Rating added");
    document.getElementById("reviewerName").value="";
    document.getElementById("reviewComment").value="";
    selectedStars=0;renderStars();
    loadRatings();
  })
  .catch(()=>toast("Error adding rating"));
}

/* ============ MENU + CART ============ */
async function loadMenu(){
  try{
    const res = await fetch(`${NIGHT_API_URL}/nightlife/menu/${club_id}`);
    const items = await res.json();
    MENU_ITEMS = Array.isArray(items) ? items : [];
    renderCategories();
    renderMenu();
    return MENU_ITEMS;
  }catch(err){
    console.error(err);
    toast("Failed to load menu");
    return [];
  }
}

function renderCategories(){
  const cats = new Set(["All"]);
  MENU_ITEMS.forEach(i=> cats.add(i.category || "Other"));
  const box = document.getElementById("categoryChips");
  box.innerHTML="";
  Array.from(cats).forEach(cat=>{
    const btn = document.createElement("button");
    btn.className = "chip" + (cat===CURRENT_CATEGORY ? " active" : "");
    btn.textContent = cat;
    btn.addEventListener("click", ()=>{
      CURRENT_CATEGORY = cat;
      renderCategories();
      renderMenu();
    });
    box.appendChild(btn);
  });
}

function getQty(itemId){
  return CART[itemId]?.qty || 0;
}

function renderMenu(){
  const list = document.getElementById("menuList");
  list.innerHTML="";

  let data = MENU_ITEMS;
  if(CURRENT_CATEGORY !== "All"){
    data = data.filter(i => (i.category || "Other") === CURRENT_CATEGORY);
  }
  if(data.length === 0){
    list.innerHTML = `<div style="font-size:13px;color:#9ca3af;">No items in this category.</div>`;
    return;
  }

  data.forEach(item=>{
    const img = fullImageUrl(item.image_url);
    const div = document.createElement("div");
    div.className = "menu-item";
    div.innerHTML = `
      <img src="${img}" class="menu-img" alt="">
      <div class="menu-info">
        <div class="menu-name">${item.name}</div>
        <div class="menu-desc">${item.description || ""}</div>
        <div class="menu-meta-line">${item.category || ""}</div>
        <div class="menu-price">‚Çπ${item.price}</div>
      </div>
      <div class="menu-actions">
        <div class="qty-box">
          <button class="qty-btn" data-action="minus">-</button>
          <div class="qty-value" data-role="qty">${getQty(item.id)}</div>
          <button class="qty-btn" data-action="plus">+</button>
        </div>
      </div>
    `;

    const [minusBtn, plusBtn] = div.querySelectorAll(".qty-btn");
    const qtySpan = div.querySelector("[data-role='qty']");

    minusBtn.addEventListener("click", ()=>{
      updateCart(item, -1);
      qtySpan.textContent = getQty(item.id);
    });
    plusBtn.addEventListener("click", ()=>{
      updateCart(item, +1);
      qtySpan.textContent = getQty(item.id);
    });

    list.appendChild(div);
  });
}

function updateCart(item, delta){
  const id = item.id;
  if(!CART[id]){
    CART[id] = {id:item.id, name:item.name, price:item.price, category:item.category, qty:0};
  }
  CART[id].qty += delta;
  if(CART[id].qty <= 0){
    delete CART[id];
  }
  calculateTotals();
  renderCart();
}

function calculateTotals(){
  let subtotal = 0;
  Object.values(CART).forEach(i=>{subtotal += i.price * i.qty;});

  // If cart empty, all fees zero
  let platformFee = 0;
  let deliveryFee = 0;
  let packingFee  = 0;
  let taxAmount   = 0;

  if(subtotal > 0){
    platformFee = PLATFORM_FEE_FIXED;
    deliveryFee = DELIVERY_FEE_FIXED;
    packingFee  = PACKING_FEE_FIXED;
    const taxableBase = subtotal + platformFee + deliveryFee + packingFee;
    taxAmount = taxableBase * (TAX_PERCENT / 100.0);
  }

  let discount = DISCOUNT_AMOUNT || 0;
  const grossTotal = subtotal + platformFee + deliveryFee + packingFee + taxAmount;
  if(discount > grossTotal) discount = grossTotal;

  const total = grossTotal - discount;

  document.getElementById("cartSubtotal").textContent = subtotal.toFixed(2);
  document.getElementById("cartPlatform").textContent = platformFee.toFixed(2);
  document.getElementById("cartDelivery").textContent = deliveryFee.toFixed(2);
  document.getElementById("cartPacking").textContent  = packingFee.toFixed(2);
  document.getElementById("cartTax").textContent      = taxAmount.toFixed(2);
  document.getElementById("cartDiscount").textContent = discount.toFixed(2);
  document.getElementById("cartTotal").textContent    = total.toFixed(2);
}

function renderCart(){
  const box = document.getElementById("cartItems");
  const emptyEl = document.getElementById("cartEmpty");
  box.innerHTML="";

  const items = Object.values(CART);
  if(items.length === 0){
    emptyEl.style.display="block";
  }else{
    emptyEl.style.display="none";
  }

  items.forEach(i=>{
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      <div>
        <div class="cart-item-name">${i.name}</div>
        <div class="cart-item-meta">${i.category || ""}</div>
      </div>
      <div class="cart-item-right">
        <div>‚Çπ${(i.price * i.qty).toFixed(2)}</div>
        <div class="cart-item-qty">Qty: ${i.qty}</div>
      </div>
    `;
    box.appendChild(div);
  });
}

/* ============ COUPONS (nightlife backend) ============ */
async function loadCoupons(){
  const select = document.getElementById("couponSelect");
  const msgBox = document.getElementById("couponMsg");
  select.innerHTML = `<option value="">Loading coupons...</option>`;
  try{
    const res = await fetch(`${NIGHT_API_URL}/nightlife/coupons/${club_id}`);
    const data = await res.json();
    if(!data.success || !Array.isArray(data.coupons) || data.coupons.length === 0){
      AVAILABLE_COUPONS = [];
      select.innerHTML = `<option value="">No coupons available</option>`;
      msgBox.textContent = "";
      calculateTotals();
      return;
    }
    AVAILABLE_COUPONS = data.coupons;
    select.innerHTML = `<option value="">Select coupon (${AVAILABLE_COUPONS.length} available)</option>`;
    AVAILABLE_COUPONS.forEach(c=>{
      const label = `${c.code} ‚Äî ${c.type === 'percent' ? c.value + '% off' : '‚Çπ' + c.value + ' off'} (min ‚Çπ${c.min_order})`;
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = label;
      select.appendChild(opt);
    });
    calculateTotals();
  }catch(e){
    console.error(e);
    select.innerHTML = `<option value="">Error loading coupons</option>`;
    calculateTotals();
  }
}

document.getElementById("btnApplyCoupon").addEventListener("click", async ()=>{
  const select = document.getElementById("couponSelect");
  const couponId = parseInt(select.value);
  const subtotal = parseFloat(document.getElementById("cartSubtotal").textContent || "0");
  const msgBox = document.getElementById("couponMsg");

  if(!couponId){
    DISCOUNT_AMOUNT = 0;
    APPLIED_COUPON = null;
    msgBox.textContent = "No coupon selected";
    calculateTotals();
    return;
  }
  if(subtotal <= 0){
    toast("Cart is empty");
    return;
  }

  try{
    const res = await fetch(`${NIGHT_API_URL}/nightlife/coupon/validate`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({club_id, coupon_id: couponId, subtotal})
    });
    const data = await res.json();
    if(!data.success){
      DISCOUNT_AMOUNT = 0;
      APPLIED_COUPON = null;
      msgBox.textContent = data.message || "Coupon invalid";
    }else{
      DISCOUNT_AMOUNT = data.discount || 0;
      APPLIED_COUPON = data.coupon.code;
      msgBox.textContent = `${APPLIED_COUPON} applied: -‚Çπ${DISCOUNT_AMOUNT.toFixed(2)}`;
    }
    calculateTotals();
  }catch(e){
    console.error(e);
    toast("Error applying coupon");
  }
});

/* ============ PLACE ORDER (COD) ============ */
document.getElementById("btnCod").addEventListener("click", async ()=>{
  const items = Object.values(CART);
  if(items.length === 0){toast("Cart is empty");return;}
  if(!CURRENT_USER){toast("Login required to place order");openAuthModal();return;}
  const addr = document.getElementById("deliveryAddress").value.trim();
  if(!addr){toast("Enter delivery address");return;}

  const payloadItems = items.map(i=>({item_id:i.id, qty:i.qty}));

  const subtotal = parseFloat(document.getElementById("cartSubtotal").textContent || "0");
  const platform_fee = parseFloat(document.getElementById("cartPlatform").textContent || "0");
  const delivery_fee = parseFloat(document.getElementById("cartDelivery").textContent || "0");
  const packing_fee  = parseFloat(document.getElementById("cartPacking").textContent || "0");
  const tax_amount   = parseFloat(document.getElementById("cartTax").textContent || "0");
  const discount     = parseFloat(document.getElementById("cartDiscount").textContent || "0");
  const total        = parseFloat(document.getElementById("cartTotal").textContent || "0");

  // save address for next time
  localStorage.setItem("zoma_nightlife_last_address", addr);

  const body = {
    club_id,
    vendor_id: CURRENT_VENDOR_ID,
    club_name: CLUB_NAME,
    items: payloadItems,
    user_id: CURRENT_USER.id,
    user_name: CURRENT_USER.name,
    user_phone: CURRENT_USER.phone,
    user_address: addr,
    coupon_code: APPLIED_COUPON,
    pricing: {
      subtotal,
      platform_fee,
      delivery_fee,
      packing_fee,
      tax_amount,
      discount,
      total
    }
  };

  try{
    document.getElementById("btnCod").disabled = true;
    const res = await fetch(`${MAIN_API_URL}/nightlife/order/cod`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    const data = await res.json();
    document.getElementById("btnCod").disabled = false;

    if(!data.success){
      toast(data.message || "Order failed");
      return;
    }
    toast("Order placed (COD)");
    document.getElementById("orderInfo").textContent =
      `Order #${data.order.id} ‚Ä¢ Status: ${data.order.status}`;

    // redirect to tracking page
    window.location.href = `nightlife_track.html?order_id=${data.order.id}`;

    CART = {};
    DISCOUNT_AMOUNT = 0;
    APPLIED_COUPON = null;
    document.getElementById("couponSelect").selectedIndex = 0;
    document.getElementById("couponMsg").textContent="";
    renderCart();
    calculateTotals();
    loadUserOrders();
  }catch(e){
    console.error(e);
    document.getElementById("btnCod").disabled = false;
    toast("Error placing order");
  }
});

/* ============ PLACE ORDER (ONLINE ‚Äî RAZORPAY) ============ */
document.getElementById("btnOnline").addEventListener("click", async ()=>{
  const items = Object.values(CART);
  if(items.length === 0){toast("Cart is empty");return;}
  if(!CURRENT_USER){toast("Login required to place order");openAuthModal();return;}
  const addr = document.getElementById("deliveryAddress").value.trim();
  if(!addr){toast("Enter delivery address");return;}

  const amount = parseFloat(document.getElementById("cartTotal").textContent || "0");
  if(amount <= 0){toast("Invalid amount");return;}

  const subtotal = parseFloat(document.getElementById("cartSubtotal").textContent || "0");
  const platform_fee = parseFloat(document.getElementById("cartPlatform").textContent || "0");
  const delivery_fee = parseFloat(document.getElementById("cartDelivery").textContent || "0");
  const packing_fee  = parseFloat(document.getElementById("cartPacking").textContent || "0");
  const tax_amount   = parseFloat(document.getElementById("cartTax").textContent || "0");
  const discount     = parseFloat(document.getElementById("cartDiscount").textContent || "0");

  // save address
  localStorage.setItem("zoma_nightlife_last_address", addr);

  let orderObject;
  try{
    const res = await fetch(`${MAIN_API_URL}/api/create_order`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({amount})
    });
    orderObject = await res.json();
    if(orderObject.status === "failed"){
      toast(orderObject.error || "Payment system not configured");
      return;
    }
  }catch(e){
    console.error(e);
    toast("Error creating payment");
    return;
  }

  const rzpOptions = {
    key: "YOUR_KEY",
    amount: orderObject.amount,
    currency: "INR",
    name: "ZomaClone Nightlife",
    description: "Nightlife order",
    order_id: orderObject.id,
    handler: async function (response){
      try{
        const payload = {
          club_id,
          vendor_id: CURRENT_VENDOR_ID,
          club_name: CLUB_NAME,
          amount,
          razorpay_order_id: response.razorpay_order_id,
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_signature: response.razorpay_signature,
          items: items.map(i=>({item_id:i.id, qty:i.qty})),
          user_id: CURRENT_USER.id,
          user_name: CURRENT_USER.name,
          user_phone: CURRENT_USER.phone,
          user_address: addr,
          coupon_code: APPLIED_COUPON,
          pricing: {
            subtotal,
            platform_fee,
            delivery_fee,
            packing_fee,
            tax_amount,
            discount,
            total: amount
          }
        };

        const res2 = await fetch(`${MAIN_API_URL}/api/nightlife/payment/confirm`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(payload)
        });
        const data2 = await res2.json();
        if(!data2.success){
          toast(data2.message || "Order create failed after payment");
          return;
        }
        toast("Payment Successful & order placed");
        document.getElementById("orderInfo").textContent =
          `Order #${data2.order.id} ‚Ä¢ Status: ${data2.order.status}`;

        // redirect to tracking page
        window.location.href = `nightlife_track.html?order_id=${data2.order.id}`;

        CART = {};DISCOUNT_AMOUNT=0;APPLIED_COUPON=null;
        document.getElementById("couponSelect").selectedIndex = 0;
        document.getElementById("couponMsg").textContent="";
        renderCart();calculateTotals();
        loadUserOrders();
      }catch(e){
        console.error(e);
        toast("Error confirming payment");
      }
    },
    theme: {color:"#eb4899"}
  };

  const rzp = new Razorpay(rzpOptions);
  rzp.open();
});

/* ============ USER ORDER TRACKING + RATING LOCK ============ */
async function loadUserOrders(){
  if(!CURRENT_USER){return;}
  try{
    const res = await fetch(`${MAIN_API_URL}/api/user/nightlife/orders/${CURRENT_USER.id}`);
    if(!res.ok){
      // backend not ready yet; just skip silently
      return;
    }
    const orders = await res.json();
    const box = document.getElementById("userOrders");
    const outer = document.getElementById("userOrdersBox");

    outer.style.display="block";
    if(!Array.isArray(orders) || orders.length === 0){
      box.innerHTML = `<div style="font-size:12px;color:#9ca3af;">No orders yet.</div>`;
      CAN_RATE = false;
    }else{
      box.innerHTML="";
      CAN_RATE = false;
      orders.forEach(o=>{
        box.innerHTML += `
          <div style="padding:6px;border-radius:8px;background:#020617;margin-bottom:6px;cursor:pointer;"
               onclick="window.location.href='nightlife_track.html?order_id=${o.id}'">
            <div style="font-size:13px;">Order #${o.id} ‚Ä¢ ‚Çπ${o.total}</div>
            <div style="font-size:11px;color:#a5b4fc;">Status: ${o.status}</div>
          </div>
        `;
        if(Number(o.club_id) === club_id && String(o.status || "").toUpperCase() === "DELIVERED"){
          CAN_RATE = true;
        }
      });
    }

    const ratingCard = document.getElementById("ratingCard");
    const ratingHint = document.getElementById("ratingHint");
    if(CAN_RATE){
      ratingCard.style.display = "block";
      ratingHint.textContent = "You‚Äôve had a delivery from this club. Share your experience.";
    }else{
      ratingCard.style.display = "none";
      ratingHint.textContent = "";
    }
  }catch(e){
    console.error(e);
  }
}

/* ============ BOOT ============ */
loadClub();
</script>

</body>
</html>
