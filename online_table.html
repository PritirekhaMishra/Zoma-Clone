<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Book a Table Online — ZomaClone</title>
<link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">

<style>
  :root{
    --accent:#e53935;
    --accent-soft:#ffe5e5;
    --muted:#6b6b6b;
    --bg:#fff7f7;
    --card:#ffffff;
    --radius:16px;
    --shadow:0 18px 40px rgba(0,0,0,0.06);
    --green:#0f9d58;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:Poppins,system-ui,Arial;
    background:linear-gradient(180deg,#fff7f7,#ffffff);
    color:#111;
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px 32px}
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    margin-bottom:24px;
  }
  .brand{font-size:24px;font-weight:800;color:#222}
  .brand span{color:var(--accent);}
  .sub{font-size:13px;color:var(--muted);margin-top:4px}
  .search-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .search-input{
    flex:1;
    min-width:220px;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid #eee;
    background:#fff;
    font-size:13px;
  }
  .pill{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid #eee;
    font-size:12px;
    color:var(--muted);
    background:#fff;
    cursor:pointer;
    white-space:nowrap;
  }
  .pill.active{
    border-color:var(--accent);
    color:var(--accent);
    background:var(--accent-soft);
    font-weight:600;
  }

  .grid{
    margin-top:20px;
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:18px;
  }
  @media(max-width:1080px){
    .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
  }
  @media(max-width:780px){
    .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media(max-width:520px){
    .grid{grid-template-columns:repeat(1,minmax(0,1fr))}
  }

  .card{
    background:var(--card);
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:var(--shadow);
    border:1px solid rgba(0,0,0,0.04);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    transition:transform .16s, box-shadow .16s;
  }
  .card:hover{
    transform:translateY(-6px);
    box-shadow:0 22px 48px rgba(0,0,0,0.08);
  }
  .card-banner{
    position:relative;
    height:150px;
    background-size:cover;
    background-position:center;
  }
  .card-badge{
    position:absolute;
    bottom:10px;
    left:10px;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    background:rgba(0,0,0,0.65);
    color:#fff;
  }
  .card-body{
    padding:12px 14px 14px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .name{
    font-size:15px;
    font-weight:700;
  }
  .addr{
    font-size:12px;
    color:var(--muted);
  }
  .meta{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
  }
  .eta{
    font-weight:600;
    color:#222;
  }
  .tag{
    padding:2px 6px;
    border-radius:999px;
    background:#eaffea;
    color:var(--green);
    font-size:11px;
    font-weight:600;
  }

  .empty{
    margin-top:36px;
    text-align:center;
    color:var(--muted);
    font-size:14px;
  }
  .loader{
    margin-top:40px;
    text-align:center;
    font-size:14px;
    color:var(--muted);
  }
  .dot{
    display:inline-block;
    width:6px;height:6px;
    border-radius:50%;
    background:var(--accent);
    margin:0 2px;
    animation:bounce 1s infinite alternate;
  }
  .dot:nth-child(2){animation-delay:.2s}
  .dot:nth-child(3){animation-delay:.4s}
  @keyframes bounce{
    to{transform:translateY(-4px);opacity:.3}
  }
  footer{
    margin-top:32px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="brand">Table<span>Book</span></div>
      <div class="sub">Choose a café/restaurant and book your table instantly.</div>
      <div class="search-row">
        <input id="searchInput" class="search-input" placeholder="Search by name, city, area..." />
        <button class="pill active" data-filter="all">All</button>
        <button class="pill" data-filter="busy">Most booked</button>
        <button class="pill" data-filter="near">Fastest serving</button>
      </div>
    </div>
  </header>

  <div id="loader" class="loader">
    Loading restaurants
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>

  <div id="grid" class="grid" style="display:none"></div>
  <div id="empty" class="empty" style="display:none">No restaurants found.</div>

  <footer>© ZomaClone · Book Your Table Now</footer>
</div>

<script>
const API_BASE = "http://127.0.0.1:5000";

const grid = document.getElementById("grid");
const loader = document.getElementById("loader");
const empty = document.getElementById("empty");
const searchInput = document.getElementById("searchInput");
const pills = Array.from(document.querySelectorAll(".pill"));

let allVendors = [];
let filtered = [];
let activeFilter = "all";

// load vendors + TB settings
async function loadRestaurants(){
  try{
    const res = await fetch(`${API_BASE}/api/admin/vendors`);
    const vendors = await res.json();

    // for each vendor, fetch table-booking settings (banner, location, stats)
    const withSettings = await Promise.all(
      vendors.map(async v => {
        try{
          const sRes = await fetch(`${API_BASE}/api/rest/vendor/me?vendor_id=${v.id}`);
          const sJson = await sRes.json();
          if(!sJson.success) throw new Error();

          const loc = sJson.location || {};
          const stats = sJson.stats || {};
          const settings = sJson.settings || {};

          return {
            id: v.id,
            restaurant_name: v.restaurant_name,
            owner_name: v.owner_name,
            email: v.email,
            phone: v.phone,
            address: v.address,
            city: loc.city || "",
            addr1: loc.addr1 || "",
            banner: sJson.banner || null,
            upcomingBookings: stats.upcomingBookings || 0,
            cancelBeforeHrs: settings.cancelBeforeHrs || 2
          };
        }catch(e){
          // if settings call fails, still show vendor
          return {
            id: v.id,
            restaurant_name: v.restaurant_name,
            owner_name: v.owner_name,
            email: v.email,
            phone: v.phone,
            address: v.address,
            city: "",
            addr1: "",
            banner: null,
            upcomingBookings: 0,
            cancelBeforeHrs: 2
          };
        }
      })
    );

    allVendors = withSettings;
    filtered = [...allVendors];
    renderGrid();
  }catch(e){
    console.error(e);
    loader.textContent = "Failed to load restaurants from server.";
  }
}

function etaText(v){
  // simple fake ETA using cancelBeforeHrs as base
  const base = Math.max(20, Math.min(60, (v.cancelBeforeHrs || 2) * 15));
  const max = base + 10;
  return `${base}–${max} mins`;
}

function renderGrid(){
  loader.style.display = "none";

  const q = searchInput.value.trim().toLowerCase();
  const list = filtered.filter(v => {
    if(!q) return true;
    const hay = (
      (v.restaurant_name || "") + " " +
      (v.city || "") + " " +
      (v.addr1 || "") + " " +
      (v.address || "")
    ).toLowerCase();
    return hay.includes(q);
  });

  grid.innerHTML = "";
  if(!list.length){
    grid.style.display = "none";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";
  grid.style.display = "grid";

  list.forEach(v => {
    const card = document.createElement("div");
    card.className = "card";
    const bannerUrl = v.banner
      ? v.banner
      : "https://source.unsplash.com/600x400/?restaurant,cafe";

    const addrLine = (v.city || "") + (v.addr1 ? " · " + v.addr1 : "");
    const eta = etaText(v);
    const busyLabel = v.upcomingBookings > 0
      ? `${v.upcomingBookings} upcoming bookings`
      : "New on TableBook";

    card.innerHTML = `
      <div class="card-banner" style="background-image:
        linear-gradient(180deg,rgba(0,0,0,0.15),rgba(0,0,0,0.25)),
        url('${bannerUrl}')">
        <div class="card-badge">${busyLabel}</div>
      </div>
      <div class="card-body">
        <div class="name">${v.restaurant_name || "Restaurant"}</div>
        <div class="addr">${addrLine || v.address || ""}</div>
        <div class="meta">
          
          <div><span class="tag">Table booking</span></div>
        </div>
      </div>
    `;

    card.addEventListener("click", () => {
      // open table_use.html with vendor_id in URL
      location.href = `table_use.html?vendor_id=${encodeURIComponent(v.id)}`;
    });

    grid.appendChild(card);
  });
}

// filter pills
pills.forEach(p => {
  p.addEventListener("click", () => {
    pills.forEach(x => x.classList.remove("active"));
    p.classList.add("active");
    activeFilter = p.dataset.filter;

    if(activeFilter === "all"){
      filtered = [...allVendors];
    }else if(activeFilter === "busy"){
      filtered = allVendors
        .slice()
        .sort((a,b) => (b.upcomingBookings||0) - (a.upcomingBookings||0));
    }else if(activeFilter === "near"){
      filtered = allVendors
        .slice()
        .sort((a,b) => (a.cancelBeforeHrs||0) - (b.cancelBeforeHrs||0));
    }
    renderGrid();
  });
});

// search
searchInput.addEventListener("input", () => renderGrid());

// init
loadRestaurants();
</script>
</body>
</html>
