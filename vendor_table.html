<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZomaClone Vendor Dashboard — Fixed Set Button</title>

<link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">


<style>
/* GLOBAL */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Poppins,Arial,Helvetica,sans-serif;background:#f5f5f5;display:flex;min-height:100vh;color:#222}

/* SIDEBAR */
.sidebar{
    width:250px;background:linear-gradient(180deg,#e53935,#ff4d4d);
    min-height:100vh;padding:24px 12px;color:#fff;position:fixed;left:0;top:0;
}
.logo{text-align:center;font-size:26px;font-weight:800;margin-bottom:20px}
.menu-item{padding:12px 16px;border-radius:8px;cursor:pointer;font-weight:600;margin-bottom:10px}
.menu-item:hover{background:rgba(255,255,255,.08)}
.menu-item.active{background:#fff;color:#e53935}

/* MAIN */
.main{margin-left:260px;padding:22px;width:100%}
.card{
    background:#fff;padding:16px;border-radius:12px;margin-bottom:18px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);border:1px solid #eee
}
h1{margin-bottom:12px;font-size:22px}
h2{margin-bottom:10px;font-size:18px}
label{font-size:13px;color:#666;margin-top:8px;display:block}
input,select,textarea,button{
    font-family:inherit;
}
input,select,textarea{
    width:100%;padding:10px;margin-top:6px;border-radius:8px;
    border:1px solid #ccc;outline:none;background:#fff;
}
input[readonly]{background:#f7f7f7}

/* layout helpers */
.row{display:flex;gap:10px;margin-top:8px;align-items:center}
.row > div{flex:1}

/* ✅ FIX: make Set button small */
.row button.set-small {
    flex: 0 0 auto;
    width:120px;
    padding:8px 12px;
    font-size:14px;
}

/* slot styles (kept same look) */
.slot-row {
  display: flex;
  gap: 14px;
  margin-top: 14px;
  align-items: center;
}

.slot-input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 15px;
}

.time-wrapper {
  display: flex;
  gap: 8px;
  align-items: center;
}

.time-wrapper input,
.time-wrapper select {
  width: 70px;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 14px;
}

.slot-btn {
  padding: 10px 18px;
  border: none;
  border-radius: 999px;
  background: #e53935;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.slot-btn:hover {
  background: #ff4c4c;
}

/* Buttons */
.btn{
    padding:10px 16px;border:none;border-radius:999px;
    background:linear-gradient(135deg,#e53935,#ff4d4d);color:#fff;
    font-weight:700;cursor:pointer;
}
.btn.secondary{
    background:#fff;color:#e53935;border:1px solid #e53935
}

/* small sections hidden by default */
.section{display:none}

/* table grid */
.table-grid{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.table-cell{width:44px;height:44px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;border:1px solid rgba(0,0,0,0.06)}
.cell-free{background:#E8FFF2;color:#065b3e}
.cell-reserved{background:#FFE6E6;color:#8b2b2b}
.cell-unavail{background:#f0f0f0;color:#888;border-style:dashed}

/* modal */
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal{background:#fff;padding:16px;border-radius:12px;max-width:720px;width:95%;box-shadow:0 8px 24px rgba(0,0,0,0.12);border:1px solid #eee}

/* popup */
.popup{position:fixed;top:20px;right:20px;background:#22c55e;color:#fff;padding:10px 14px;border-radius:8px;font-weight:700;z-index:10000;transition:.3s}
.popup.error{background:#e11d48}

/* misc */
.small{font-size:13px;color:#666;margin-top:6px}

/* responsive */
@media (max-width:900px){
  .sidebar{position:relative;width:100%;display:flex;overflow:auto}
  .main{margin-left:0;padding:12px}
  .row{flex-direction:column}
  .row button.set-small{width:100%}
}
</style>
</head>
<body>
<aside class="sidebar" aria-label="Sidebar">
    <div class="logo">ZomaClone</div>
    <div class="menu-item active" data-section="dashboard" role="button" tabindex="0">Dashboard</div>
    <div class="menu-item" data-section="types" role="button" tabindex="0">Table Types</div>
    <div class="menu-item" data-section="slots" role="button" tabindex="0">Slots</div>
    <div class="menu-item" data-section="bookings" role="button" tabindex="0">Bookings</div>
    <div class="menu-item" data-section="settings" role="button" tabindex="0">Settings</div>
    <div class="menu-item" data-section="location" role="button" tabindex="0">Location</div>
    <div class="menu-item" data-section="userSim" role="button" tabindex="0">User Simulator</div>
</aside>

<main class="main" role="main">
<h1>Vendor Dashboard</h1>

<!-- DASHBOARD -->
<section id="dashboard" class="section" aria-labelledby="dashboardHeading">
    <div class="card">
        <h2 id="dashboardHeading">Vendor Setup</h2>

        <label for="restaurantName">Restaurant Name</label>
        <input id="restaurantName" placeholder="My Restaurant" aria-label="Restaurant name">

        <div class="row" style="margin-top:10px">
            <div style="flex:1">
                <label for="vendorEmail">Vendor Email</label>
                <input id="vendorEmail" placeholder="vendor@example.com" aria-label="Vendor email">
            </div>
            <button class="btn set-small" id="setVendorBtn" title="Set vendor (save)">Set</button>
        </div>

        <p id="dashVendor" style="margin-top:10px;color:#666"></p>
        <p id="dashRestaurant" style="margin-top:4px;color:#444;font-weight:600"></p>

        <!-- Banner -->
        <h3 style="margin-top:18px;font-size:16px;font-weight:600">Vendor Banner</h3>
        <input type="file" id="bannerInput" accept="image/*" style="margin-top:6px" aria-label="Upload banner">

        <div id="bannerPreviewWrap" style="
            display:none;margin-top:12px;
            border:1px solid #ddd;border-radius:10px;overflow:hidden;
        ">
            <img id="bannerPreview" style="width:100%;height:auto;display:block" alt="Banner preview">
            <button id="removeBanner" class="btn secondary"
                style="width:100%;border-radius:0;border:none;border-top:1px solid #ddd">
                Remove Banner
            </button>
        </div>
    </div>

    <div class="card">
        <h2>Quick Stats</h2>
        <p id="dashStats">Set vendor first.</p>
    </div>
</section>

<!-- TABLE TYPES -->
<section id="types" class="section" aria-labelledby="typesHeading">
    <div class="card">
        <h2 id="typesHeading">Table Types</h2>

        <label>Table Type</label>
        <select id="typeSelect" aria-label="Table type">
            <option value="" disabled selected>Select type</option>
            <option value="2-seater">2-Seater</option>
            <option value="4-seater">4-Seater</option>
            <option value="6-seater">6-Seater</option>
            <option value="8-seater">8-Seater</option>
            <option value="Couple Table">Couple Table</option>
            <option value="Family Table">Family Table</option>
            <option value="VIP Table">VIP Table</option>
            <option value="Outdoor Table">Outdoor Table</option>
            <option value="Custom">Custom Seats</option>
        </select>

        <label>Seats per table</label>
        <input id="typeSeats" type="number" disabled aria-label="Seats per table">

        <div class="row">
            <div>
                <label>Total Tables</label>
                <input id="typeTotal" type="number" value="1" min="1">
            </div>
            <div>
                <label>Free Tables (initial)</label>
                <input id="typeFree" type="number" value="1" min="0">
            </div>
        </div>

        <div class="row" style="margin-top:10px">
            <div>
                <label>Price (₹)</label>
                <input id="typePrice" type="number" placeholder="0">
            </div>
            <div>
                <label>Cancel before (hrs)</label>
                <input id="typeCancel" type="number" placeholder="2" value="2">
            </div>
        </div>

        <!-- Time fields -->
        <div class="row" style="margin-top:10px">
            <div>
                <label>Start Hour (1-12)</label>
                <input type="number" id="startHour" min="1" max="12" placeholder="10">
            </div>
            <div>
                <label>Start Minute (0-59)</label>
                <input type="number" id="startMinute" min="0" max="59" placeholder="00">
            </div>
            <div>
                <label>AM/PM</label>
                <select id="startPeriod" aria-label="Start period">
                    <option>AM</option>
                    <option>PM</option>
                </select>
            </div>
        </div>

        <div class="row" style="margin-top:8px">
            <div>
                <label>End Hour (1-12)</label>
                <input type="number" id="endHour" min="1" max="12" placeholder="11">
            </div>
            <div>
                <label>End Minute (0-59)</label>
                <input type="number" id="endMinute" min="0" max="59" placeholder="00">
            </div>
            <div>
                <label>AM/PM</label>
                <select id="endPeriod" aria-label="End period">
                    <option>AM</option>
                    <option>PM</option>
                </select>
            </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button id="addTypeBtn" class="btn">Add / Update Type</button>
            <button id="clearTypeBtn" class="btn secondary">Clear Types</button>
        </div>
    </div>

    <div id="typeList" class="card">
        <div class="small">No types yet</div>
    </div>
</section>

<!-- SLOTS -->
<section id="slots" class="section">
  <div class="card">
    <h2>Slots</h2>

    <input id="slotName" class="slot-input" type="text" placeholder="Slot name (e.g., Lunch, Dinner)">

    <div class="slot-row">
      <div class="time-wrapper">
        <input id="startHourSlot" type="number" min="1" max="12" placeholder="HH">
        <input id="startMinSlot" type="number" min="0" max="59" placeholder="MM">
        <select id="startPeriodSlot"><option>AM</option><option>PM</option></select>
      </div>

      <div class="time-wrapper">
        <input id="endHourSlot" type="number" min="1" max="12" placeholder="HH">
        <input id="endMinSlot" type="number" min="0" max="59" placeholder="MM">
        <select id="endPeriodSlot"><option>AM</option><option>PM</option></select>
      </div>

      <button id="addSlotBtn" class="slot-btn">Add Slot</button>
    </div>

    <div id="slotList" class="slot-list small" style="margin-top:12px">No slots</div>
  </div>
</section>

<!-- BOOKINGS -->
<section id="bookings" class="section" aria-labelledby="bookingsHeading">
  <div class="card">
    <h2 id="bookingsHeading">Bookings</h2>
    <div id="bookingsList" class="card">
      <div class="small">No bookings</div>
    </div>
  </div>
</section>

<!-- SETTINGS -->
<section id="settings" class="section" aria-labelledby="settingsHeading">
  <div class="card">
    <h2 id="settingsHeading">Settings</h2>
    <label>Max advance days</label>
    <input id="maxAdvance" type="number" value="365" min="1">
    <label>Cancel allowed before (hours)</label>
    <input id="cancelBeforeHrs" type="number" value="2" min="0">
    <div style="margin-top:10px">
      <button id="saveSettings" class="btn">Save Settings</button>
    </div>
  </div>
</section>

<!-- LOCATION -->
<section id="location" class="section" aria-labelledby="locationHeading">
  <div class="card">
    <h2 id="locationHeading">Location</h2>
    <label>Address line 1</label>
    <input id="addr1" placeholder="Street / building">
    <label>Address line 2</label>
    <input id="addr2" placeholder="Landmark (optional)">
    <div class="row">
      <input id="city" placeholder="City">
      <input id="state" placeholder="State">
      <input id="pincode" placeholder="Pincode">
    </div>
    <div style="margin-top:10px">
      <button id="saveLocationBtn" class="btn">Save Location</button>
    </div>
    <p id="locInfo" class="small" style="margin-top:8px"></p>
  </div>
</section>

<!-- USER SIMULATOR -->
<section id="userSim" class="section" aria-labelledby="userSimHeading">
  <div class="card">
    <h2 id="userSimHeading">User Booking Simulator</h2>
    <div style="margin-bottom:8px">
      <label>Use vendor (simulate)</label>
      <input id="userVendor" placeholder="vendor@example.com">
      <button id="loadVendorData" class="btn secondary" style="margin-top:6px">Load</button>
    </div>

    <div id="userForm" style="display:none">
      <label>Table Type</label>
      <select id="typeSelectUser"></select>

      <label>Slot</label>
      <select id="slotSelect"></select>

      <div class="row" style="margin-top:6px">
        <input id="date" type="date">
        <input id="name" placeholder="Customer name">
      </div>
      <div class="row" style="margin-top:6px">
        <input id="phone" placeholder="Phone">
        <input id="numTables" type="number" value="1" min="1">
      </div>

      <div class="row" style="margin-top:6px">
        <input id="price" readonly placeholder="Price">
        <button id="bookNow" class="btn">Book Now</button>
      </div>
    </div>
  </div>
</section>

<div id="modalRoot" style="display:none;z-index:9999" aria-hidden="true"></div>

<script>
/* --------------------------
   Utilities
   -------------------------- */
function q(sel, root = document){ return (root||document).querySelector(sel); }
function qa(sel, root = document){ return Array.from((root||document).querySelectorAll(sel)); }
function idGen(prefix='id'){ return prefix+'_'+Date.now()+'_'+Math.floor(Math.random()*9000); }
function escapeHtml(s){ if(s === 0) return '0'; if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function pop(msg, err=false){
    const el=document.createElement('div');
    el.className='popup'+(err?' error':'');
    el.textContent=msg;
    document.body.appendChild(el);
    setTimeout(()=>el.style.opacity='0',1500);
    setTimeout(()=>el.remove(),2000);
}
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* --------------------------
   Time helpers
   -------------------------- */
function convertTo24(h,m,p){
  h=Number(h); m=Number(m);
  if(isNaN(h)) h=0; if(isNaN(m)) m=0;
  if(p==='AM' && h===12) h=0;
  if(p==='PM' && h!==12) h+=12;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
function format12From24(t){
  if(!t) return '';
  const parts=t.split(':').map(Number);
  if(parts.length<2) return t;
  const h=parts[0], m=parts[1];
  const p=h>=12?'PM':'AM';
  let h12=h%12; if(h12===0) h12=12;
  return `${h12}:${String(m).padStart(2,'0')} ${p}`;
}

/* --------------------------
   Storage keys / state
   -------------------------- */
let vendor = localStorage.getItem('tb_vendor') || '';
if(q('#vendorEmail')) q('#vendorEmail').value = vendor;

const k_types=v=>'tb_types_'+v;
const k_slots=v=>'tb_slots_'+v;
const k_restName = v => 'tb_restname_' + v;
const k_bookings=v=>'tb_bookings_'+v;
const k_settings=v=>'tb_settings_'+v;
const k_location=v=>'tb_location_'+v;
const k_banner=v=>'tb_banner_'+v;

let types=[], slots=[], bookings=[];
let settings={maxAdvanceDays:365, cancelBeforeHrs:2};
let locationObj={};
let banner = "";

/* Save helpers */
function saveTypes(){ if(vendor) localStorage.setItem(k_types(vendor), JSON.stringify(types)); }
function saveSlots(){ if(vendor) localStorage.setItem(k_slots(vendor), JSON.stringify(slots)); }
function saveBookings(){ if(vendor) localStorage.setItem(k_bookings(vendor), JSON.stringify(bookings)); }
function saveSettings(){ if(vendor) localStorage.setItem(k_settings(vendor), JSON.stringify(settings)); }
function saveLocation(){ if(vendor) localStorage.setItem(k_location(vendor), JSON.stringify(locationObj||{})); }
function saveBanner(){ if(vendor) localStorage.setItem(k_banner(vendor), banner||''); }

/* --------------------------
   Banner Loading
   -------------------------- */
function renderBanner(){
  const wrap=q('#bannerPreviewWrap');
  const img=q('#bannerPreview');
  if(!wrap || !img) return;

  if(banner){
    wrap.style.display='block';
    img.src=banner;
  } else {
    wrap.style.display='none';
    img.src='';
  }
}

/* Handle Banner Upload */
if(q('#bannerInput')){
  q('#bannerInput').addEventListener('change', (e)=>{
    const file=(e.target && e.target.files && e.target.files[0]) || null;
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      banner=reader.result;
      saveBanner();
      renderBanner();
      pop("Banner saved");
    };
    reader.readAsDataURL(file);
  });
}

/* Remove Banner */
if(q('#removeBanner')){
  q('#removeBanner').addEventListener('click', ()=>{
    banner="";
    saveBanner();
    renderBanner();
    pop("Banner removed");
  });
}

/* --------------------------
   Load All Vendor Data
   -------------------------- */
function loadAll(){
  vendor = q('#vendorEmail') ? (q('#vendorEmail').value.trim() || vendor) : vendor;
  if(!vendor) return pop('Enter vendor email first', true);

  localStorage.setItem('tb_vendor', vendor);

  types = JSON.parse(localStorage.getItem(k_types(vendor)) || '[]');
  slots = JSON.parse(localStorage.getItem(k_slots(vendor)) || '[]');
  bookings = JSON.parse(localStorage.getItem(k_bookings(vendor)) || '[]');
  settings = JSON.parse(localStorage.getItem(k_settings(vendor)) || JSON.stringify(settings));
  locationObj = JSON.parse(localStorage.getItem(k_location(vendor)) || '{}');
  banner = localStorage.getItem(k_banner(vendor)) || "";
  let restName = localStorage.getItem(k_restName(vendor)) || "";
  if (q('#restaurantName')) q('#restaurantName').value = restName;
  if (q('#dashRestaurant')) q('#dashRestaurant').textContent = restName ? ("Restaurant: " + restName) : "";

  renderTypes();
  renderSlots();
  renderBookings();
  renderStats();
  renderLocation();
  populateUserForm();
  renderBanner();

  if(q('#dashVendor')) q('#dashVendor').textContent = 'Vendor: ' + vendor;
}

/* Set Vendor + Save restaurant name */
if (q('#setVendorBtn')) {
    q('#setVendorBtn').addEventListener('click', () => {
        const email = (q('#vendorEmail') && q('#vendorEmail').value.trim()) || '';
        const rname = (q('#restaurantName') && q('#restaurantName').value.trim()) || '';

        if (!email) return pop("Enter vendor email", true);

        vendor = email;
        localStorage.setItem('tb_vendor', vendor);

        if (rname) {
            localStorage.setItem(k_restName(vendor), rname);
        }

        loadAll();

        q('#dashRestaurant').textContent = rname ? "Restaurant: " + rname : "";
        pop("Vendor saved");
    });
}

/* Also save vendor on Enter key in vendorEmail */
if(q('#vendorEmail')){
  q('#vendorEmail').addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); q('#setVendorBtn').click(); }
  });
}

/* --------------------------
   Sidebar Navigation
   -------------------------- */
qa('.menu-item').forEach(mi=>{
  mi.addEventListener('click', ()=>{
    qa('.menu-item').forEach(x=>x.classList.remove('active'));
    mi.classList.add('active');
    const sec=mi.dataset.section;
    qa('.section').forEach(s=>s.style.display='none');
    const tgt = q('#'+sec);
    if(tgt) tgt.style.display='block';
    window.scrollTo({top:0, behavior:'smooth'});
  });
});
q('#dashboard').style.display='block';

/* --------------------------
   Seat Mapping
   -------------------------- */
const seatMapping={"2-seater":2,"4-seater":4,"6-seater":6,"8-seater":8,"Couple Table":2,"Family Table":6,"VIP Table":4,"Outdoor Table":4};

if(q('#typeSelect')){
  q('#typeSelect').addEventListener('change', ()=>{
    const v=q('#typeSelect').value;
    if(v==='Custom'){
      q('#typeSeats').disabled=false;
      q('#typeSeats').value='';
    } else {
      q('#typeSeats').disabled=true;
      q('#typeSeats').value=seatMapping[v]||'';
    }
  });
}

/* --------------------------
   Make Tables Array
   -------------------------- */
function makeTablesArray(total, existing=[]){
  const arr=[];
  for(let i=1;i<=total;i++){
    const f=existing.find(x=>x.num===i);
    arr.push(f || {num:i, status:'free', bookingId:null});
  }
  return arr;
}

/* --------------------------
   ADD / EDIT TYPE
   -------------------------- */
if(q('#addTypeBtn')){
  q('#addTypeBtn').addEventListener('click', ()=>{

    if(!vendor) return pop('Set vendor first',true);

    const name=q('#typeSelect').value;
    if(!name) return pop('Select table type',true);

    const seats=(name==='Custom')
        ? Number(q('#typeSeats').value)
        : seatMapping[name] || Number(q('#typeSeats').value);

    const total=Number(q('#typeTotal').value);
    const freeInput=Number(q('#typeFree').value);
    const price=Number(q('#typePrice').value||0);
    const cancel=Number(q('#typeCancel').value||2);

    if(!seats || seats<=0) return pop('Invalid seat count',true);
    if(total<=0) return pop('Total must be > 0',true);
    if(freeInput>total) return pop('Free must be <= total',true);

    /* Time */
    const sH=q('#startHour').value;
    const sM=q('#startMinute').value;
    const sP=q('#startPeriod').value;
    const eH=q('#endHour').value;
    const eM=q('#endMinute').value;
    const eP=q('#endPeriod').value;

    const start24=convertTo24(sH,sM,sP);
    const end24=convertTo24(eH,eM,eP);
    const displayTime=`${format12From24(start24)} — ${format12From24(end24)}`;

    /* Update existing */
    const existing=types.find(t=>t.name.toLowerCase()===name.toLowerCase());
    if(existing){
      existing.seats=seats;
      existing.total=total;
      existing.price=price;
      existing.cancel=cancel;
      existing.timeStart=start24;
      existing.timeEnd=end24;
      existing.displayTime=displayTime;

      const prevTables=existing.tables||[];
      if(total < prevTables.length){
        const future=prevTables.slice(total).filter(t=>t.status==='reserved');
        if(future.length) return pop('Cannot reduce: reserved exist',true);
      }

      existing.tables=makeTablesArray(total, prevTables);

      const targetUnavail = clamp(total - freeInput,0,total);
      let need=targetUnavail;
      existing.tables.forEach(tb=>{ if(tb.status==='unavailable') tb.status='free'; });
      for(let i=existing.tables.length-1;i>=0 && need>0;i--){
        const tb=existing.tables[i];
        if(tb.status==='free'){ tb.status='unavailable'; need--; }
      }

      saveTypes(); renderTypes();
      pop('Type updated');
      return;
    }

    /* New type */
    const typeObj={
      id:idGen('type'),
      name,seats,total,price,cancel,
      tables:makeTablesArray(total,[]),
      timeStart:start24,
      timeEnd:end24,
      displayTime
    };

    const targetUnavail = clamp(total - freeInput,0,total);
    let need=targetUnavail;
    for(let i=typeObj.tables.length-1;i>=0 && need>0;i--){
      const tb=typeObj.tables[i];
      if(tb.status==='free'){ tb.status='unavailable'; need--; }
    }

    types.push(typeObj);
    saveTypes(); renderTypes();
    pop('Type added');
  });
}

/* --------------------------
   CLEAR TYPES
   -------------------------- */
if(q('#clearTypeBtn')){
  q('#clearTypeBtn').addEventListener('click', ()=>{
    if(!confirm('Clear all table types?')) return;
    types=[]; saveTypes(); renderTypes();
    pop("All types removed");
  });
}

/* --------------------------
   RENDER TYPES
   -------------------------- */
function renderTypes(){
  const box=q('#typeList');
  if(!box) return;
  box.innerHTML='';

  if(!types.length){
    box.innerHTML='<div class="small">No types yet</div>';
    populateUserForm();
    return;
  }

  types.forEach(t=>{
    const freeCount=t.tables.filter(x=>x.status==='free').length;
    const resCount=t.tables.filter(x=>x.status==='reserved').length;
    const unCount=t.tables.filter(x=>x.status==='unavailable').length;

    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${escapeHtml(t.name)}</strong>
          <div class="small">${t.seats} seats</div>
          <div class="small">Total: ${t.total} • Free: ${freeCount} • Reserved: ${resCount} • Unavail: ${unCount}</div>
          <div class="small">Price: ₹${t.price} • Cancel: ${t.cancel} hrs</div>
          <div class="small">Time: ${escapeHtml(t.displayTime)}</div>
        </div>

        <div style="display:flex;gap:6px;flex-direction:column">
          <button class="btn secondary" data-act="edit" data-id="${t.id}">Edit</button>
          <button class="btn secondary" data-act="tables" data-id="${t.id}">Tables</button>
          <button class="btn" data-act="del" data-id="${t.id}">Delete</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  qa('#typeList button').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id=e.target.dataset.id;
      const act=e.target.dataset.act;
      const t=types.find(x=>x.id===id);
      if(!t) return;

      /* Edit */
      if(act==='edit'){
        q('#typeSelect').value=t.name;
        q('#typeSeats').disabled=false;
        q('#typeSeats').value=t.seats;
        q('#typeTotal').value=t.total;
        q('#typeFree').value=t.tables.filter(x=>x.status==='free').length;
        q('#typePrice').value=t.price;
        q('#typeCancel').value=t.cancel;

        /* Times */
        const [sh,sm]=t.timeStart.split(':');
        const [eh,em]=t.timeEnd.split(':');

        let shH=parseInt(sh), shM=parseInt(sm);
        let ehH=parseInt(eh), ehM=parseInt(em);

        let sPeriod=(shH>=12?'PM':'AM');
        let ePeriod=(ehH>=12?'PM':'AM');

        let s12=shH%12; if(s12===0) s12=12;
        let e12=ehH%12; if(e12===0) e12=12;

        q('#startHour').value=s12;
        q('#startMinute').value=shM;
        q('#startPeriod').value=sPeriod;

        q('#endHour').value=e12;
        q('#endMinute').value=ehM;
        q('#endPeriod').value=ePeriod;

        window.scrollTo({top:0, behavior:'smooth'});
      }

      /* Delete */
      if(act==='del'){
        if(!confirm('Delete this type?')) return;
        const reserved=t.tables.filter(x=>x.status==='reserved');
        if(reserved.length) return pop('Cannot delete: reserved tables exist',true);
        types=types.filter(x=>x.id!==id);
        saveTypes(); renderTypes();
        pop('Deleted');
      }

      /* Tables Modal */
      if(act==='tables') openTablesModal(id);
    });
  });

  populateUserForm();
}

/* --------------------------
   TABLES MODAL
   -------------------------- */
function openTablesModal(typeId){
  const t=types.find(x=>x.id===typeId);
  if(!t) return;

  const root=q('#modalRoot');
  if(!root) return;
  root.style.display='block';
  root.innerHTML='';

  const mb=document.createElement('div');
  mb.className='modal-back';

  const md=document.createElement('div');
  md.className='modal';
  md.innerHTML=`
    <h3>Tables — ${escapeHtml(t.name)}</h3>
    <div class="small">Click free/unavailable to toggle. Reserved cannot change.</div>
    <div id="modalTableGrid" class="table-grid" style="margin-top:10px"></div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="closeModal" class="btn secondary">Close</button>
      <button id="markAllFree" class="btn secondary">Mark All Free</button>
    </div>
  `;

  mb.appendChild(md);
  root.appendChild(mb);

  const grid=md.querySelector('#modalTableGrid');

  function renderGrid(){
    grid.innerHTML='';
    t.tables.forEach(tb=>{
      const d=document.createElement('div');
      d.className='table-cell';
      d.textContent=tb.num;

      if(tb.status==='free') d.classList.add('cell-free');
      if(tb.status==='reserved') d.classList.add('cell-reserved');
      if(tb.status==='unavailable') d.classList.add('cell-unavail');

      d.addEventListener('click', ()=>{
        if(tb.status==='reserved') return pop('Reserved table',true);
        tb.status=(tb.status==='free')?'unavailable':'free';
        saveTypes();
        renderTypes();
        renderGrid();
      });

      grid.appendChild(d);
    });
  }

  renderGrid();

  md.querySelector('#closeModal').addEventListener('click', ()=>{
    root.style.display='none';
    root.innerHTML='';
  });

  md.querySelector('#markAllFree').addEventListener('click', ()=>{
    t.tables.forEach(tb=>{ if(tb.status!=='reserved') tb.status='free'; });
    saveTypes(); renderTypes(); renderGrid();
  });
}

/* --------------------------
   SLOTS
   -------------------------- */
/* use local slots variable and key k_slots(vendor) */
function renderSlots(){
  const box=q('#slotList');
  if(!box) return;
  box.innerHTML='';

  // ensure slots array up-to-date from storage for current vendor
  if(vendor) slots = JSON.parse(localStorage.getItem(k_slots(vendor)) || '[]');

  if(!slots.length){
    box.innerHTML='<div class="small">No slots</div>';
    populateUserForm();
    return;
  }

  slots.forEach(s=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${escapeHtml(s.name)}</strong>
          <div class="small">${format12From24(s.start)} — ${format12From24(s.end)}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn secondary" data-act="edit" data-id="${s.id}">Edit</button>
          <button class="btn" data-act="del" data-id="${s.id}">Delete</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  qa('#slotList button').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id=e.target.dataset.id;
      const act=e.target.dataset.act;

      if(act==='del'){
        if(!confirm('Delete slot?')) return;
        slots=slots.filter(x=>x.id!==id);
        saveSlots(); renderSlots();
      }

      if(act==='edit'){
        const s=slots.find(x=>x.id===id);
        if(!s) return;
        q('#slotName').value=s.name;

        // convert 24h back to 12h components for edit
        const [sh,sm] = s.start.split(':').map(Number);
        const [eh,em] = s.end.split(':').map(Number);

        let sPeriod = sh >= 12 ? 'PM' : 'AM';
        let ePeriod = eh >= 12 ? 'PM' : 'AM';
        let s12 = sh % 12; if(s12 === 0) s12 = 12;
        let e12 = eh % 12; if(e12 === 0) e12 = 12;

        q('#startHourSlot').value = s12;
        q('#startMinSlot').value = sm;
        q('#startPeriodSlot').value = sPeriod;

        q('#endHourSlot').value = e12;
        q('#endMinSlot').value = em;
        q('#endPeriodSlot').value = ePeriod;

        // remove the slot from array so add will replace it
        slots = slots.filter(x=>x.id!==id);
        saveSlots();
        renderSlots();
      }
    });
  });

  populateUserForm();
}

/* Robust Add Slot handler (works with AM/PM) */
(function attachAddSlotHandler(){
  const addBtn = q('#addSlotBtn');
  if(!addBtn){
    console.warn('Add Slot button not found (#addSlotBtn)');
    return;
  }

  addBtn.addEventListener('click', ()=>{
    if(!vendor) return pop('Set vendor first',true);

    const name = (q('#slotName') && q('#slotName').value.trim()) || '';
    const sh = (q('#startHourSlot') && q('#startHourSlot').value.trim()) || '';
    const sm = (q('#startMinSlot') && q('#startMinSlot').value.trim()) || '';
    const sp = (q('#startPeriodSlot') && q('#startPeriodSlot').value) || 'AM';

    const eh = (q('#endHourSlot') && q('#endHourSlot').value.trim()) || '';
    const em = (q('#endMinSlot') && q('#endMinSlot').value.trim()) || '';
    const ep = (q('#endPeriodSlot') && q('#endPeriodSlot').value) || 'AM';

    if(!name) return pop('Enter slot name', true);
    if(!sh || !sm || !eh || !em) return pop('Enter start and end time', true);

    const shN = Number(sh), smN = Number(sm), ehN = Number(eh), emN = Number(em);
    if(isNaN(shN) || isNaN(smN) || isNaN(ehN) || isNaN(emN)) return pop('Invalid time numbers', true);
    if(shN < 1 || shN > 12 || ehN < 1 || ehN > 12 || smN < 0 || smN > 59 || emN < 0 || emN > 59) return pop('Time out of range', true);

    const start24 = convertTo24(shN, smN, sp);
    const end24 = convertTo24(ehN, emN, ep);

    if(!start24 || !end24) return pop('Invalid time conversion', true);

    // ensure slots list loaded
    if(vendor) slots = JSON.parse(localStorage.getItem(k_slots(vendor)) || '[]');

    const newSlot = { id: idGen('slot'), name, start: start24, end: end24 };
    slots.push(newSlot);
    if(vendor) localStorage.setItem(k_slots(vendor), JSON.stringify(slots));

    renderSlots();
    pop('Slot added');

    // clear inputs
    q('#slotName').value = '';
    q('#startHourSlot').value = '';
    q('#startMinSlot').value = '';
    q('#endHourSlot').value = '';
    q('#endMinSlot').value = '';
  });
})();

/* --------------------------
   SETTINGS
   -------------------------- */
if(q('#saveSettings')){
  q('#saveSettings').addEventListener('click', ()=>{
    settings.maxAdvanceDays=Number(q('#maxAdvance').value)||365;
    settings.cancelBeforeHrs=Number(q('#cancelBeforeHrs').value)||2;
    saveSettings();
    pop("Settings saved");
  });
}

/* --------------------------
   BOOKINGS
   -------------------------- */
function renderBookings(){
  const list=q('#bookingsList');
  if(!list) return;
  list.innerHTML='';

  bookings = JSON.parse(localStorage.getItem(k_bookings(vendor)) || '[]');

  if(!bookings.length){
    list.innerHTML='<div class="small">No bookings</div>';
    return;
  }

  bookings
    .slice()
    .sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))
    .forEach(b=>{
      const div=document.createElement('div');
      div.className='card';
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${escapeHtml(b.customer)}</strong>
            <div class="small">${b.phone || ''} • ${b.typeName || ''}</div>
            <div class="small">${b.date || ''} • ${escapeHtml(b.slotName || '')} • Tables: ${b.tables ? b.tables.join(', ') : ''}</div>
            <div class="small">₹${b.price || 0} • ${b.status || ''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="btn secondary" data-act="view" data-id="${b.id}">View</button>
            <button class="btn" data-act="toggle" data-id="${b.id}">
              ${b.status==='cancelled'?'Restore':'Cancel'}
            </button>
          </div>
        </div>
      `;
      list.appendChild(div);
    });

  qa('#bookingsList button').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id=e.target.dataset.id;
      const act=e.target.dataset.act;

      if(act==='view'){
        alert(JSON.stringify(bookings.find(x=>x.id===id), null, 2));
      }
      if(act==='toggle') toggleBooking(id);
    });
  });
}

function toggleBooking(id){
  bookings = JSON.parse(localStorage.getItem(k_bookings(vendor)) || '[]');
  const b=bookings.find(x=>x.id===id);
  if(!b) return;

  types = JSON.parse(localStorage.getItem(k_types(vendor)) || '[]');
  const t=types.find(x=>x.id===b.typeId);
  if(!t) return pop("Type missing", true);

  if(b.status==='upcoming'){
    if(!canCancelBooking(b)) return pop("Too late to cancel", true);

    b.status='cancelled';

    /* free tables */
    b.tables.forEach(n=>{
      const tb=t.tables.find(x=>x.num===n);
      if(tb && tb.bookingId===b.id){
        tb.status='free';
        tb.bookingId=null;
      }
    });

  } else {

    b.status='upcoming';

    /* re-reserve */
    b.tables.forEach(n=>{
      const tb=t.tables.find(x=>x.num===n);
      if(tb && tb.status==='free'){
        tb.status='reserved';
        tb.bookingId=b.id;
      }
    });
  }

  // save both types and bookings
  saveTypes();
  localStorage.setItem(k_bookings(vendor), JSON.stringify(bookings));
  renderBookings();
  renderStats();
}

function canCancelBooking(b){
  const hrs=settings.cancelBeforeHrs||0;
  const eventTime=new Date(b.datetimeISO).getTime();
  return Date.now() <= (eventTime - hrs*3600*1000);
}

/* --------------------------
   STATS
   -------------------------- */
function renderStats(){
  types = JSON.parse(localStorage.getItem(k_types(vendor)) || '[]');
  bookings = JSON.parse(localStorage.getItem(k_bookings(vendor)) || '[]');

  const totalTables = types.reduce((s,t)=>s+(t.tables? t.tables.length : 0),0);
  q('#dashStats').innerHTML =
    `Table Types: <b>${types.length}</b><br>`+
    `Total Tables: <b>${totalTables}</b><br>`+
    `Upcoming Bookings: <b>${bookings.filter(x=>x.status==='upcoming').length}</b>`;
}

/* --------------------------
   USER SIMULATOR
   -------------------------- */
if(q('#loadVendorData')){
  q('#loadVendorData').addEventListener('click', ()=>{
    const v=q('#userVendor').value.trim();
    if(!v) return pop("Enter vendor email", true);
    vendor=v;
    q('#vendorEmail').value=v;
    loadAll();
  });
}

/* load rest name placeholder */
const rn = localStorage.getItem(k_restName(vendor)) || "";
if (rn && q('#userVendor')) {
    q('#userVendor').placeholder = rn;
}

function populateUserForm(){
  const selT=q('#typeSelectUser');
  if(!selT) return;

  types = JSON.parse(localStorage.getItem(k_types(vendor)) || '[]');
  slots = JSON.parse(localStorage.getItem(k_slots(vendor)) || '[]');

  selT.innerHTML='';
  types.forEach(t=>{
    const o=document.createElement('option');
    o.value=t.id;
    o.text=`${t.name} — ₹${t.price}`;
    selT.appendChild(o);
  });

  const selS=q('#slotSelect');
  if(selS) selS.innerHTML='';
  slots.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id;
    o.text=`${s.name} (${s.start}-${s.end})`;
    selS.appendChild(o);
  });

  if(q('#userForm')) q('#userForm').style.display = types.length ? 'block':'none';
  if(q('#date')) q('#date').value = new Date().toISOString().slice(0,10);

  updatePriceDisplay();
}

if(q('#typeSelectUser')){
  q('#typeSelectUser').addEventListener('change', updatePriceDisplay);
}

function updatePriceDisplay(){
  const id = q('#typeSelectUser') ? q('#typeSelectUser').value : null;
  const t=types.find(x=>x.id===id);
  if(q('#price')) q('#price').value = t ? t.price : '';
}

/* BOOK NOW */
if(q('#bookNow')){
  q('#bookNow').addEventListener('click', ()=>{

    const typeId=q('#typeSelectUser').value;
    const slotId=q('#slotSelect').value;
    const date=q('#date').value;
    const customer=q('#name').value.trim() || 'Guest';
    const phone=q('#phone').value.trim() || '';
    const count=Number(q('#numTables').value||1);

    if(!typeId||!slotId||!date) return pop('Fill all fields',true);

    // reload from storage to ensure most recent
    types=JSON.parse(localStorage.getItem(k_types(vendor))||'[]');
    slots=JSON.parse(localStorage.getItem(k_slots(vendor))||'[]');
    bookings=JSON.parse(localStorage.getItem(k_bookings(vendor))||'[]');

    const t=types.find(x=>x.id===typeId);
    const s=slots.find(x=>x.id===slotId);

    if(!t) return pop('Type not available',true);
    if(!s) return pop('Slot not available',true);

    const today=new Date(new Date().toISOString().slice(0,10));
    const d=new Date(date);
    const diffDays=(d - today)/(1000*3600*24);

    if(diffDays<0) return pop('Past date not allowed',true);
    if(diffDays > settings.maxAdvanceDays) return pop('Exceeds max advance days',true);

    const freeTables=t.tables.filter(x=>x.status==='free');
    if(count > freeTables.length) return pop('Not enough free tables',true);

    const take=freeTables.slice(0,count).map(x=>x.num);
    const id=idGen('bk');

    take.forEach(n=>{
      const tb=t.tables.find(x=>x.num===n);
      tb.status='reserved';
      tb.bookingId=id;
    });

    const isoTimePart = (s.start.length===5) ? s.start : (s.start + ":00");
    const ISO=new Date(date+'T'+isoTimePart).toISOString();

    const booking={
      id,
      customer,
      phone,
      typeId:t.id,
      typeName:t.name,
      tables:take,
      date,
      slotName:s.name,
      datetimeISO:ISO,
      price:t.price*count,
      count,
      status:'upcoming',
      createdAt:new Date().toISOString()
    };

    bookings.push(booking);
    saveTypes(); saveBookings();

    renderBookings(); renderStats();
    pop("Booking created");
  });
}

/* --------------------------
   LOCATION
   -------------------------- */
if(q('#saveLocationBtn')){
  q('#saveLocationBtn').addEventListener('click', ()=>{
    locationObj={
      addr1:q('#addr1').value.trim(),
      addr2:q('#addr2').value.trim(),
      city:q('#city').value.trim(),
      state:q('#state').value.trim(),
      pincode:q('#pincode').value.trim()
    };
    saveLocation();
    renderLocation();
    pop("Location saved");
  });
}

function renderLocation(){
  if(!locationObj || !locationObj.addr1){
    if(q('#locInfo')) q('#locInfo').textContent='';
    return;
  }

  q('#addr1').value=locationObj.addr1 || '';
  q('#addr2').value=locationObj.addr2 || '';
  q('#city').value=locationObj.city || '';
  q('#state').value=locationObj.state || '';
  q('#pincode').value=locationObj.pincode || '';

  q('#locInfo').textContent =
    `${locationObj.addr1}, ${locationObj.city}, ${locationObj.state} - ${locationObj.pincode}`;
}

/* --------------------------
   INIT
   -------------------------- */
(function(){
  // If vendor is already present, make sure UI reflects it
  if(vendor){
    loadAll();
  } else {
    // also try to prefill vendor from last saved key
    vendor = localStorage.getItem('tb_vendor') || '';
    if(vendor){
      if(q('#vendorEmail')) q('#vendorEmail').value = vendor;
      loadAll();
    }
  }

  if(q('#maxAdvance')) q('#maxAdvance').value=settings.maxAdvanceDays;
  if(q('#cancelBeforeHrs')) q('#cancelBeforeHrs').value=settings.cancelBeforeHrs;
})();
</script>

</body>
</html>
