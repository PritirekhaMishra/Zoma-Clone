<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZomaClone | Add Delivery Address</title>

<link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
:root{
  --red:#e23744;
  --light:#fafafa;
  --white:#fff;
  --muted:#777;
  --shadow:0 6px 20px rgba(0,0,0,0.08);
  --radius:14px;
  font-family:"Poppins", sans-serif;
}
body{
  margin:0;
  background:var(--light);
  padding:20px;
}
.container{
  max-width:850px;
  margin:auto;
  background:var(--white);
  padding:22px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.section-title{
  font-size:20px;
  font-weight:700;
  color:var(--red);
  margin-bottom:6px;
}
.section-sub{
  font-size:13px;
  color:var(--muted);
  margin-bottom:14px;
}
.input{
  width:100%;
  padding:11px;
  border:1px solid #e1e1e1;
  border-radius:10px;
  margin-bottom:10px;
  font-size:14px;
}
.label{
  font-size:13px;
  margin-bottom:3px;
  color:#333;
}
.btn{
  padding:12px 18px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:15px;
}
.btn-red{
  background:var(--red);
  color:white;
}
.btn-light{
  background:#fff;
  border:1px solid #ddd;
}
.row{
  display:flex;
  gap:10px;
}
.row > div{
  flex:1;
}
#map{
  height:230px;
  border-radius:12px;
  margin-top:12px;
  border:1px solid #ddd;
}
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:var(--red);
  padding:10px 14px;
  color:white;
  border-radius:10px;
  display:none;
  font-size:13px;
}
@media(max-width:700px){
  body{padding:10px;}
  .row{flex-direction:column;}
}
</style>
</head>
<body>

<div class="container">

  <div class="section-title">Add Delivery Address</div>
  <div class="section-sub">
    We‚Äôll use this to show restaurants that deliver to you.
  </div>

  <!-- Detect location -->
  <button id="detectBtn" class="btn btn-red">üìç Detect my current location</button>
  <span style="font-size:12px;color:var(--muted);margin-left:6px;">
    (Allow location permission)
  </span>

  <div id="locationText" style="margin-top:10px;color:var(--muted)">
    No location detected yet.
  </div>

  <!-- Address form -->
  <div style="margin-top:18px;font-size:14px;font-weight:600;color:#333;">
    Confirm or edit your address details
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <div class="label">Area / Locality</div>
      <input id="area" class="input" placeholder="e.g. Jagamara">
    </div>
    <div>
      <div class="label">City</div>
      <input id="city" class="input" placeholder="e.g. Bhubaneswar">
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">State</div>
      <input id="state" class="input" placeholder="e.g. Odisha">
    </div>
    <div>
      <div class="label">Pincode</div>
      <input id="pincode" class="input" placeholder="e.g. 751030">
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">Country</div>
      <input id="country" class="input" placeholder="e.g. India">
    </div>
  </div>

  <div class="row" style="margin-top:4px">
    <div>
      <div class="label">House / Plot / Flat No.</div>
      <input id="plot" class="input" placeholder="e.g. Plot 123, 2nd Floor">
    </div>
    <div>
      <div class="label">Landmark / Nearby</div>
      <input id="landmark" class="input" placeholder="e.g. Near Jagamara Square">
    </div>
  </div>

  <button id="saveAddressBtn" class="btn btn-red" style="margin-top:10px">
    Save Address & Continue
  </button>

  <div id="map"></div>

</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------- Toast ---------- */
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",1600);
}

/* ---------- Get current user from localStorage ---------- */
function getCurrentUser(){
  // support both keys if you use different ones in other pages
  const keys = ["currentUser","zoma_user"];
  for(const k of keys){
    const raw = localStorage.getItem(k);
    if(!raw) continue;
    try{ return [k, JSON.parse(raw)]; }catch(e){ return [k,null]; }
  }
  return [null,null];
}

let [userKey, user] = getCurrentUser();

if(!user){
  alert("Please login / signup first.");
  window.location.href = "login.html";
}

/* ---------- Map Setup ---------- */
let map = L.map("map").setView([20.2961, 85.8245], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker = null;

function setMarker(lat, lon, label){
  if(!marker){
    marker = L.marker([lat,lon]).addTo(map).bindPopup(label).openPopup();
  }else{
    marker.setLatLng([lat,lon]).bindPopup(label).openPopup();
  }
  map.setView([lat,lon], 15);
}

/* ---------- Reverse Geocode ---------- */
async function reverseGeo(lat,lon){
  try{
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`
    );
    const j = await r.json();

    const addr = j.address || {};
    // Try to pick best possible locality field
    const area   = addr.suburb || addr.neighbourhood || addr.village || addr.town || "";
    const city   = addr.city || addr.town || addr.village || "";
    const state  = addr.state || "";
    const pin    = addr.postcode || "";
    const country= addr.country || "";
    const display= j.display_name || `${lat}, ${lon}`;

    return { display, area, city, state, pin, country };
  }catch(e){
    console.error("Reverse geo error",e);
    return { display: lat+","+lon, area:"",city:"",state:"",pin:"",country:"" };
  }
}

/* ---------- Detect My Location ---------- */
document.getElementById("detectBtn").onclick = () => {
  if(!navigator.geolocation){
    showToast("Location not supported in this browser");
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    const info = await reverseGeo(lat,lon);

    document.getElementById("locationText").textContent = info.display;

    // fill form fields
    document.getElementById("area").value    = info.area;
    document.getElementById("city").value    = info.city;
    document.getElementById("state").value   = info.state;
    document.getElementById("pincode").value = info.pin;
    document.getElementById("country").value = info.country;

    // store raw location for later
    localStorage.setItem("zoma_detected_location", JSON.stringify({
      lat, lon,
      area: info.area,
      city: info.city,
      state: info.state,
      pincode: info.pin,
      country: info.country,
      display: info.display
    }));

    setMarker(lat,lon, info.display);
  }, err => {
    console.error(err);
    showToast("Unable to access location");
  });
};

/* ---------- Save Address ---------- */
document.getElementById("saveAddressBtn").onclick = () => {
  const area     = document.getElementById("area").value.trim();
  const city     = document.getElementById("city").value.trim();
  const state    = document.getElementById("state").value.trim();
  const pincode  = document.getElementById("pincode").value.trim();
  const country  = document.getElementById("country").value.trim();
  const plot     = document.getElementById("plot").value.trim();
  const landmark = document.getElementById("landmark").value.trim();

  if(!area || !city || !state || !pincode || !country){
    showToast("Fill all main address fields");
    return;
  }

  const locRaw = JSON.parse(localStorage.getItem("zoma_detected_location") || "null");

  const fullAddress =
    (plot ? plot + ", " : "") +
    (landmark ? landmark + ", " : "") +
    area + ", " + city + " - " + pincode + ", " + state + ", " + country;

  user.address = {
    full: fullAddress,
    plot,
    landmark,
    area,
    city,
    state,
    pincode,
    country,
    lat: locRaw?.lat || null,
    lon: locRaw?.lon || null
  };

  if(userKey){
    localStorage.setItem(userKey, JSON.stringify(user));
  }
  // also keep a common key if you use elsewhere
  localStorage.setItem("zoma_user", JSON.stringify(user));
  localStorage.setItem("currentUser", JSON.stringify(user));

  showToast("Address saved ‚úÖ");

  setTimeout(() => {
    // go to ordering page
    window.location.href = "order.html";
  }, 900);
};
</script>

</body>
</html>
