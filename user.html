<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZomaClone | User Settings</title>

<link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
:root{
  --red:#e23744;
  --light:#fafafa;
  --white:#fff;
  --muted:#777;
  --shadow:0 6px 20px rgba(0,0,0,0.08);
  --radius:14px;
  font-family:"Poppins", sans-serif;
}
body{
  margin:0;
  background:var(--light);
  padding:20px;
}
.container{
  max-width:850px;
  margin:auto;
  background:var(--white);
  padding:22px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}
.section-title{
  font-size:20px;
  font-weight:700;
  color:var(--red);
  margin-bottom:14px;
}
.input{
  width:100%;
  padding:12px;
  border:1px solid #e1e1e1;
  border-radius:10px;
  margin-bottom:12px;
  font-size:15px;
}
.btn{
  padding:12px 18px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:15px;
}
.btn-red{
  background:var(--red);
  color:white;
}
.btn-outline{
  background:white;
  border:1px solid #ddd;
}
.flex{
  display:flex;
  gap:14px;
}
#map{
  height:240px;
  border-radius:12px;
  margin-top:12px;
  border:1px solid #ddd;
}
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:var(--red);
  padding:10px 14px;
  color:white;
  border-radius:10px;
  display:none;
}
</style>
</head>

<body>

<script>
// ---------------- LOGIN CHECK ----------------
if (localStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "login.html";
}

// Load current user
let user = JSON.parse(localStorage.getItem("currentUser") || "null");

if (!user) {
    window.location.href = "login.html";
}
</script>

<div class="container">

  <div class="section-title">Edit Profile</div>

  <input id="name" class="input" placeholder="Full Name">
  <input id="email" class="input" placeholder="Email">
  <input id="phone" class="input" placeholder="Phone Number">

  <button id="saveProfileBtn" class="btn btn-red">Save Profile</button>

  <hr style="margin:26px 0;border:none;border-top:1px solid #eee">

  <div class="section-title">Your Address</div>

  <button id="detectBtn" class="btn btn-red">üìç Detect My Location</button>

  <div id="locationText" style="margin-top:10px;color:var(--muted)">No location detected</div>

  <div class="flex" style="margin-top:12px">
    <input id="plot" class="input" placeholder="Plot / House No.">
    <input id="landmark" class="input" placeholder="Nearby Landmark">
  </div>

  <button id="saveAddressBtn" class="btn btn-red" style="margin-top:8px">Save Address & Continue</button>

  <div id="map"></div>

</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ---------------- Toast ----------------
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.style.display="block";
  setTimeout(()=>t.style.display="none",1500);
}

// ---------------- Autofill Profile ----------------
window.onload = () => {
    document.getElementById("name").value = user.name || "";
    document.getElementById("email").value = user.email || "";
    document.getElementById("phone").value = user.phonenumber || user.phone || "";
};

// ---------------- Save Profile ----------------
document.getElementById("saveProfileBtn").onclick = () => {
  user.name = document.getElementById("name").value.trim();
  user.email = document.getElementById("email").value.trim();
  user.phone = document.getElementById("phone").value.trim();

  if(!user.name || !user.email || !user.phone){
    showToast("All fields required");
    return;
  }

  localStorage.setItem("currentUser", JSON.stringify(user));
  showToast("Profile Updated ‚úî");

  setTimeout(()=> window.location.href="order.html",800);
};

// ---------------- Map Setup ----------------
let map = L.map("map").setView([20.2961, 85.8245], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker = null;

function setMarker(lat, lon, label){
  if(!marker){
    marker = L.marker([lat,lon]).addTo(map).bindPopup(label).openPopup();
  } else {
    marker.setLatLng([lat,lon]).bindPopup(label).openPopup();
  }
  map.setView([lat,lon], 15);
}

// ---------------- Reverse Geocode ----------------
async function reverseGeo(lat,lon){
  try{
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`
    );
    const j = await r.json();
    return j.display_name;
  }catch(e){
    return lat + "," + lon;
  }
}

// ---------------- Detect My Location ----------------
document.getElementById("detectBtn").onclick = () => {
  if(!navigator.geolocation){
    showToast("Location not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    let lat = pos.coords.latitude;
    let lon = pos.coords.longitude;

    let locName = await reverseGeo(lat, lon);

    document.getElementById("locationText").textContent = locName;

    localStorage.setItem("zoma_detected_location", JSON.stringify({
      lat, lon, name: locName
    }));

    setMarker(lat, lon, locName);
  });
};

// ---------------- Save Address ----------------
document.getElementById("saveAddressBtn").onclick = () => {
  let saved = JSON.parse(localStorage.getItem("zoma_detected_location") || "null");

  if(!saved){
    showToast("Detect your location first");
    return;
  }

  let plot = document.getElementById("plot").value.trim();
  let landmark = document.getElementById("landmark").value.trim();

  let finalAddress =
    (plot ? plot+", " : "") +
    (landmark ? landmark+", " : "") +
    saved.name;

  user.address = finalAddress;
  localStorage.setItem("currentUser", JSON.stringify(user));

  showToast("Address Saved ‚úî");

  setTimeout(() => window.location.href = "order.html", 800);
};
</script>

</body>
</html>
