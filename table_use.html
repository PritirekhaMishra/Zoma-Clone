<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book a Table | ZomaClone</title>
  <link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">

  <style>
    :root {
      --accent:#e53935;
      --accent-soft:#ff6b6b;
      --bg:#fff7f7;
      --card:#ffffff;
      --text:#222;
      --muted:#6b6b6b;
      --border:#eee;
      --shadow-soft:0 18px 40px rgba(0,0,0,0.06);
      --green:#0f9d58;
      --red:#d93025;
      --radius:14px;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", Arial, sans-serif;
      background:linear-gradient(180deg,#fff7f7,#ffffff);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }
    a { color:inherit; text-decoration:none; }

    .page {
      max-width:1200px;
      margin:24px auto;
      padding:0 16px 32px;
    }

    /* Top Bar */
    .top-bar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    .top-brand {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-dot {
      width:32px;
      height:32px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--accent),var(--accent-soft));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      font-size:18px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
    .brand-name {
      font-weight:800;
      font-size:18px;
    }
    .chip-small {
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.08);
      background:#fff;
      color:var(--muted);
    }

    /* Banner */
    .banner {
      position:relative;
      border-radius:18px;
      overflow:hidden;
      min-height:180px;
      margin-bottom:20px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(0,0,0,0.05);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }
    .banner-overlay {
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.7));
    }
    .banner-content {
      position:relative;
      z-index:1;
      padding:18px;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      color:#fff;
    }
    .rest-name {
      font-size:22px;
      font-weight:800;
    }
    .rest-meta {
      margin-top:6px;
      font-size:13px;
      opacity:0.95;
    }
    .rest-tags {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:11px;
    }
    .pill {
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.25);
      backdrop-filter:blur(6px);
    }

    /* Layout */
    .grid {
      display:grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr);
      gap:22px;
    }
    @media (max-width:960px) {
      .grid { grid-template-columns: minmax(0,1fr); }
    }

    .card {
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(0,0,0,0.04);
    }
    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    h2 {
      margin:0;
      font-size:18px;
    }
    .hint {
      font-size:13px;
      color:var(--muted);
    }

    label {
      display:block;
      margin-top:10px;
      font-size:13px;
      font-weight:500;
      color:#333;
    }
    input[type="text"],
    input[type="tel"],
    input[type="date"],
    select,
    textarea {
      width:100%;
      margin-top:6px;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fafafa;
      font-size:14px;
      outline:none;
      transition:border .15s, box-shadow .15s, background .15s;
      resize:vertical;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(229,57,53,0.15);
      background:#fff;
    }

    .row {
      display:flex;
      gap:12px;
      margin-top:4px;
    }
    .col { flex:1; min-width:0; }

    .btn {
      border:0;
      outline:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:700;
      font-size:14px;
      background:linear-gradient(90deg,var(--accent),var(--accent-soft));
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn.secondary {
      background:#fff;
      color:var(--muted);
      border:1px solid var(--border);
      box-shadow:none;
    }
    .btn.full { width:100%; }
    .btn[disabled] {
      opacity:.6;
      cursor:default;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      background:#fff6f6;
      color:var(--accent);
      border:1px solid rgba(229,57,53,0.26);
    }

    /* Tables grid */
    .tables-grid {
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .table-chip {
      min-width:90px;
      padding:10px;
      border-radius:12px;
      border:1px solid #eee;
      background:#fff;
      font-size:12px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
    }
    .table-chip-title {
      font-weight:700;
      font-size:13px;
    }
    .tag {
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .tag-free {
      background:#eaffea;
      color:var(--green);
    }
    .tag-reserved {
      background:#fff3f3;
      color:var(--red);
    }
    .tag-unavail {
      background:#f3f4f6;
      color:#555;
    }

    .price-line {
      font-weight:800;
      color:var(--accent);
      margin-top:8px;
    }
    .error-text {
      margin-top:8px;
      font-size:13px;
      color:var(--red);
      display:none;
    }

    /* Summary */
    .summary-main {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .summary-label {
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .summary-value {
      font-size:13px;
      margin-top:2px;
    }
    .summary-total {
      font-size:22px;
      font-weight:900;
      color:var(--accent);
    }
    .summary-section {
      margin-top:12px;
      padding-top:10px;
      border-top:1px dashed rgba(0,0,0,0.06);
    }

    .upi-box {
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff7f0;
      border:1px dashed rgba(238,138,0,0.6);
      font-size:13px;
    }
    .upi-id {
      font-weight:700;
    }

    .sticky {
      position:sticky;
      top:18px;
    }

    /* Reviews */
    .rating-header {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .rating-score {
      font-size:20px;
      font-weight:900;
      color:var(--green);
    }
    .stars {
      color:#f3c623;
      font-size:16px;
    }
    .review-list {
      margin-top:10px;
      max-height:260px;
      overflow:auto;
      border-radius:10px;
      border:1px solid #f1f1f1;
      background:#fff;
    }
    .review-item {
      padding:10px 12px;
      border-bottom:1px solid #f5f5f5;
      font-size:13px;
    }
    .review-item:last-child { border-bottom:none; }
    .review-name {
      font-weight:600;
      margin-bottom:2px;
    }
    .review-meta {
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }

    /* Modals */
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(10,10,10,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal {
      background:#fff;
      border-radius:14px;
      padding:18px;
      max-width:480px;
      width:94%;
      box-shadow:0 24px 60px rgba(0,0,0,0.25);
    }
    .modal h3 {
      margin:0 0 6px 0;
      font-size:18px;
    }
    .modal-actions {
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .star-input {
      display:flex;
      gap:4px;
      font-size:22px;
      cursor:pointer;
      margin-top:6px;
    }
    .star-input span {
      filter:drop-shadow(0 1px 1px rgba(0,0,0,0.1));
    }

    .pill-small {
      display:inline-block;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:#f3f4f6;
      color:#555;
    }

    .empty {
      padding:10px;
      font-size:13px;
      color:var(--muted);
      text-align:center;
    }

    .loading-bar {
      height:3px;
      width:100%;
      background:linear-gradient(90deg,rgba(0,0,0,0.02),rgba(0,0,0,0.08));
      border-radius:999px;
      overflow:hidden;
      margin-bottom:10px;
    }
    .loading-bar-inner {
      width:40%;
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--accent-soft));
      animation:loadingMove 1.2s infinite;
    }
    @keyframes loadingMove {
      0% { transform:translateX(-100%); }
      100% { transform:translateX(250%); }
    }

    /* QR + UPI layout in modal */
    .upi-layout {
      display:flex;
      gap:16px;
      margin-top:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .upi-qr-box {
      width:220px;
      height:220px;
      border-radius:12px;
      border:1px solid #eee;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
    }
    .upi-qr-box img {
      max-width:100%;
      max-height:100%;
    }
    .upi-side {
      flex:1;
      min-width:180px;
      font-size:13px;
      color:var(--muted);
    }
    .upi-side input {
      margin-top:6px;
    }
    .mini-text {
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
  </style>
</head>
<body>
<div class="page">
  <!-- Top bar -->
  <header class="top-bar">
    <div class="top-brand">
      <div class="logo-dot">Z</div>
      <div>
        <div class="brand-name">ZomaClone Tables</div>
        <div class="hint">Reserve a table instantly with your favourite cafÃ©</div>
      </div>
    </div>
    <div class="chip-small" id="vendorInfoChip">Loading restaurantâ€¦</div>
  </header>

  <!-- Banner -->
  <section id="banner" class="banner">
    <div class="banner-overlay"></div>
    <div class="banner-content">
      <div class="rest-name" id="restName">Restaurant</div>
      <div class="rest-meta" id="restAddress">Address</div>
      <div class="rest-meta" id="restCity">City</div>
      <div class="rest-tags">
        <div class="pill" id="bannerBookingInfo">Live bookings enabled</div>
        <div class="pill" id="bannerAdvanceInfo">Advance up to 30 days</div>
      </div>
    </div>
  </section>

  <div class="loading-bar" id="loadingBar">
    <div class="loading-bar-inner"></div>
  </div>

  <main class="grid">
    <!-- LEFT: booking form + tables -->
    <section>
      <div class="card" id="bookingCard">
        <div class="card-header">
          <div>
            <h2>Book your table</h2>
            <div class="hint" id="bookingHint">Pick date, time slot and how many tables you need.</div>
          </div>
          <span class="badge" id="liveStatus">Connectingâ€¦</span>
        </div>

        <div class="row">
          <div class="col">
            <label for="custName">Full name</label>
            <input id="custName" type="text" placeholder="Your name" />
          </div>
          <div class="col">
            <label for="custPhone">Phone number</label>
            <input id="custPhone" type="tel" placeholder="10-digit phone" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="dateInput">Date</label>
            <input id="dateInput" type="date" />
            <div class="hint" id="dateHint"></div>
          </div>
          <div class="col">
            <label for="slotSelect">Time / Slot</label>
            <select id="slotSelect"></select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="typeSelect">Table type</label>
            <select id="typeSelect"></select>
          </div>
          <div class="col">
            <label for="tableCountInput">Number of tables</label>
            <input id="tableCountInput" type="number" min="1" value="1" />
            <div class="hint" id="freeCountHint">â€”</div>
          </div>
        </div>

        <div style="margin-top:14px;">
          <div class="card-header" style="margin-bottom:4px;padding:0;border:none;box-shadow:none">
            <h2 style="font-size:15px;">Live table layout</h2>
            <span class="pill-small">View free / reserved / unavailable (for selected date & slot)</span>
          </div>
          <div class="tables-grid" id="tablesGrid"></div>
        </div>

        <div class="price-line" id="priceLine">â‚¹0</div>
        <div class="error-text" id="formError"></div>

        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
          <button id="confirmBtn" class="btn">Confirm booking</button>
          <button id="resetBtn" class="btn secondary">Reset</button>
        </div>
      </div>

      <!-- Reviews card -->
      <div class="card" style="margin-top:18px;">
        <div class="card-header">
          <div class="rating-header">
            <span class="rating-score" id="avgRating">â€“</span>
            <div>
              <div class="summary-label">Ratings</div>
              <div class="hint" id="ratingCountHint">No reviews yet</div>
            </div>
          </div>
          <button id="openReviewBtn" class="btn secondary" style="font-size:13px;padding:7px 11px;">Write a review</button>
        </div>

        <div id="reviewList" class="review-list">
          <div class="empty">No reviews yet. Be the first to share your experience.</div>
        </div>
      </div>
    </section>

    <!-- RIGHT: summary & UPI -->
    <aside class="sticky">
      <div class="card">
        <div class="summary-main">
          <div>
            <div class="summary-label">Your plan</div>
            <div class="summary-value" id="sumMain">No selection yet</div>
          </div>
          <div style="text-align:right;">
            <div class="summary-label">Total</div>
            <div class="summary-total" id="sumTotal">â‚¹0</div>
          </div>
        </div>

        <div class="summary-section">
          <div class="summary-label">Customer</div>
          <div class="summary-value" id="sumCust">â€”</div>
        </div>

        <div class="summary-section">
          <div class="summary-label">Date &amp; time</div>
          <div class="summary-value" id="sumDateTime">â€”</div>
        </div>

        <div class="summary-section">
          <div class="summary-label">Tables</div>
          <div class="summary-value" id="sumTables">â€”</div>
        </div>

        <div class="summary-section">
          <div class="summary-label">Restaurant UPI</div>
          <div class="upi-box" id="upiBox">
            <div class="hint" id="upiHint">Loading UPIâ€¦</div>
            <div id="upiValue" class="upi-id"></div>
          </div>
        </div>

        <div class="summary-section">
          <button id="summaryConfirmBtn" class="btn full">Confirm &amp; create booking</button>
        </div>
      </div>
    </aside>
  </main>
</div>

<!-- Booking success + UPI modal -->
<div id="bookingModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Booking confirmed ðŸŽ‰</h3>
    <div class="hint" id="bookingSummaryText"></div>
    <div class="hint" style="margin-top:10px;">
      Thank you for choosing our restaurant.
      Your booking is created successfully.  
      Please complete the payment to the restaurant using UPI.
    </div>

    <!-- UPI payment block -->
    <div id="upiPaymentBlock" style="margin-top:14px; display:none;">
      <div class="summary-label" style="margin-bottom:6px;">Complete payment via UPI</div>
      <div class="hint">Scan the QR with any UPI app, or on mobile tap the button to open your UPI app.</div>

      <div style="margin-top:10px; display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Scan QR (any UPI app)</div>
          <div style="width:210px; height:210px; border-radius:12px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; border:1px solid #eee;">
            <img id="upiQrImg" alt="UPI QR" style="max-width:100%; max-height:100%; display:block;" />
          </div>
        </div>

        <div style="flex:1; min-width:180px;">
          <div class="hint" id="upiMobileText">On mobile, tap to open your UPI app:</div>
          <button id="upiPayBtn" class="btn" style="margin-top:10px; padding:10px 18px;">Pay with UPI app</button>
          <div class="hint" id="upiNote" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button id="bookingReviewBtn" class="btn secondary">Leave a review</button>
      <button id="bookingCloseBtn" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Review modal -->
<div id="reviewModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Rate your experience</h3>
    <div class="hint">Share feedback with the restaurant (shown to vendor &amp; other users).</div>

    <label style="margin-top:12px;">Your name</label>
    <input id="reviewName" type="text" placeholder="Optional, e.g. Priti" />

    <label style="margin-top:10px;">Rating</label>
    <div id="starInput" class="star-input">
      <span data-value="1">â˜…</span>
      <span data-value="2">â˜…</span>
      <span data-value="3">â˜…</span>
      <span data-value="4">â˜…</span>
      <span data-value="5">â˜…</span>
    </div>

    <label style="margin-top:10px;">Comment</label>
    <textarea id="reviewComment" rows="3" placeholder="How was the food, service, ambience?"></textarea>

    <div class="error-text" id="reviewError" style="display:none;"></div>

    <div class="modal-actions">
      <button id="reviewCancelBtn" class="btn secondary">Cancel</button>
      <button id="reviewSubmitBtn" class="btn">Submit review</button>
    </div>
  </div>
</div>

<script>
  // ========= BASIC CONFIG =========
  const API_BASE = "http://127.0.0.1:5000";

  const params = new URLSearchParams(location.search);
  const vendorId = parseInt(params.get("vendor_id") || "", 10);

  const els = {
    loadingBar: document.getElementById("loadingBar"),
    vendorChip: document.getElementById("vendorInfoChip"),
    banner: document.getElementById("banner"),
    restName: document.getElementById("restName"),
    restAddress: document.getElementById("restAddress"),
    restCity: document.getElementById("restCity"),
    bannerBookingInfo: document.getElementById("bannerBookingInfo"),
    bannerAdvanceInfo: document.getElementById("bannerAdvanceInfo"),
    liveStatus: document.getElementById("liveStatus"),
    bookingCard: document.getElementById("bookingCard"),
    bookingHint: document.getElementById("bookingHint"),

    custName: document.getElementById("custName"),
    custPhone: document.getElementById("custPhone"),
    dateInput: document.getElementById("dateInput"),
    dateHint: document.getElementById("dateHint"),
    slotSelect: document.getElementById("slotSelect"),
    typeSelect: document.getElementById("typeSelect"),
    tableCountInput: document.getElementById("tableCountInput"),
    freeCountHint: document.getElementById("freeCountHint"),
    tablesGrid: document.getElementById("tablesGrid"),
    priceLine: document.getElementById("priceLine"),
    formError: document.getElementById("formError"),

    confirmBtn: document.getElementById("confirmBtn"),
    resetBtn: document.getElementById("resetBtn"),
    summaryConfirmBtn: document.getElementById("summaryConfirmBtn"),

    sumMain: document.getElementById("sumMain"),
    sumTotal: document.getElementById("sumTotal"),
    sumCust: document.getElementById("sumCust"),
    sumDateTime: document.getElementById("sumDateTime"),
    sumTables: document.getElementById("sumTables"),

    upiBox: document.getElementById("upiBox"),
    upiHint: document.getElementById("upiHint"),
    upiValue: document.getElementById("upiValue"),

    avgRating: document.getElementById("avgRating"),
    ratingCountHint: document.getElementById("ratingCountHint"),
    reviewList: document.getElementById("reviewList"),
    openReviewBtn: document.getElementById("openReviewBtn"),

    bookingModalBackdrop: document.getElementById("bookingModalBackdrop"),
    bookingSummaryText: document.getElementById("bookingSummaryText"),
    bookingCloseBtn: document.getElementById("bookingCloseBtn"),
    bookingReviewBtn: document.getElementById("bookingReviewBtn"),
    upiQrImg: document.getElementById("upiQrImg"),
    upiPaymentBlock: document.getElementById("upiPaymentBlock"),
    upiPayBtn: document.getElementById("upiPayBtn"),
    upiNote: document.getElementById("upiNote"),

    reviewModalBackdrop: document.getElementById("reviewModalBackdrop"),
    reviewName: document.getElementById("reviewName"),
    starInput: document.getElementById("starInput"),
    reviewComment: document.getElementById("reviewComment"),
    reviewError: document.getElementById("reviewError"),

    reviewCancelBtn: document.getElementById("reviewCancelBtn"),
    reviewSubmitBtn: document.getElementById("reviewSubmitBtn"),
  };

  let settings = { maxAdvanceDays: 30, cancelBeforeHrs: 2 };
  let slots = [];
  let types = [];
  let upiId = null;
  let selectedStars = 0;
  let lastBooking = null;
  let isBookingSubmitting = false;

  function disableBookingUIForMissingVendor() {
    els.vendorChip.textContent = "Restaurant not selected";
    els.liveStatus.textContent = "Select restaurant";
    els.liveStatus.style.background = "#fff0f0";
    els.liveStatus.style.color = "var(--red)";
    els.bookingHint.textContent = "Restaurant is not selected. Please open this page from a restaurant card with vendor_id in the URL.";
    els.tablesGrid.innerHTML = '<div class="empty">Restaurant not selected.</div>';
    els.priceLine.textContent = "â‚¹0";

    const formInputs = [
      els.custName, els.custPhone, els.dateInput,
      els.slotSelect, els.typeSelect, els.tableCountInput,
      els.confirmBtn, els.summaryConfirmBtn, els.resetBtn
    ];
    formInputs.forEach(el => { if (el) el.disabled = true; });

    els.banner.style.backgroundImage =
      'linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.7)), url("https://source.unsplash.com/1400x600/?restaurant,food")';
    els.restName.textContent = "Select a restaurant";
    els.restAddress.textContent = "No restaurant selected";
    els.restCity.textContent = "";
    els.loadingBar.style.display = "none";
  }

  console.log("VendorId loaded from URL:", vendorId);

  // ========= SMALL HELPERS =========
  function showError(msg) {
    els.formError.style.display = "block";
    els.formError.textContent = msg;
  }
  function clearError() {
    els.formError.style.display = "none";
    els.formError.textContent = "";
  }
  function formatTime24To12(t) {
    if (!t) return "";
    const [hh, mm] = t.split(":").map(Number);
    const period = hh >= 12 ? "PM" : "AM";
    let h12 = hh % 12;
    if (h12 === 0) h12 = 12;
    return `${h12}:${String(mm).padStart(2, "0")} ${period}`;
  }
  function formatDatePretty(str) {
    if (!str) return "-";
    const d = new Date(str + "T00:00:00");
    if (isNaN(d)) return str;
    return d.toLocaleDateString(undefined, { day: "numeric", month: "short", year: "numeric" });
  }
  function todayIso() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }
  function setLoading(on) {
    els.loadingBar.style.display = on ? "block" : "none";
  }
  function clampDateToToday() {
    const minStr = els.dateInput.min || todayIso();
    if (els.dateInput.value && els.dateInput.value < minStr) {
      els.dateInput.value = minStr;
    }
  }

  function buildUpiUri(amount, bookingId) {
    if (!upiId) return null;
    const pa = encodeURIComponent(upiId);
    const pn = encodeURIComponent(els.restName.textContent || "Restaurant");
    const am = amount.toFixed(2);
    const cu = "INR";
    const tn = encodeURIComponent(`Table booking #${bookingId}`);
    return `upi://pay?pa=${pa}&pn=${pn}&am=${am}&cu=${cu}&tn=${tn}`;
  }

  function buildQrUrl(upiUri) {
    if (!upiUri) return "";
    return "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(upiUri);
  }

  // ========= LOAD INITIAL DATA =========
  async function loadVendorAndSettings() {
    setLoading(true);
    try {
      const res = await fetch(`${API_BASE}/api/rest/vendor/me?vendor_id=${vendorId}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Failed to load vendor");

      const v = data.vendor;
      // settings from vendor dashboard
      settings.maxAdvanceDays = Math.min(data.settings?.maxAdvanceDays || 365, 30);
      settings.cancelBeforeHrs = data.settings?.cancelBeforeHrs || 2;

      els.vendorChip.textContent = `${v.restaurant_name} â€¢ ${v.city || ""}`.trim();
      els.restName.textContent = v.restaurant_name || "Restaurant";

      const loc = data.location || {};
      els.restAddress.textContent = loc.addr1 || v.address || "Address not set";
      const cityLine = [loc.city, loc.state, loc.pincode].filter(Boolean).join(", ");
      els.restCity.textContent = cityLine || "City not set";

      if (data.banner) {
        els.banner.style.backgroundImage =
          `linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.7)), url("${data.banner}")`;
      } else {
        els.banner.style.backgroundImage =
          `linear-gradient(180deg,rgba(0,0,0,0.3),rgba(0,0,0,0.7)), url("https://source.unsplash.com/1400x600/?restaurant,food")`;
      }

      els.bannerBookingInfo.textContent = `${data.stats?.upcomingBookings || 0} upcoming bookings â€¢ Live`;
      els.bannerAdvanceInfo.textContent = `Advance up to ${settings.maxAdvanceDays} days`;

      // UPI ID saved by vendor dashboard
      try {
        const resU = await fetch(`${API_BASE}/api/vendors/${vendorId}`);
        const dU = await resU.json();
        if (dU.success && dU.vendor) {
          upiId = dU.vendor.upi_id || null;
        }
      } catch (e) {
        console.warn("UPI load error", e);
      }

      if (upiId) {
        els.upiHint.textContent = "Pay directly to this UPI after placing order:";
        els.upiValue.textContent = upiId;
      } else {
        els.upiHint.textContent = "Vendor has not set a UPI ID yet.";
        els.upiValue.textContent = "";
      }

      // Date range
      const minStr = todayIso();
      const max = new Date();
      max.setDate(max.getDate() + settings.maxAdvanceDays);
      const maxStr = max.toISOString().slice(0, 10);

      els.dateInput.min = minStr;
      els.dateInput.max = maxStr;
      els.dateInput.value = minStr;
      els.dateHint.textContent = `You can book any date up to ${formatDatePretty(maxStr)}.`;

      els.liveStatus.textContent = "Live";
      els.liveStatus.style.background = "#eaffea";
      els.liveStatus.style.color = "var(--green)";
    } catch (e) {
      console.error(e);
      els.vendorChip.textContent = "Error loading restaurant";
      els.liveStatus.textContent = "Error";
      els.liveStatus.style.background = "#fff0f0";
      els.liveStatus.style.color = "var(--red)";
    } finally {
      setLoading(false);
    }
  }

  async function loadSlots() {
    try {
      const res = await fetch(`${API_BASE}/api/rest/slots?vendor_id=${vendorId}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Failed to load slots");
      slots = data.slots || [];
      els.slotSelect.innerHTML = "";
      if (!slots.length) {
        els.slotSelect.innerHTML = `<option value="">No slots configured</option>`;
      } else {
        for (const s of slots) {
          const label = `${s.name} (${formatTime24To12(s.start)} - ${formatTime24To12(s.end)})`;
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = label;
          els.slotSelect.appendChild(opt);
        }
      }
    } catch (e) {
      console.error(e);
      els.slotSelect.innerHTML = `<option value="">Error loading slots</option>`;
    }
  }

  async function loadTypes() {
    try {
      const res = await fetch(`${API_BASE}/api/rest/types?vendor_id=${vendorId}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Failed to load table types");
      types = data.types || [];
      els.typeSelect.innerHTML = "";
      if (!types.length) {
        els.typeSelect.innerHTML = `<option value="">No table types configured</option>`;
      } else {
        for (const t of types) {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = `${t.name} â€¢ â‚¹${t.price} / table`;
          els.typeSelect.appendChild(opt);
        }
      }
    } catch (e) {
      console.error(e);
      els.typeSelect.innerHTML = `<option value="">Error loading table types</option>`;
    }
  }

  // tables per date & slot
  async function loadTablesForSelectedType() {
    const typeId = els.typeSelect.value;
    const dateStr = els.dateInput.value;
    const slotId = els.slotSelect.value;

    if (!typeId) {
      els.tablesGrid.innerHTML = `<div class="empty">Select a table type to view tables.</div>`;
      els.freeCountHint.textContent = "â€”";
      return;
    }

    if (!dateStr || !slotId) {
      els.tablesGrid.innerHTML = `<div class="empty">Pick a date and time slot to see live table status.</div>`;
      els.freeCountHint.textContent = "â€”";
      return;
    }

    try {
      let url = `${API_BASE}/api/rest/types/${typeId}/tables?vendor_id=${vendorId}` +
                `&date=${encodeURIComponent(dateStr)}&slot_id=${encodeURIComponent(slotId)}`;

      const res = await fetch(url);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Failed to load tables");

      const tables = data.tables || [];

      els.tablesGrid.innerHTML = "";
      if (!tables.length) {
        els.tablesGrid.innerHTML = `<div class="empty">No tables created for this type.</div>`;
      } else {
        let freeCount = 0;
        let reservedCount = 0;
        let unavailCount = 0;

        for (const tb of tables) {
          const div = document.createElement("div");
          div.className = "table-chip";

          let tagClass = "tag-unavail";
          let tagText = "Unavailable";

          if (tb.status === "free") {
            freeCount++;
            tagClass = "tag-free";
            tagText = "Free";
          } else if (tb.status === "reserved") {
            reservedCount++;
            tagClass = "tag-reserved";
            tagText = "Reserved";
          } else {
            unavailCount++;
          }

          div.innerHTML = `
            <div class="table-chip-title">Table ${tb.num}</div>
            <div class="hint">Status: <span class="tag ${tagClass}">${tagText}</span></div>
          `;
          els.tablesGrid.appendChild(div);
        }

        els.freeCountHint.textContent =
          `${freeCount} free â€¢ ${reservedCount} reserved â€¢ ${unavailCount} unavailable`;

        els.tableCountInput.max = freeCount || 1;
        let current = parseInt(els.tableCountInput.value || "1", 10);
        if (freeCount === 0) {
          els.tableCountInput.value = "0";
        } else if (current > freeCount) {
          els.tableCountInput.value = String(freeCount);
        }
      }
    } catch (e) {
      console.error(e);
      els.tablesGrid.innerHTML = `<div class="empty">Error loading tables.</div>`;
      els.freeCountHint.textContent = "â€”";
    }
    updateSummaryUI();
  }

  // ========= SUMMARY & PRICE =========
  function updateSummaryUI() {
    clearError();
    if (!vendorId) return; // if no vendor, nothing to compute

    clampDateToToday();

    const typeId = els.typeSelect.value;
    const type = types.find(t => String(t.id) === String(typeId));
    const count = parseInt(els.tableCountInput.value || "0", 10);
    const pricePer = type ? Number(type.price || 0) : 0;
    const total = Math.max(0, pricePer * Math.max(0, count));

    els.priceLine.textContent = `â‚¹${pricePer} Ã— ${count} table(s) = â‚¹${total}`;
    els.sumTotal.textContent = `â‚¹${total}`;

    const name = els.custName.value.trim() || "Guest";
    const phone = els.custPhone.value.trim();
    els.sumCust.textContent = phone ? `${name} â€¢ ${phone}` : name;

    const dateStr = els.dateInput.value || "-";
    const slotObj = slots.find(s => String(s.id) === String(els.slotSelect.value));
    const slotLabel = slotObj
      ? `${slotObj.name} (${formatTime24To12(slotObj.start)} â€“ ${formatTime24To12(slotObj.end)})`
      : "-";
    els.sumDateTime.textContent = `${formatDatePretty(dateStr)} â€¢ ${slotLabel}`;

    els.sumTables.textContent = count > 0
      ? `${count} Ã— ${(type && type.name) || "Table"}`
      : "â€”";

    els.sumMain.textContent = total > 0
      ? `${formatDatePretty(dateStr)} â€¢ ${count} table(s) â€¢ ${(type && type.name) || ""}`
      : "No selection yet";

    const disabled = !type || !els.slotSelect.value || !dateStr || total <= 0;
    els.confirmBtn.disabled = disabled;
    els.summaryConfirmBtn.disabled = disabled;
  }

  // ========= BOOKING FLOW =========
  async function submitBooking() {
    if (!vendorId) return;
    if (isBookingSubmitting) return;
    isBookingSubmitting = true;

    clearError();
    clampDateToToday();

    const name = els.custName.value.trim();
    const phone = els.custPhone.value.trim();
    const dateStr = els.dateInput.value;
    const slotId = els.slotSelect.value;
    const typeId = els.typeSelect.value;
    let count = parseInt(els.tableCountInput.value || "0", 10);

    if (!name) { isBookingSubmitting = false; return showError("Please enter your name."); }
    if (!/^\d{10}$/.test(phone)) { isBookingSubmitting = false; return showError("Please enter a valid 10-digit phone number."); }
    if (!dateStr) { isBookingSubmitting = false; return showError("Please choose a date."); }
    if (dateStr < els.dateInput.min) { isBookingSubmitting = false; return showError("You cannot book for a past date."); }
    if (!slotId) { isBookingSubmitting = false; return showError("Please choose a slot."); }
    if (!typeId) { isBookingSubmitting = false; return showError("Please choose a table type."); }
    if (count <= 0) { isBookingSubmitting = false; return showError("Please enter how many tables to book."); }

    const freeText = els.freeCountHint.textContent || "";
    const m = freeText.match(/^(\d+)\s+free/);
    const freeCount = m ? parseInt(m[1], 10) : 0;
    if (freeCount === 0) { isBookingSubmitting = false; return showError("No free tables left for this type and slot."); }
    if (count > freeCount) {
      count = freeCount;
      els.tableCountInput.value = String(count);
    }

    const type = types.find(t => String(t.id) === String(typeId));
    const slotObj = slots.find(s => String(s.id) === String(slotId));
    const pricePer = type ? Number(type.price || 0) : 0;
    const totalPrice = pricePer * count;

    els.confirmBtn.disabled = true;
    els.summaryConfirmBtn.disabled = true;
    els.confirmBtn.textContent = "Creating bookingâ€¦";
    els.summaryConfirmBtn.textContent = "Creatingâ€¦";

    try {
      const body = {
        typeId: Number(typeId),
        slotId: Number(slotId),
        date: dateStr,
        customer: name,
        phone: phone,
        count: count
      };
      const res = await fetch(`${API_BASE}/api/rest/bookings?vendor_id=${vendorId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || "Booking failed");

      const bookingId = data.id;
      lastBooking = {
        id: bookingId,
        vendorId,
        name,
        phone,
        date: dateStr,
        slotName: slotObj ? slotObj.name : "",
        count,
        total: totalPrice
      };

      try {
        const key = `tb_last_booking_vendor_${vendorId}`;
        localStorage.setItem(key, JSON.stringify(lastBooking));
      } catch(e) {}

      showBookingModal(lastBooking);

      await loadTablesForSelectedType();
    } catch (e) {
      console.error(e);
      showError(e.message || "Something went wrong while booking.");
    } finally {
      els.confirmBtn.disabled = false;
      els.summaryConfirmBtn.disabled = false;
      els.confirmBtn.textContent = "Confirm booking";
      els.summaryConfirmBtn.textContent = "Confirm & create booking";
      isBookingSubmitting = false;
    }
  }

  function showBookingModal(b) {
    const prettyDate = formatDatePretty(b.date);
    els.bookingSummaryText.textContent =
      `Booking ID: ${b.id} â€¢ ${prettyDate} â€¢ ${b.slotName || "Slot"} â€¢ ` +
      `${b.count} table(s) â€¢ â‚¹${b.total}`;

    const upiUri = buildUpiUri(b.total, b.id);

    if (upiUri && upiId) {
      els.upiPaymentBlock.style.display = "block";
      els.upiQrImg.src = buildQrUrl(upiUri);
      els.upiQrImg.alt = "UPI QR code";
      els.upiPayBtn.disabled = false;
      els.upiNote.textContent = `Amount: â‚¹${b.total.toFixed(0)} (pay directly to the restaurant UPI).`;
    } else {
      els.upiPaymentBlock.style.display = "none";
      els.upiQrImg.src = "";
      els.upiQrImg.alt = "UPI not configured";
      els.upiPayBtn.disabled = true;
      els.upiNote.textContent = "Restaurant has not configured a UPI ID yet.";
    }

    els.bookingModalBackdrop.style.display = "flex";
    els.bookingModalBackdrop.setAttribute("aria-hidden", "false");
  }

  function closeBookingModal() {
    els.bookingModalBackdrop.style.display = "none";
    els.bookingModalBackdrop.setAttribute("aria-hidden", "true");
  }

  // ========= REVIEWS =========
  async function loadReviews() {
    try {
      const res = await fetch(`${API_BASE}/rating/club/${vendorId}`);
      const data = await res.json();
      const avg = data.avg || 0;
      const count = data.count || 0;
      const items = data.items || [];

      els.avgRating.textContent = count ? avg.toFixed(1) : "â€“";
      els.ratingCountHint.textContent = count
        ? `${count} review${count === 1 ? "" : "s"}`
        : "No reviews yet";

      els.reviewList.innerHTML = "";
      if (!items.length) {
        els.reviewList.innerHTML = `<div class="empty">No reviews yet. Be the first to share your experience.</div>`;
      } else {
        for (const r of items) {
          const stars = "â˜…".repeat(r.stars || 0).padEnd(5, "â˜†");
          const div = document.createElement("div");
          div.className = "review-item";
          div.innerHTML = `
            <div class="review-name">${r.name || "Anonymous"}</div>
            <div class="review-meta">
              <span class="stars">${stars}</span>
            </div>
            <div>${r.comment || ""}</div>
          `;
          els.reviewList.appendChild(div);
        }
      }
    } catch (e) {
      console.error(e);
      els.reviewList.innerHTML = `<div class="empty">Error loading reviews.</div>`;
    }
  }

  function openReviewModal(prefillFromLast = false) {
    els.reviewError.style.display = "none";
    els.reviewError.textContent = "";
    if (prefillFromLast && lastBooking) {
      els.reviewName.value = lastBooking.name || "";
    } else {
      els.reviewName.value = "";
    }
    els.reviewComment.value = "";
    selectedStars = 0;
    updateStarUI();
    els.reviewModalBackdrop.style.display = "flex";
    els.reviewModalBackdrop.setAttribute("aria-hidden", "false");
  }

  function closeReviewModal() {
    els.reviewModalBackdrop.style.display = "none";
    els.reviewModalBackdrop.setAttribute("aria-hidden", "true");
  }

  function updateStarUI() {
    const stars = els.starInput.querySelectorAll("span");
    stars.forEach(st => {
      const val = parseInt(st.dataset.value, 10);
      st.style.color = val <= selectedStars ? "#f3c623" : "#d1d5db";
    });
  }

  async function submitReview() {
    els.reviewError.style.display = "none";
    els.reviewError.textContent = "";

    if (!selectedStars || selectedStars < 1) {
      els.reviewError.style.display = "block";
      els.reviewError.textContent = "Please choose a star rating.";
      return;
    }
    const name = els.reviewName.value.trim() || "Anonymous";
    const comment = els.reviewComment.value.trim();

    try {
      const body = {
        club_id: vendorId,
        stars: selectedStars,
        name,
        comment
      };
      const res = await fetch(`${API_BASE}/rating/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!data.ok && !data.success) throw new Error(data.message || "Failed to submit review");
      closeReviewModal();
      await loadReviews();
    } catch (e) {
      els.reviewError.style.display = "block";
      els.reviewError.textContent = e.message || "Could not submit review.";
    }
  }

  // ========= EVENT LISTENERS =========
  els.typeSelect.addEventListener("change", () => {
    loadTablesForSelectedType();
  });
  els.tableCountInput.addEventListener("input", () => {
    const val = parseInt(els.tableCountInput.value || "0", 10);
    if (isNaN(val) || val < 0) els.tableCountInput.value = "0";
    updateSummaryUI();
  });

  els.custName.addEventListener("input", updateSummaryUI);
  els.custPhone.addEventListener("input", updateSummaryUI);

  els.dateInput.addEventListener("change", () => {
    updateSummaryUI();
    loadTablesForSelectedType();
  });

  els.slotSelect.addEventListener("change", () => {
    updateSummaryUI();
    loadTablesForSelectedType();
  });

  els.confirmBtn.addEventListener("click", submitBooking);
  els.summaryConfirmBtn.addEventListener("click", submitBooking);

  els.resetBtn.addEventListener("click", () => {
    els.custName.value = "";
    els.custPhone.value = "";
    if (els.dateInput.min) {
      els.dateInput.value = els.dateInput.min;
    } else {
      els.dateInput.value = todayIso();
    }
    els.tableCountInput.value = "1";
    updateSummaryUI();
    loadTablesForSelectedType();
  });

  els.bookingCloseBtn.addEventListener("click", () => {
    closeBookingModal();
  });
  els.bookingReviewBtn.addEventListener("click", () => {
    closeBookingModal();
    openReviewModal(true);
  });

  els.openReviewBtn.addEventListener("click", () => openReviewModal(false));
  els.reviewCancelBtn.addEventListener("click", closeReviewModal);
  els.reviewSubmitBtn.addEventListener("click", submitReview);

  els.starInput.addEventListener("click", (e) => {
    const val = e.target.dataset.value;
    if (!val) return;
    selectedStars = parseInt(val, 10);
    updateStarUI();
  });

  // UPI app open (deep link)
  els.upiPayBtn.addEventListener("click", () => {
    if (!lastBooking || !upiId) return;
    const upiUri = buildUpiUri(lastBooking.total, lastBooking.id);
    if (!upiUri) return;
    try {
      window.location.href = upiUri;
    } catch (e) {
      console.warn("UPI deep link error", e);
      alert("If your UPI app did not open automatically, please scan the QR code.");
    }
  });

  // ========= INIT =========
  (async function init() {
    if (!vendorId) {
      disableBookingUIForMissingVendor();
      return;
    }

    setLoading(true);
    await loadVendorAndSettings();
    await Promise.all([loadSlots(), loadTypes()]);
    await loadTablesForSelectedType();
    await loadReviews();
    updateSummaryUI();
    setLoading(false);

    // restore last booking from localStorage (optional)
    try {
      const key = `tb_last_booking_vendor_${vendorId}`;
      const stored = localStorage.getItem(key);
      if (stored) {
        lastBooking = JSON.parse(stored);
      }
    } catch(e){}
  })();
</script>

</body>
</html>
