<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nightlife Order ‚Äî ZomaClone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", sans-serif;
      background:#050308;
      color:#f9fafb;
      margin:0;padding:0;
    }
    .wrapper{
      max-width:960px;margin:0 auto;padding:20px;
    }
    h1,h2{margin:8px 0;}
    .club-card{
      background:#0b0b12;
      padding:16px 18px;
      border-radius:12px;
      border:1px solid #1f2937;
      display:flex;gap:16px;
      margin-bottom:18px;
    }
    .club-card img{
      width:140px;height:90px;object-fit:cover;border-radius:10px;
    }
    .badge{font-size:12px;color:#9ca3af;margin-top:4px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;}
    th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:left;}
    th{color:#9ca3af;font-size:12px;text-transform:uppercase;letter-spacing:.06em;}
    input[type="number"]{
      width:60px;padding:4px 6px;border-radius:6px;border:1px solid #374151;
      background:#020617;color:#f9fafb;
    }
    input[type="text"]{
      padding:6px 10px;border-radius:8px;border:1px solid #374151;
      background:#020617;color:#f9fafb;
      width:100%;max-width:260px;
    }
    .btn{
      border:none;border-radius:999px;padding:9px 20px;margin-top:10px;
      background:linear-gradient(90deg,#ff2e63,#ff6b3c);color:#fff;
      font-weight:600;font-size:14px;cursor:pointer;
      box-shadow:0 12px 25px rgba(255,46,99,.45);
    }
    .totals{margin-top:10px;font-size:15px;}
    .toast{
      position:fixed;top:16px;right:20px;
      padding:9px 16px;border-radius:999px;
      background:#0b1120;color:#e5e7eb;font-size:13px;
      border:1px solid rgba(148,163,184,.4);
      box-shadow:0 10px 30px rgba(0,0,0,.7);
      opacity:0;transform:translateY(-6px);
      transition:.25s;pointer-events:none;z-index:999;
    }
  </style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="wrapper">
  <h1>Club Nightlife Order</h1>
  <div id="clubBox"></div>

  <h2>Menu</h2>
  <table>
    <thead>
      <tr>
        <th>Item</th>
        <th>Category</th>
        <th>Price (‚Çπ)</th>
        <th>Qty</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <div style="margin-top:16px;">
    <label style="font-size:13px;color:#9ca3af;">Your Name</label><br>
    <input type="text" id="userNameInput" placeholder="Your name (optional)">
  </div>

  <div class="totals">
    Total: ‚Çπ<span id="totalAmount">0</span>
  </div>
  <button class="btn" id="placeOrderBtn">Place Order</button>
</div>

<script>
const API_URL = "http://127.0.0.1:5000";

const toastEl = document.getElementById("toast");
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.style.opacity = 1;
  toastEl.style.transform = "translateY(0)";
  setTimeout(()=>{
    toastEl.style.opacity = 0;
    toastEl.style.transform = "translateY(-6px)";
  },2000);
}

function getClubIdFromURL(){
  const params = new URLSearchParams(window.location.search);
  return params.get("club_id") || "1";
}
const CLUB_ID = getClubIdFromURL();

let CURRENT_CLUB = null;
let ITEMS = [];

function renderClub(){
  const box = document.getElementById("clubBox");
  if(!CURRENT_CLUB){
    box.innerHTML = "<p>Club not found.</p>";
    return;
  }
  const c = CURRENT_CLUB;
  box.innerHTML = `
    <div class="club-card">
      <img src="${c.image || c.main_image || ''}" onerror="this.style.display='none'">
      <div>
        <h2>${c.club_name}</h2>
        <div class="badge">üìç ${c.location || "Location not set"}</div>
        <div class="badge">üìû ${c.phone || "NA"} ‚Ä¢ üìß ${c.email || ""}</div>
        <div style="font-size:13px;margin-top:6px;">
          ${c.description || ""}
        </div>
      </div>
    </div>`;
}

function renderItems(){
  const tbody = document.getElementById("itemsBody");
  tbody.innerHTML = "";
  ITEMS.forEach(item=>{
    tbody.innerHTML += `
      <tr>
        <td>${item.item_name}</td>
        <td>${item.category || "-"}</td>
        <td>‚Çπ${item.price}</td>
        <td>
          <input type="number" min="0" value="0" data-item-id="${item.id}" class="qty-input">
        </td>
      </tr>
    `;
  });
  document.querySelectorAll(".qty-input").forEach(inp=>{
    inp.addEventListener("input", recalcTotal);
  });
}

function recalcTotal(){
  let total = 0;
  document.querySelectorAll(".qty-input").forEach(inp=>{
    const qty = Number(inp.value || 0);
    if(qty <= 0) return;
    const id = Number(inp.getAttribute("data-item-id"));
    const item = ITEMS.find(i=>i.id === id);
    if(item){
      total += qty * Number(item.price || 0);
    }
  });
  document.getElementById("totalAmount").textContent = total.toFixed(2);
}

document.getElementById("placeOrderBtn").addEventListener("click", async ()=>{
  let total = 0;
  const orderItems = [];
  document.querySelectorAll(".qty-input").forEach(inp=>{
    const qty = Number(inp.value || 0);
    if(qty <= 0) return;
    const id = Number(inp.getAttribute("data-item-id"));
    const item = ITEMS.find(i=>i.id === id);
    if(item){
      total += qty * Number(item.price || 0);
      orderItems.push({
        id: item.id,
        name: item.item_name,
        qty: qty,
        price: item.price
      });
    }
  });

  if(orderItems.length === 0){
    showToast("Select at least one item");
    return;
  }

  const user_name = document.getElementById("userNameInput").value.trim() || "Guest";

  try{
    const res = await fetch(`${API_URL}/api/club/${CLUB_ID}/order`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        user_name,
        items: orderItems,
        total
      })
    });
    const data = await res.json();
    if(data.success){
      showToast("Order placed!");
      document.querySelectorAll(".qty-input").forEach(inp=> inp.value = 0);
      recalcTotal();
    }else{
      showToast(data.message || "Failed to place order");
    }
  }catch(e){
    console.error(e);
    showToast("Error placing order");
  }
});

(async function boot(){
  try{
    const res = await fetch(`${API_URL}/api/club/${CLUB_ID}/detail`);
    if(!res.ok){
      showToast("Club not found");
      return;
    }
    const data = await res.json();
    CURRENT_CLUB = data.club;
    ITEMS = data.items || [];
    renderClub();
    renderItems();
    recalcTotal();
  }catch(e){
    console.error(e);
    showToast("Error loading club");
  }
})();
</script>
</body>
</html>
