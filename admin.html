<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZomaClone — Admin </title>
<link rel="icon" type="image/png" sizes="512x512" href="Images/logo_512.png">


<style>
  :root{
    --card-radius:12px;
    --accent:#E23744;
    --accent-2:#c92a36;
    --muted:#6b7280;
    --glass-blur:8px;
    --shadow:0 8px 30px rgba(2,6,23,0.12);
    --success:#10b981;
    --bg-day: #fff7f6;
    --bg-night: #3a1b20;
  }
  /* Day theme defaults */
  :root{
    --bg: var(--bg-day);
    --surface: #ffffff;
    --text: #111827;
    --muted-text: #6b7280;
    --input-bg: #ffffff;
    --input-border: #eef2f6;
    --chip-bg: #fff5f5;
    --metric-bg: linear-gradient(180deg, rgba(226,55,68,0.06), rgba(226,55,68,0.02));
  }
  /* Night theme*/
  body.theme-dark{
    --bg: var(--bg-night);
    --surface: rgba(255,255,255,0.04);
    --text: #f3eef0;
    --muted-text: #cfc7c9;
    --input-bg: rgba(255,255,255,0.02);
    --input-border: rgba(255,255,255,0.04);
    --chip-bg: rgba(255,255,255,0.02);
    --metric-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;padding:22px;}
  .container{max-width:1180px;margin:0 auto;display:grid;grid-template-columns:1fr 420px;gap:18px}
  @media(max-width:980px){ .container{grid-template-columns:1fr;padding:12px} }

  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  h1{margin:0;font-size:18px}
  .small{font-size:13px;color:var(--muted-text)}

  .card{background:var(--surface);border-radius:var(--card-radius);padding:14px;border:1px solid rgba(0,0,0,0.03);box-shadow:var(--shadow)}
  .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
  @media(max-width:980px){ .metrics{grid-template-columns:repeat(2,1fr);} }
  .metric{padding:12px;border-radius:10px;background:var(--metric-bg);border:1px solid rgba(0,0,0,0.03)}
  .metric .num{font-weight:700;font-size:18px}
  .metric .lbl{font-size:12px;color:var(--muted-text);margin-top:6px}

  .left{display:flex;flex-direction:column;gap:14px}
  .right{display:flex;flex-direction:column;gap:14px}
  .table-wrap{overflow:auto;max-height:320px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px;text-align:left;border-bottom:1px dashed rgba(0,0,0,0.04)}
  th{font-weight:600;color:var(--muted-text)}

  label{display:block;font-size:13px;color:var(--muted-text);margin-bottom:6px}
  input[type="text"], input[type="email"], input[type="number"], select, input[type="date"]{
    width:100%;padding:9px;border-radius:8px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);margin-bottom:10px;
  }
  .row{display:flex;gap:10px}
  .col{flex:1}
  button.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#fff;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}
  .chip{display:inline-block;padding:6px 8px;border-radius:999px;background:var(--chip-bg);font-size:12px;color:var(--muted-text)}
  .muted{color:var(--muted-text);font-size:13px}
  .tiny{font-size:12px;color:var(--muted-text)}

  .toggle {width:60px;height:34px;background:var(--input-bg);border-radius:999px;position:relative;border:1px solid var(--input-border);cursor:pointer;display:flex;align-items:center;padding:4px}
  .toggle .knob{width:26px;height:26px;border-radius:50%;background:#fff;transition:transform .22s}
  body.theme-dark .toggle{background:rgba(255,255,255,0.06)}
  body.theme-dark .toggle .knob{background:linear-gradient(90deg,var(--accent),var(--accent-2));}
  .toggle[data-on="1"] .knob{transform:translateX(26px)}

  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .test-box{background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);padding:12px;border-radius:8px}
  .result-line{display:flex;justify-content:space-between;margin:6px 0;font-size:14px}
  .btn-sm{padding:6px 8px;border-radius:6px;font-size:13px}
  .danger{background:#ff4d4f;color:#fff;border:none}
  .ok{background:var(--success);color:#fff;border:none}

  
  .sticky-footer {
    position: fixed;
    left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02));
    backdrop-filter: blur(6px);
    display:flex;align-items:center;justify-content:center;padding:12px 18px;z-index:2000;
  }
  .sticky-inner {max-width:1180px;width:100%;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .sticky-card {background:var(--surface);padding:10px 14px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);display:flex;gap:14px;align-items:center;box-shadow:0 8px 30px rgba(2,6,23,0.08);width:100%}
  .sticky-left {display:flex;flex-direction:column}
  .sticky-right {display:flex;gap:10px;align-items:center}
  .place-btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700;cursor:pointer}
  .place-btn:disabled{opacity:0.6;cursor:not-allowed}
  .small-muted{font-size:12px;color:var(--muted-text)}
  @media(max-width:700px){ .sticky-inner{padding:0 8px} .sticky-card{flex-direction:column;align-items:stretch} .sticky-right{justify-content:space-between} }
  .logo img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 10px;
}
.logo{
  width: 50px;
  height: 50px;
  border-radius: 50%;      /* makes it round */
  background: #f2f4f7;     /* light background like your screenshot */
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;        /* crops extra image */
  border: 1px solid #d9dce1;
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">
  <img src="Images/Modern Monogram C Logo.png" alt="Logo">
</div>

    <div>
      <h1>ZomaClone — Admin</h1>
      <div class="small">Live cart updates • Admin-only fee controls • Sticky live total</div>
    </div>
  </div>

  <div style="display:flex;gap:12px;align-items:center">
    <div class="small muted">Theme</div>
    <div id="themeToggle" class="toggle" role="switch" tabindex="0" aria-checked="false" title="Toggle theme" data-on="0"><div class="knob"></div></div>
  </div>
</header>

<main class="container">
  
  <section class="left">

    
    <div class="card">
      <div class="metrics">
        <div class="metric"><div class="num" id="m_vendors">0</div><div class="lbl">Vendors</div></div>
        <div class="metric"><div class="num" id="m_categories">0</div><div class="lbl">Categories</div></div>
        <div class="metric"><div class="num" id="m_orders">0</div><div class="lbl">Orders</div></div>
        <div class="metric"><div class="num" id="m_platformRevenue">₹0</div><div class="lbl">Platform Rev (user fees)</div></div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>Admin Dashboard</strong>
          <div class="tiny muted">Categories, veg/non-veg fees, vendors, and live orders</div>
        </div>
        <div style="min-width:220px">
          <div style="display:flex;gap:8px">
            <input id="searchVendor" placeholder="Search vendor or email" style="padding:8px;border-radius:8px;background:var(--input-bg);border:1px solid var(--input-border);" />
            <button class="btn" id="refreshBtn">Refresh</button>
          </div>
        </div>
      </div>
    </div>

    
    <div class="card" id="categoriesCard">
      <div class="section-title">
        <strong>Categories</strong>
        <div class="tiny">Add/Edit/Delete categories</div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="new_cat_name" placeholder="New category e.g. Biriyani" />
        <input id="new_cat_user" placeholder="User fee %" type="number" style="width:110px" />
        <input id="new_cat_vendor" placeholder="Vendor fee %" type="number" style="width:120px" />
        <button class="btn" id="addCategoryBtn">Add</button>
      </div>

      <div class="table-wrap" id="categoriesTableWrap"></div>
    </div>

  
    <div class="card" id="vendorListCard">
      <div class="section-title"><strong>Vendors (Live)</strong><div class="tiny">All vendors — auto-updates</div></div>
      <div id="vendorListWrap" class="table-wrap"></div>
    </div>

    
    <div class="card">
      <div class="section-title"><strong>Orders (history)</strong><div class="tiny">Placed orders (live analytics update)</div></div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="filterVendorOrders" placeholder="Filter by vendor email" />
        <button class="ghost" id="clearOrdersBtn">Clear Orders</button>
      </div>
      <div id="ordersWrap" style="max-height:260px;overflow:auto"></div>
    </div>
  </section>

  
  <aside class="right">

    
    <div class="card">
      <div class="section-title"><strong>Vendors</strong><div class="tiny">Create vendor and manage menu</div></div>
      <label>Restaurant Name</label>
      <input id="v_name" placeholder="Urban Bites" />
      <label>Vendor Email</label>
      <input id="v_email" type="email" placeholder="vendor@example.com" />
      <div class="row">
        <div class="col">
          <label>Default Delivery (₹)</label>
          <input id="v_delivery" type="number" placeholder="leave blank to use admin default" />
        </div>
        <div class="col">
          <label>Default Packaging (₹)</label>
          <input id="v_pack" type="number" />
        </div>
      </div>
      <label>Optional vendor fee (flat for display) ₹</label>
      <input id="v_fee" type="number" placeholder="0" />
      <label>Password (demo auth)</label>
      <input id="v_pwd" type="text" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="addVendorBtn">Create Vendor</button>
        <button class="ghost" id="seedDataBtn">Seed Demo</button>
      </div>
      <div style="margin-top:10px">
        <strong>Manage Menu (select vendor)</strong>
        <select id="menuVendorSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--input-border);margin-top:8px"></select>
        <div id="menuEditor" style="margin-top:8px;display:none">
          <label>Dish name</label><input id="dish_name" placeholder="Chicken Biryani" />
          <div class="row">
            <div class="col"><label>Price (₹)</label><input id="dish_price" type="number" /></div>
            <div class="col"><label>Category</label><select id="dish_cat"></select></div>
          </div>
          <label>Type</label>
          <select id="dish_type"><option value="veg">Veg</option><option value="nonveg">Non-Veg</option></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" id="addDishBtn">Add Dish</button>
            <button class="ghost" id="clearMenuSelection">Clear</button>
          </div>
          <div id="vendorMenuWrap" style="margin-top:10px;max-height:160px;overflow:auto"></div>
        </div>
      </div>
    </div>

    
    <div class="card">
      <div class="section-title"><strong>Veg / Non-Veg Fees</strong><div class="tiny">Additional fees — admin must click Save</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Veg - User Fee (%)</label>
          <input id="veg_user" type="number" value="2" />
          <label>Veg - Vendor Fee (%)</label>
          <input id="veg_vendor" type="number" value="1" />
        </div>
        <div>
          <label>Non-Veg - User Fee (%)</label>
          <input id="nonveg_user" type="number" value="4" />
          <label>Non-Veg - Vendor Fee (%)</label>
          <input id="nonveg_vendor" type="number" value="3" />
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="saveVegFeesBtn">Save Fees</button>
        <button class="ghost" id="resetVegFeesBtn">Reset Defaults</button>
      </div>
    </div>

    
    <div class="card">
      <div class="section-title"><strong>Cart Builder (LIVE)</strong><div class="tiny">Cart updates automatically — totals shown in sticky footer</div></div>

      <label>Choose Vendor (for order)</label>
      <select id="orderVendorSelect" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--input-border)"></select>

      <div style="display:grid;grid-template-columns:1fr 100px;gap:8px;margin-top:8px">
        <input id="cart_item_name" placeholder="Item name" />
        <input id="cart_item_price" type="number" placeholder="₹ price" />
      </div>
      <div style="display:grid;grid-template-columns:1fr 120px;gap:8px;margin-top:8px">
        <select id="cart_item_cat"></select>
        <select id="cart_item_type"><option value="veg">Veg</option><option value="nonveg">Non-Veg</option></select>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="cart_item_qty" type="number" placeholder="Qty" style="width:110px" value="1" />
        <button class="btn" id="addToCartBtn">Add to Cart</button>
        <button class="ghost" id="clearCartBtn">Clear Cart</button>
      </div>

      <div id="cartWrap" style="margin-top:12px;max-height:200px;overflow:auto"></div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="order_coupon" placeholder="Coupon code (optional)" />
      </div>

      <div id="orderResult" class="test-box" style="display:none;margin-top:10px"></div>
    </div>

    
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Platform Settings</strong><div class="tiny">GST & defaults</div></div>
      <label>GST (%)</label><input id="admin_gst" type="number" value="5" />
      <label>Default Delivery (₹)</label><input id="admin_delivery" type="number" value="29" />
      <label>Default Packaging (₹)</label><input id="admin_pack" type="number" value="8" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="saveSettingsBtn">Save</button>
        <button class="ghost" id="resetSettingsBtn">Reset</button>
      </div>
    </div>

  </aside>
</main>

<div class="sticky-footer" id="stickyFooter" style="display:none">
  <div class="sticky-inner">
    <div class="sticky-card">
      <div class="sticky-left">
        <div style="display:flex;gap:12px;align-items:center">
          <div>
            <div class="small-muted">Live Total</div>
            <div style="font-weight:800;font-size:18px" id="liveTotal">₹0.00</div>
          </div>
          <div>
            <div class="small-muted">User Fees</div>
            <div id="liveUserFees">₹0.00</div>
          </div>
          <div>
            <div class="small-muted">Vendor Fees</div>
            <div id="liveVendorFees">₹0.00</div>
          </div>
        </div>
        <div style="margin-top:6px" class="small-muted" id="liveSummary">Items: 0 • GST: ₹0.00 • Delivery: ₹0.00</div>
      </div>
      <div class="sticky-right">
        <button class="place-btn" id="stickyPlaceOrder">Place Order</button>
        <button class="ghost" id="stickyClearCart">Clear Cart</button>
      </div>
    </div>
  </div>
</div>

<footer style="margin-top:14px;text-align:center;color:var(--muted-text)">Thank You </footer>

<script>

const LS = {
  get: (k, fallback=null) => { try { const v=localStorage.getItem(k); return v?JSON.parse(v):fallback; } catch(e){ return fallback; } },
  set: (k,v)=> localStorage.setItem(k, JSON.stringify(v)),
  remove: (k)=> localStorage.removeItem(k)
};
const uid = ()=> Math.random().toString(36).slice(2,9);
const nowISO = ()=> new Date().toISOString();

const KEY = {
  ADMIN:'admin_settings_v3',
  VENDORS:'vendorList_v3',
  CATEGORIES:'platform_categories_v3',
  VEGFEES:'vegfees_v3',
  COUPONS:'admin_coupons_v3',
  ORDERS:'orders_v3',
  THEME:'admin_theme_v3'
};
const DEFAULT_ADMIN = { gst:5, delivery:29, packaging:8 };

(function migrateOldVendors(){
  const oldV = LS.get('vendorList');
  const newV = LS.get(KEY.VENDORS);
  if(newV.length === 0 && Array.isArray(oldV) && oldV.length > 0){
    console.log('Migrating old vendors → vendorList_v3');
    LS.set(KEY.VENDORS, oldV);
  }

  const oldCats = LS.get('platform_categories');
  const newCats = LS.get(KEY.CATEGORIES);
  if(newCats.length === 0 && Array.isArray(oldCats) && oldCats.length > 0){
    console.log('Migrating old categories → platform_categories_v3');
    LS.set(KEY.CATEGORIES, oldCats);
  }
})();



if(!LS.get(KEY.ADMIN)) LS.set(KEY.ADMIN, DEFAULT_ADMIN);
if(!LS.get(KEY.VENDORS)) LS.set(KEY.VENDORS, []);
if(!LS.get(KEY.CATEGORIES)) {
  LS.set(KEY.CATEGORIES, [
    { id:uid(), name:'Indian', userFee:10, vendorFee:8 },
    { id:uid(), name:'Chinese', userFee:12, vendorFee:10 },
    { id:uid(), name:'Biriyani', userFee:10, vendorFee:8 },
    { id:uid(), name:'Snacks', userFee:8, vendorFee:6 },
    { id:uid(), name:'Alcohol', userFee:15, vendorFee:12 },
    { id:uid(), name:'Desserts', userFee:6, vendorFee:4 }
  ]);
}
if(!LS.get(KEY.VEGFEES)) LS.set(KEY.VEGFEES, { vegUser:2, vegVendor:1, nonvegUser:4, nonvegVendor:3 });
if(!LS.get(KEY.COUPONS)) LS.set(KEY.COUPONS, []);
if(!LS.get(KEY.ORDERS)) LS.set(KEY.ORDERS, []);


const el = id => document.getElementById(id);

const themeToggle = el('themeToggle');
function applyTheme(theme){ if(theme==='dark') document.body.classList.add('theme-dark'); else document.body.classList.remove('theme-dark'); themeToggle.setAttribute('data-on', theme==='dark'?'1':'0'); LS.set(KEY.THEME, theme); }
(function initTheme(){ const t = LS.get(KEY.THEME) || 'light'; applyTheme(t); }());
themeToggle.addEventListener('click', ()=> applyTheme(document.body.classList.contains('theme-dark') ? 'light' : 'dark') );


function computeMetrics(){
  const vendors = LS.get(KEY.VENDORS, []);
  const categories = LS.get(KEY.CATEGORIES, []);
  const orders = LS.get(KEY.ORDERS, []);
  const platformRevenue = orders.reduce((s,o)=> s + Number(o.userPlatformTotal||0), 0);
  el('m_vendors').textContent = vendors.length;
  el('m_categories').textContent = categories.length;
  el('m_orders').textContent = orders.length;
  el('m_platformRevenue').textContent = '₹' + platformRevenue.toFixed(2);
}

/* -------------------------
   Category management
   ------------------------- */
function renderCategories(){
  const cats = LS.get(KEY.CATEGORIES, []);
  const wrap = el('categoriesTableWrap');
  if(!cats.length){ wrap.innerHTML = '<div class="muted">No categories.</div>'; return; }
  let html = '<table><thead><tr><th>Category</th><th>User Fee %</th><th>Vendor Fee %</th><th>Actions</th></tr></thead><tbody>';
  cats.forEach(c=>{
    html += `<tr>
      <td>${escape(c.name)}</td>
      <td>${Number(c.userFee).toFixed(2)}%</td>
      <td>${Number(c.vendorFee).toFixed(2)}%</td>
      <td><button class="ghost btn-sm" onclick="editCategory('${c.id}')">Edit</button> <button class="ghost btn-sm" onclick="deleteCategory('${c.id}')">Delete</button></td>
    </tr>`;
  });
  html += '</tbody></table>'; wrap.innerHTML = html;
}
function escape(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

el('addCategoryBtn').addEventListener('click', ()=>{
  const name = (el('new_cat_name').value||'').trim();
  const userFee = Number(el('new_cat_user').value||0);
  const vendorFee = Number(el('new_cat_vendor').value||0);
  if(!name) return alert('Enter category name');
  const cats = LS.get(KEY.CATEGORIES, []);
  if(cats.some(c=>c.name.toLowerCase()===name.toLowerCase())) return alert('Category exists');
  cats.push({ id: uid(), name, userFee, vendorFee });
  LS.set(KEY.CATEGORIES, cats);
  el('new_cat_name').value=''; el('new_cat_user').value=''; el('new_cat_vendor').value='';
  renderCategories(); populateCategorySelects(); computeMetrics(); updateLiveFooter();
});
window.editCategory = (id)=>{
  const cats = LS.get(KEY.CATEGORIES, []);
  const idx = cats.findIndex(c=>c.id===id); if(idx===-1) return;
  const c = cats[idx];
  const newName = prompt('Category name:', c.name); if(newName===null) return;
  const newUser = prompt('User fee %:', c.userFee); if(newUser===null) return;
  const newVendor = prompt('Vendor fee %:', c.vendorFee); if(newVendor===null) return;
  c.name = newName; c.userFee = Number(newUser||0); c.vendorFee = Number(newVendor||0);
  cats[idx]=c; LS.set(KEY.CATEGORIES, cats);
  renderCategories(); populateCategorySelects(); computeMetrics(); updateLiveFooter();
};
window.deleteCategory = (id)=>{
  if(!confirm('Delete category? Dishes using it will remain but need reassignment.')) return;
  let cats = LS.get(KEY.CATEGORIES, []); cats = cats.filter(c=>c.id!==id); LS.set(KEY.CATEGORIES, cats);
  renderCategories(); populateCategorySelects(); computeMetrics(); updateLiveFooter();
};

/* -------------------------
   Veg/Non-Veg fees (admin save)
   ------------------------- */
function loadVegFeesToUI(){ const v = LS.get(KEY.VEGFEES, {vegUser:2,vegVendor:1,nonvegUser:4,nonvegVendor:3}); el('veg_user').value = v.vegUser; el('veg_vendor').value = v.vegVendor; el('nonveg_user').value = v.nonvegUser; el('nonveg_vendor').value = v.nonvegVendor; }
loadVegFeesToUI();
el('saveVegFeesBtn').addEventListener('click', ()=>{
  const v = { vegUser: Number(el('veg_user').value||0), vegVendor: Number(el('veg_vendor').value||0), nonvegUser: Number(el('nonveg_user').value||0), nonvegVendor: Number(el('nonveg_vendor').value||0) };
  LS.set(KEY.VEGFEES, v);
  alert('Veg/Non-Veg fees saved (will apply to new calculations).');
  computeMetrics(); updateLiveFooter();
});
el('resetVegFeesBtn').addEventListener('click', ()=>{ if(!confirm('Reset veg/non-veg fees?')) return; LS.set(KEY.VEGFEES, {vegUser:2,vegVendor:1,nonvegUser:4,nonvegVendor:3}); loadVegFeesToUI(); updateLiveFooter(); });

/* -------------------------
   Vendors & Menu management
   ------------------------- */
function renderVendorOptions(){
  const vendors = LS.get(KEY.VENDORS, []);
  const sel1 = el('menuVendorSelect'); const sel2 = el('orderVendorSelect');
  sel1.innerHTML = '<option value="">Select vendor</option>'; sel2.innerHTML = '<option value="">Select vendor</option>';
  vendors.forEach(v => { const o = `<option value="${v.email}">${escape(v.restaurantName)} — ${escape(v.email)}</option>`; sel1.innerHTML += o; sel2.innerHTML += o; });
  renderVendorList(); // update vendor list card live
}
function renderVendorList(){
  const wrap = el('vendorListWrap'); const vendors = LS.get(KEY.VENDORS, []);
  if(!vendors.length){ wrap.innerHTML = '<div class="muted">No vendors yet.</div>'; return; }
  let html = '<table><thead><tr><th>Restaurant</th><th>Email</th><th>Delivery</th><th>Packaging</th><th>Actions</th></tr></thead><tbody>';
  vendors.forEach((v,i)=>{
    html += `<tr>
      <td>${escape(v.restaurantName)}</td>
      <td>${escape(v.email)}</td>
      <td>${v.vendorDelivery !== undefined ? '₹' + Number(v.vendorDelivery).toFixed(2) : '—'}</td>
      <td>${v.vendorPackaging !== undefined ? '₹' + Number(v.vendorPackaging).toFixed(2) : '—'}</td>
      <td><button class="ghost btn-sm" onclick="viewVendor(${i})">View</button> <button class="ghost btn-sm" onclick="manageVendorMenu(${i})">Menu</button> <button class="ghost btn-sm" onclick="deleteVendor(${i})">Delete</button></td>
    </tr>`;
  });
  html += '</tbody></table>'; wrap.innerHTML = html;
}
el('addVendorBtn').addEventListener('click', ()=>{
  const name = (el('v_name').value||'').trim(); const email = (el('v_email').value||'').trim().toLowerCase(); const delivery = el('v_delivery').value; const pack = el('v_pack').value; const fee = Number(el('v_fee').value||0); const pwd = (el('v_pwd').value||'').trim();
  if(!name||!email||!pwd) return alert('Fill name, email and password');
  let vendors = LS.get(KEY.VENDORS, []);
  if(vendors.some(v=>v.email===email)) return alert('Vendor exists');
  const vendor = { id:uid(), restaurantName:name, email, password:pwd, vendorDelivery: delivery?Number(delivery):undefined, vendorPackaging: pack?Number(pack):undefined, vendorFee: fee, dishes:[], createdAt: nowISO() };
  vendors.push(vendor); LS.set(KEY.VENDORS, vendors);
  el('v_name').value=''; el('v_email').value=''; el('v_delivery').value=''; el('v_pack').value=''; el('v_fee').value=''; el('v_pwd').value='';
  renderVendorOptions(); computeMetrics(); updateLiveFooter();
});
window.viewVendor = (index)=>{
  const vendors = LS.get(KEY.VENDORS, []); const v = vendors[index]; if(!v) return alert('Vendor not found');
  const orders = LS.get(KEY.ORDERS, []); const vendorOrders = orders.filter(o=> o.vendorEmails.includes(v.email)); const totalOrders = vendorOrders.length; const platformFromVendorOrders = vendorOrders.reduce((s,o)=> s + Number(o.userPlatformTotal||0), 0);
  let info = `Name: ${v.restaurantName}\nEmail: ${v.email}\nDelivery: ${v.vendorDelivery??'Admin default'}\nPackaging: ${v.vendorPackaging??'Admin default'}\nCreated: ${new Date(v.createdAt).toLocaleString()}\n\nOrders: ${totalOrders}\nPlatform revenue (from these orders): ₹${platformFromVendorOrders.toFixed(2)}\nDishes: ${v.dishes ? v.dishes.length : 0}\n`;
  alert(info);
};
window.manageVendorMenu = (i)=>{ const vendors = LS.get(KEY.VENDORS, []); const v = vendors[i]; if(!v) return; // set menu selector and open editor
  el('menuVendorSelect').value = v.email; renderVendorMenuEditor(); window.scrollTo({top:0,behavior:'smooth'}); };

/* delete vendor */
window.deleteVendor = (index)=>{ if(!confirm('Delete vendor?')) return; let vendors = LS.get(KEY.VENDORS, []); const removed = vendors.splice(index,1)[0]; LS.set(KEY.VENDORS, vendors); LS.remove('vendorAuth_'+(removed?.email||'')); renderVendorOptions(); computeMetrics(); updateLiveFooter(); };

/* vendor menu editor */
el('menuVendorSelect').addEventListener('change', renderVendorMenuEditor);
function renderVendorMenuEditor(){
  const vendorEmail = el('menuVendorSelect').value; const wrap = el('vendorMenuWrap'); wrap.innerHTML=''; if(!vendorEmail){ el('menuEditor').style.display='none'; return; } el('menuEditor').style.display='block';
  const vendors = LS.get(KEY.VENDORS, []); const v = vendors.find(x=>x.email===vendorEmail);
  const cats = LS.get(KEY.CATEGORIES, []); const catSel = el('dish_cat'); catSel.innerHTML = '<option value="">Select category</option>'; cats.forEach(c=> catSel.innerHTML += `<option value="${c.id}">${escape(c.name)}</option>`);
  if(!(v && v.dishes && v.dishes.length)){ wrap.innerHTML = '<div class="muted">No dishes yet.</div>'; return; }
  let html = '<table><thead><tr><th>Dish</th><th>Category</th><th>Type</th><th>Price</th><th>Actions</th></tr></thead><tbody>';
  v.dishes.forEach(d => { const catName = (cats.find(c=>c.id===d.categoryId)||{}).name || '—'; html += `<tr><td>${escape(d.name)}</td><td>${escape(catName)}</td><td>${d.type}</td><td>₹${Number(d.price).toFixed(2)}</td><td><button class="ghost btn-sm" onclick="editDish('${v.email}','${d.id}')">Edit</button> <button class="ghost btn-sm" onclick="deleteDish('${v.email}','${d.id}')">Delete</button></td></tr>`; });
  html += '</tbody></table>'; wrap.innerHTML = html;
}
el('addDishBtn').addEventListener('click', ()=>{
  const vendorEmail = el('menuVendorSelect').value; if(!vendorEmail) return alert('Select vendor');
  const name = (el('dish_name').value||'').trim(); const price = Number(el('dish_price').value||0); const catId = el('dish_cat').value; const type = el('dish_type').value;
  if(!name||!price||!catId) return alert('Fill dish name, price and category');
  const vendors = LS.get(KEY.VENDORS, []); const idx = vendors.findIndex(v=>v.email===vendorEmail); if(idx===-1) return;
  const dish = { id: uid(), name, price:Number(price), categoryId:catId, type, createdAt: nowISO() };
  vendors[idx].dishes = vendors[idx].dishes || []; vendors[idx].dishes.push(dish); LS.set(KEY.VENDORS, vendors);
  el('dish_name').value=''; el('dish_price').value=''; el('dish_cat').value=''; el('dish_type').value='veg';
  renderVendorMenuEditor(); computeMetrics(); updateLiveFooter();
});
window.editDish = (vendorEmail, dishId)=>{
  const vendors = LS.get(KEY.VENDORS, []); const vIdx = vendors.findIndex(x=>x.email===vendorEmail); if(vIdx===-1) return; const dIdx = vendors[vIdx].dishes.findIndex(d=>d.id===dishId); if(dIdx===-1) return;
  const d = vendors[vIdx].dishes[dIdx];
  const newName = prompt('Dish name:', d.name); if(newName===null) return;
  const newPrice = prompt('Price (₹):', d.price); if(newPrice===null) return;
  const cats = LS.get(KEY.CATEGORIES, []); const newCat = prompt('Category name (exact):', (cats.find(c=>c.id===d.categoryId)||{}).name||''); const foundCat = cats.find(c=>c.name.toLowerCase() === (newCat||'').toLowerCase());
  if(!foundCat) return alert('Category not found. Cancelled.');
  const newType = prompt('Type: veg or nonveg', d.type) || d.type;
  d.name = newName; d.price = Number(newPrice||0); d.categoryId = foundCat.id; d.type = (newType==='nonveg'?'nonveg':'veg');
  vendors[vIdx].dishes[dIdx] = d; LS.set(KEY.VENDORS, vendors); renderVendorMenuEditor(); computeMetrics(); updateLiveFooter();
};
window.deleteDish = (vendorEmail, dishId)=>{ if(!confirm('Delete dish?')) return; const vendors = LS.get(KEY.VENDORS, []); const vIdx = vendors.findIndex(x=>x.email===vendorEmail); if(vIdx===-1) return; vendors[vIdx].dishes = vendors[vIdx].dishes.filter(d=>d.id!==dishId); LS.set(KEY.VENDORS, vendors); renderVendorMenuEditor(); computeMetrics(); updateLiveFooter(); };
el('clearMenuSelection').addEventListener('click', ()=> { el('menuVendorSelect').value=''; renderVendorMenuEditor(); });

/* -------------------------
   CART (LIVE) & Order logic
   ------------------------- */
let CART = []; // { id,name, price, qty, categoryId, type, vendorEmail }
function updateCartUI(){ const wrap = el('cartWrap'); if(!CART.length){ wrap.innerHTML = '<div class="muted">Cart empty</div>'; hideStickyFooter(); return; } let html = '<table><thead><tr><th>Item</th><th>Cat</th><th>Type</th><th>Qty</th><th>Price</th><th>Subtotal</th><th>Actions</th></tr></thead><tbody>'; const cats = LS.get(KEY.CATEGORIES, []);
  CART.forEach((it, idx)=>{ const catName = (cats.find(c=>c.id===it.categoryId)||{}).name||'—'; html += `<tr><td>${escape(it.name)}</td><td>${escape(catName)}</td><td>${it.type}</td><td><input style="width:60px;padding:6px;border-radius:6px;border:1px solid var(--input-border)" type="number" value="${it.qty}" onchange="changeQty(${idx}, this.value)" /></td><td>₹${Number(it.price).toFixed(2)}</td><td>₹${(it.price*it.qty).toFixed(2)}</td><td><button class="ghost btn-sm" onclick="removeCartItem(${idx})">Remove</button></td></tr>`; });
  html += '</tbody></table>'; wrap.innerHTML = html; showStickyFooter(); updateLiveFooter(); }
window.changeQty = (idx, val)=>{ const q = Number(val || 1); CART[idx].qty = q; updateCartUI(); };
window.removeCartItem = (idx)=>{ CART.splice(idx,1); updateCartUI(); };

/* add to cart */
el('addToCartBtn').addEventListener('click', ()=>{
  const vendorEmail = el('orderVendorSelect').value; if(!vendorEmail) return alert('Select vendor for order');
  const name = (el('cart_item_name').value||'').trim(); const price = Number(el('cart_item_price').value||0);
  const qty = Number(el('cart_item_qty').value||1); const catId = el('cart_item_cat').value; const type = el('cart_item_type').value;
  if(!name || !price || !catId) return alert('Fill item name, price, category');
  CART.push({ id: uid(), vendorEmail, name, price: Number(price), qty: Number(qty||1), categoryId: catId, type });
  el('cart_item_name').value=''; el('cart_item_price').value=''; el('cart_item_qty').value='1';
  updateCartUI();
});

/* clear cart */
el('clearCartBtn').addEventListener('click', ()=>{ CART = []; updateCartUI(); el('orderResult').style.display='none'; });
el('stickyClearCart').addEventListener('click', ()=>{ CART = []; updateCartUI(); el('orderResult').style.display='none'; });

/* calculate cart totals (used for live footer) */
function calculateCart(){
  if(!CART.length) return null;
  const admin = LS.get(KEY.ADMIN, DEFAULT_ADMIN);
  const vegfees = LS.get(KEY.VEGFEES);
  const coupons = LS.get(KEY.COUPONS);
  const couponCode = (el('order_coupon').value||'').trim().toUpperCase();
  const coupon = coupons.find(c=>c.code===couponCode) || null;

  let subtotal = 0, userPlatformTotal = 0, vendorPlatformTotal = 0, gstTotal = 0;
  const items = []; const cats = LS.get(KEY.CATEGORIES);
  CART.forEach(it=>{
    const itemSubtotal = it.price * it.qty; subtotal += itemSubtotal;
    const cat = cats.find(c=>c.id===it.categoryId) || { userFee:0, vendorFee:0 };
    const catUserPct = Number(cat.userFee||0), catVendorPct = Number(cat.vendorFee||0);
    const addUser = it.type==='veg' ? Number(vegfees.vegUser||0) : Number(vegfees.nonvegUser||0);
    const addVendor = it.type==='veg' ? Number(vegfees.vegVendor||0) : Number(vegfees.nonvegVendor||0);
    const itemUserFee = itemSubtotal * ((catUserPct + addUser)/100);
    const itemVendorFee = itemSubtotal * ((catVendorPct + addVendor)/100);
    userPlatformTotal += itemUserFee; vendorPlatformTotal += itemVendorFee;
    const gst = itemSubtotal * (Number(admin.gst||0)/100); gstTotal += gst;
    items.push(Object.assign({}, it, { itemSubtotal, itemUserFee, itemVendorFee, gst, catName:cat.name||'—', catUserPct, catVendorPct, addUser, addVendor }));
  });

  let couponAmt = 0; let couponApplied = null;
  if(coupon){
    let ok = true; if(coupon.expiry){ const ex = new Date(coupon.expiry + 'T23:59:59'); if(new Date() > ex) ok = false; }
    if(ok && subtotal >= (coupon.min||0)){ couponApplied = coupon; couponAmt = Number(coupon.amount||0); }
  }

  const vendorsInCart = Array.from(new Set(CART.map(i=>i.vendorEmail)));
  let delivery = Number(admin.delivery||0), packaging = Number(admin.packaging||0);
  if(vendorsInCart.length===1){
    const vendor = (LS.get(KEY.VENDORS) || []).find(v=>v.email === vendorsInCart[0]);
    if(vendor){
      if(typeof vendor.vendorDelivery !== 'undefined') delivery = Number(vendor.vendorDelivery||delivery);
      if(typeof vendor.vendorPackaging !== 'undefined') packaging = Number(vendor.vendorPackaging||packaging);
    }
  }

  const totalPayable = Math.max(0, subtotal + gstTotal + userPlatformTotal + delivery + packaging - couponAmt);
  const vendorPayout = subtotal - vendorPlatformTotal - gstTotal - (Number(admin.platform||0) || 0);

  return { items, subtotal, gstTotal, userPlatformTotal, vendorPlatformTotal, delivery, packaging, couponApplied, couponAmt, totalPayable, vendorPayout };
}

/* show sticky footer */
function showStickyFooter(){ el('stickyFooter').style.display = 'block'; }
function hideStickyFooter(){ el('stickyFooter').style.display = 'none'; }

/* update live footer with calculateCart results */
function updateLiveFooter(){
  const res = calculateCart();
  if(!res || !CART.length){ hideStickyFooter(); return; }
  showStickyFooter();
  el('liveTotal').textContent = '₹' + Number(res.totalPayable||0).toFixed(2);
  el('liveUserFees').textContent = '₹' + Number(res.userPlatformTotal||0).toFixed(2);
  el('liveVendorFees').textContent = '₹' + Number(res.vendorPlatformTotal||0).toFixed(2);
  el('liveSummary').textContent = `Items: ${res.items.length} • GST: ₹${Number(res.gstTotal||0).toFixed(2)} • Delivery: ₹${Number(res.delivery||0).toFixed(2)}`;
  // also show orderResult inline for clarity (live)
  showOrderResultBrief(res);
}

/* show brief order result (live) */
function showOrderResultBrief(res){
  const panel = el('orderResult'); panel.style.display = 'block';
  let html = `<div style="font-weight:700;margin-bottom:6px">Live breakdown</div>`;
  html += `<div class="result-line"><div>Subtotal</div><div>₹${res.subtotal.toFixed(2)}</div></div>`;
  html += `<div class="result-line"><div>Platform (user)</div><div>₹${res.userPlatformTotal.toFixed(2)}</div></div>`;
  html += `<div class="result-line"><div>Platform (vendor)</div><div>₹${res.vendorPlatformTotal.toFixed(2)}</div></div>`;
  html += `<div class="result-line"><div>GST</div><div>₹${res.gstTotal.toFixed(2)}</div></div>`;
  html += `<div class="result-line"><div>Delivery</div><div>₹${res.delivery.toFixed(2)}</div></div>`;
  html += `<div style="font-weight:800;margin-top:8px" class="result-line"><div>Final Payable</div><div>₹${res.totalPayable.toFixed(2)}</div></div>`;
  panel.innerHTML = html;
}

/* sticky place order */
el('stickyPlaceOrder').addEventListener('click', ()=> {
  if(!CART.length) return alert('Cart empty');
  const res = calculateCart(); if(!res) return alert('Cart empty');
  const orders = LS.get(KEY.ORDERS, []);
  const order = { id: uid(), createdAt: nowISO(), vendorEmails: Array.from(new Set(CART.map(i=>i.vendorEmail))), cart: CART.slice(), ...res };
  orders.push(order); LS.set(KEY.ORDERS, orders);
  // increment coupon uses
  if(res.couponApplied){ const coupons = LS.get(KEY.COUPONS); const idx = coupons.findIndex(c=>c.code===res.couponApplied.code); if(idx>-1){ coupons[idx].uses = (coupons[idx].uses||0)+1; LS.set(KEY.COUPONS, coupons); } }
  CART = []; updateCartUI(); el('orderResult').style.display='none'; renderOrders(el('filterVendorOrders').value); computeMetrics(); updateLiveFooter();
  alert('Order placed (simulated).');
});

/* -------------------------
   Orders render & management
   ------------------------- */
function renderOrders(filterVendor=''){
  const orders = LS.get(KEY.ORDERS, []).slice().reverse(); const wrap = el('ordersWrap');
  if(!orders.length){ wrap.innerHTML = '<div class="muted">No orders yet.</div>'; return; }
  let html = '<table><thead><tr><th>When</th><th>Vendors</th><th>Items</th><th>Platform (user)</th><th>Platform (vendor)</th><th>Total</th><th>Actions</th></tr></thead><tbody>';
  orders.forEach(o=>{
    if(filterVendor && !o.vendorEmails.join(',').toLowerCase().includes(filterVendor.toLowerCase())) return;
    html += `<tr>
      <td>${new Date(o.createdAt).toLocaleString()}</td>
      <td>${escape(o.vendorEmails.join(', '))}</td>
      <td>${o.cart.length}</td>
      <td>₹${Number(o.userPlatformTotal||0).toFixed(2)}</td>
      <td>₹${Number(o.vendorPlatformTotal||0).toFixed(2)}</td>
      <td>₹${Number(o.totalPayable||0).toFixed(2)}</td>
      <td><button class="ghost btn-sm" onclick="viewOrder('${o.id}')">View</button> <button class="ghost btn-sm" onclick="deleteOrder('${o.id}')">Delete</button></td>
    </tr>`;
  });
  html += '</tbody></table>'; wrap.innerHTML = html;
}
window.viewOrder = (id)=>{ const orders = LS.get(KEY.ORDERS, []); const o = orders.find(x=>x.id===id); if(!o) return; let text = `Order ${o.id}\nWhen: ${new Date(o.createdAt).toLocaleString()}\nVendors: ${o.vendorEmails.join(', ')}\n\nItems:\n`; o.cart.forEach(it=> text += `${it.qty}x ${it.name} (${it.type}) ₹${it.price} — cat:${it.categoryId}\n`); text += `\nSubtotal: ₹${Number(o.subtotal).toFixed(2)}\nUser Platform: ₹${Number(o.userPlatformTotal).toFixed(2)}\nVendor Platform: ₹${Number(o.vendorPlatformTotal).toFixed(2)}\nTotal: ₹${Number(o.totalPayable).toFixed(2)}\n`; alert(text); };
window.deleteOrder = (id)=>{ if(!confirm('Delete order?')) return; let orders = LS.get(KEY.ORDERS, []); orders = orders.filter(o=>o.id!==id); LS.set(KEY.ORDERS, orders); renderOrders(); computeMetrics(); updateLiveFooter(); };


function loadAdminToUI(){ const a = LS.get(KEY.ADMIN, DEFAULT_ADMIN); el('admin_gst').value = a.gst; el('admin_delivery').value = a.delivery; el('admin_pack').value = a.packaging; }
loadAdminToUI();
el('saveSettingsBtn').addEventListener('click', ()=>{ LS.set(KEY.ADMIN, { gst: Number(el('admin_gst').value||0), delivery: Number(el('admin_delivery').value||0), packaging: Number(el('admin_pack').value||0) }); alert('Saved'); computeMetrics(); updateLiveFooter(); });
el('resetSettingsBtn').addEventListener('click', ()=>{ if(!confirm('Reset defaults?')) return; LS.set(KEY.ADMIN, DEFAULT_ADMIN); loadAdminToUI(); updateLiveFooter(); });


el('searchVendor').addEventListener('input', ()=> { renderVendorList(); });
el('refreshBtn').addEventListener('click', ()=> { renderAll(); });
el('filterVendorOrders').addEventListener('input', (e)=> renderOrders(e.target.value));
el('clearOrdersBtn').addEventListener('click', ()=> { if(!confirm('Clear all orders?')) return; LS.set(KEY.ORDERS, []); renderOrders(); computeMetrics(); updateLiveFooter(); });


el('seedDataBtn').addEventListener('click', ()=> {
  if(!confirm('Seed demo data?')) return;
  LS.set(KEY.CATEGORIES, [
    { id:uid(), name:'Indian', userFee:10, vendorFee:8 },
    { id:uid(), name:'Chinese', userFee:12, vendorFee:10 },
    { id:uid(), name:'Biriyani', userFee:10, vendorFee:8 },
    { id:uid(), name:'Snacks', userFee:8, vendorFee:6 },
    { id:uid(), name:'Alcohol', userFee:15, vendorFee:12 },
    { id:uid(), name:'Desserts', userFee:6, vendorFee:4 }
  ]);
  LS.set(KEY.VEGFEES, { vegUser:2, vegVendor:1, nonvegUser:4, nonvegVendor:3 });
  LS.set(KEY.VENDORS, [
    { id:uid(), restaurantName:'Urban Bites', email:'urban@demo.com', password:'123', vendorDelivery:25, vendorPackaging:8, vendorFee:0, dishes:[
      { id:uid(), name:'Chicken Biryani', price:220, categoryId: LS.get(KEY.CATEGORIES)[2].id, type:'nonveg' },
      { id:uid(), name:'Paneer Butter Masala', price:180, categoryId: LS.get(KEY.CATEGORIES)[0].id, type:'veg' }
    ], createdAt:nowISO() },
    { id:uid(), restaurantName:'Pizza House', email:'pizza@demo.com', password:'123', vendorDelivery:40, vendorPackaging:12, vendorFee:0, dishes:[
      { id:uid(), name:'Margherita', price:350, categoryId: LS.get(KEY.CATEGORIES)[1].id, type:'veg' },
      { id:uid(), name:'Pepperoni', price:420, categoryId: LS.get(KEY.CATEGORIES)[1].id, type:'nonveg' }
    ], createdAt:nowISO() }
  ]);
  LS.set(KEY.ORDERS, []);
  renderAll(); alert('Demo seeded');
});


function populateCategorySelects(){
  const cats = LS.get(KEY.CATEGORIES, []);
  const catSel1 = el('dish_cat'); const catSel2 = el('cart_item_cat');
  catSel1.innerHTML = '<option value="">Select category</option>'; catSel2.innerHTML = '<option value="">Select category</option>';
  cats.forEach(c => { catSel1.innerHTML += `<option value="${c.id}">${escape(c.name)}</option>`; catSel2.innerHTML += `<option value="${c.id}">${escape(c.name)}</option>`; });
}
function populateVendorSelects(){ renderVendorOptions(); renderVendorMenuEditor(); }
function renderAll(){ renderCategories(); loadVegFeesToUI(); populateCategorySelects(); renderVendorOptions(); renderVendorMenuEditor(); updateCartUI(); renderOrders(); computeMetrics(); updateLiveFooter(); }
renderAll();


document.addEventListener('keydown', (e)=>{ if(e.key==='F5'){ e.preventDefault(); renderAll(); } });
</script>
</body>
</html>
